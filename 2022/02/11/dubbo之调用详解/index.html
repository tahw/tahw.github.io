<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"theme-next.js.org","root":"/","images":"/images","scheme":"Gemini","version":"8.6.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="dubbo之调用详解前言：分析的dubbo源码是2.7.7版本 入口代理类方法调用，走的是InvokerInvocationHandler.invoke方法 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465">
<meta property="og:type" content="article">
<meta property="og:title" content="dubbo之调用详解">
<meta property="og:url" content="https://theme-next.js.org/2022/02/11/dubbo%E4%B9%8B%E8%B0%83%E7%94%A8%E8%AF%A6%E8%A7%A3/index.html">
<meta property="og:site_name" content="天真有邪">
<meta property="og:description" content="dubbo之调用详解前言：分析的dubbo源码是2.7.7版本 入口代理类方法调用，走的是InvokerInvocationHandler.invoke方法 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://theme-next.js.org/images/dubbo-7-1.png">
<meta property="og:image" content="https://theme-next.js.org/images/dubbo-7-2.png">
<meta property="article:published_time" content="2022-02-11T09:08:33.000Z">
<meta property="article:modified_time" content="2022-02-16T14:25:04.950Z">
<meta property="article:author" content="李俊龙">
<meta property="article:tag" content="dubbo">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://theme-next.js.org/images/dubbo-7-1.png">


<link rel="canonical" href="https://theme-next.js.org/2022/02/11/dubbo%E4%B9%8B%E8%B0%83%E7%94%A8%E8%AF%A6%E8%A7%A3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://theme-next.js.org/2022/02/11/dubbo%E4%B9%8B%E8%B0%83%E7%94%A8%E8%AF%A6%E8%A7%A3/","path":"2022/02/11/dubbo之调用详解/","title":"dubbo之调用详解"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>dubbo之调用详解 | 天真有邪</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">天真有邪</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#dubbo%E4%B9%8B%E8%B0%83%E7%94%A8%E8%AF%A6%E8%A7%A3"><span class="nav-number">1.</span> <span class="nav-text">dubbo之调用详解</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%A5%E5%8F%A3"><span class="nav-number">2.</span> <span class="nav-text">入口</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8Invoker%E9%93%BE"><span class="nav-number">3.</span> <span class="nav-text">服务调用Invoker链</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8%E5%93%8D%E5%BA%94handler%E9%93%BE"><span class="nav-number">4.</span> <span class="nav-text">服务调用响应handler链</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2Handler%E9%93%BE"><span class="nav-number">5.</span> <span class="nav-text">服务暴露Handler链</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">6.</span> <span class="nav-text">整体流程图</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E7%AB%AF%E6%89%A7%E8%A1%8C%E9%80%BB%E8%BE%91"><span class="nav-number">7.</span> <span class="nav-text">服务消费端执行逻辑</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E8%B4%B9%E7%AB%AF%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-number">7.1.</span> <span class="nav-text">消费端异常处理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85%E6%89%A7%E8%A1%8C%E9%80%BB%E8%BE%91"><span class="nav-number">8.</span> <span class="nav-text">服务提供者执行逻辑</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-number">8.1.</span> <span class="nav-text">服务端异常处理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B"><span class="nav-number">9.</span> <span class="nav-text">线程模型</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">李俊龙</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">32</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://theme-next.js.org/2022/02/11/dubbo%E4%B9%8B%E8%B0%83%E7%94%A8%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李俊龙">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天真有邪">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          dubbo之调用详解
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-11 17:08:33" itemprop="dateCreated datePublished" datetime="2022-02-11T17:08:33+08:00">2022-02-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-02-16 22:25:04" itemprop="dateModified" datetime="2022-02-16T22:25:04+08:00">2022-02-16</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/dubbo/" itemprop="url" rel="index"><span itemprop="name">dubbo</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="dubbo之调用详解"><a href="#dubbo之调用详解" class="headerlink" title="dubbo之调用详解"></a>dubbo之调用详解</h1><p>前言：分析的dubbo源码是2.7.7版本</p>
<h1 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h1><p>代理类方法调用，走的是InvokerInvocationHandler.invoke方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * InvokerHandler</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(InvokerInvocationHandler.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Invoker&lt;?&gt; invoker;</span><br><span class="line">    <span class="keyword">private</span> ConsumerModel consumerModel;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InvokerInvocationHandler</span><span class="params">(Invoker&lt;?&gt; handler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.invoker = handler;</span><br><span class="line">        String serviceKey = invoker.getUrl().getServiceKey();</span><br><span class="line">        <span class="keyword">if</span> (serviceKey != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.consumerModel = ApplicationModel.getConsumerModel(serviceKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这里的Invoker就是</span></span><br><span class="line"><span class="comment">     * MockClusterInvoker -&gt;</span></span><br><span class="line"><span class="comment">     *   AbstractCluster$Interceptor</span></span><br><span class="line"><span class="comment">     *     FailoverClusterInvoker -&gt;</span></span><br><span class="line"><span class="comment">     *        RegistryDirectory -&gt;</span></span><br><span class="line"><span class="comment">     *          路由</span></span><br><span class="line"><span class="comment">     *          List&lt;RegistryDirectory$InvokerDelegate&gt;</span></span><br><span class="line"><span class="comment">     *          负载</span></span><br><span class="line"><span class="comment">     *               RegistryDirectory$InvokerDelegate</span></span><br><span class="line"><span class="comment">     *                  ListenerInvokerWrapper -&gt;</span></span><br><span class="line"><span class="comment">     *                     Invoker$0(ConsumerContextFilter)</span></span><br><span class="line"><span class="comment">     *                     Invoker$1(FutureFilter)</span></span><br><span class="line"><span class="comment">     *                     Invoker$2(MonitorFilter) -&gt;</span></span><br><span class="line"><span class="comment">     *                         AsyncToSyncInvoker -&gt;</span></span><br><span class="line"><span class="comment">     *                          DubboInvoker</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> proxy</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> method</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Throwable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (method.getDeclaringClass() == Object.class) &#123;</span><br><span class="line">            <span class="keyword">return</span> method.invoke(invoker, args);</span><br><span class="line">        &#125;</span><br><span class="line">        String methodName = method.getName();</span><br><span class="line">        Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</span><br><span class="line">        <span class="keyword">if</span> (parameterTypes.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;toString&quot;</span>.equals(methodName)) &#123;</span><br><span class="line">                <span class="keyword">return</span> invoker.toString();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;$destroy&quot;</span>.equals(methodName)) &#123;</span><br><span class="line">                invoker.destroy();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;hashCode&quot;</span>.equals(methodName)) &#123;</span><br><span class="line">                <span class="keyword">return</span> invoker.hashCode();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parameterTypes.length == <span class="number">1</span> &amp;&amp; <span class="string">&quot;equals&quot;</span>.equals(methodName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> invoker.equals(args[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        RpcInvocation rpcInvocation = <span class="keyword">new</span> RpcInvocation(method, invoker.getInterface().getName(), args);</span><br><span class="line">        String serviceKey = invoker.getUrl().getServiceKey();</span><br><span class="line">        rpcInvocation.setTargetServiceUniqueName(serviceKey);</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">if</span> (consumerModel != <span class="keyword">null</span>) &#123;</span><br><span class="line">            rpcInvocation.put(Constants.CONSUMER_MODEL, consumerModel);</span><br><span class="line">            rpcInvocation.put(Constants.METHOD_MODEL, consumerModel.getMethodModel(method));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> invoker.invoke(rpcInvocation).recreate(); <span class="comment">// 构造成RpcInvocation</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>

<h1 id="服务调用Invoker链"><a href="#服务调用Invoker链" class="headerlink" title="服务调用Invoker链"></a>服务调用Invoker链</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">MockClusterInvoker -&gt;</span><br><span class="line">    AbstractCluster$Interceptor</span><br><span class="line">        FailoverClusterInvoker -&gt;</span><br><span class="line">            RegistryDirectory -&gt;</span><br><span class="line">                路由</span><br><span class="line">                List&lt;RegistryDirectory$InvokerDelegate&gt;</span><br><span class="line">                负载</span><br><span class="line">                    RegistryDirectory$InvokerDelegate</span><br><span class="line">                        ListenerInvokerWrapper -&gt;</span><br><span class="line">                            ProtocolFilterWrapper$Invoker(Invoker$<span class="number">0</span>(ConsumerContextFilter) -&gt; Invoker$<span class="number">1</span>(FutureFilter) -&gt; Invoker$<span class="number">2</span>(MonitorFilter)) -&gt;</span><br><span class="line">                                AsyncToSyncInvoker -&gt;</span><br><span class="line">                                    DubboInvoker（调用client） -&gt; </span><br><span class="line">                                        ReferenceCountExchangeClient</span><br><span class="line">                                            -&gt; HeaderExchangeClinet</span><br><span class="line">                                                -&gt; NettyClient</span><br></pre></td></tr></table></figure>
<h1 id="服务调用响应handler链"><a href="#服务调用响应handler链" class="headerlink" title="服务调用响应handler链"></a>服务调用响应handler链</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NettyClientHandler -&gt; </span><br><span class="line">    NettyClient -&gt; </span><br><span class="line">        MultiMessageHandler -&gt; </span><br><span class="line">            HeartbeatHandler -&gt; </span><br><span class="line">                AllChannelHandler -&gt; </span><br><span class="line">                    DecodeHandler -&gt; </span><br><span class="line">                        HeaderExchangeHandler</span><br><span class="line">                            -&gt; DefaultFuture</span><br></pre></td></tr></table></figure>
<h1 id="服务暴露Handler链"><a href="#服务暴露Handler链" class="headerlink" title="服务暴露Handler链"></a>服务暴露Handler链</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">NettyServerHandler-&gt;</span><br><span class="line">    NettyServer-&gt;</span><br><span class="line">        MultiMessageHandler-&gt;</span><br><span class="line">            HeartbeatHandler-&gt;</span><br><span class="line">                AllChannelHandler-&gt;</span><br><span class="line">                    DecodeHandler-&gt;</span><br><span class="line">                        HeaderExchangeHandler-&gt;</span><br><span class="line">                            ExchangeHandlerAdapter</span><br><span class="line">                                (调用真正的Invoker.invoke)</span><br><span class="line">                                ProtocolFilterWrapper$Invoker(EchoFilter -&gt; ClassLoaderFilter -&gt; GenericFilter -&gt; ContextFilter -&gt; TraceFilter -&gt; TimeoutFilter -&gt; MonitorFilter -&gt; ExceptionFilter)-&gt;</span><br><span class="line">                                    RegistryProtocol$InvokerDelegate-&gt;</span><br><span class="line">                                        DelegateProviderMetaDataInvoker-&gt;</span><br><span class="line">                                            AbstractProxyInvoker -&gt;</span><br><span class="line">                                                执行真正的业务方法</span><br></pre></td></tr></table></figure>
<h1 id="整体流程图"><a href="#整体流程图" class="headerlink" title="整体流程图"></a>整体流程图</h1><p><img src="/images/dubbo-7-1.png" alt="整体流程图" loading="lazy"><br><b>ps：流程图很重要，建议下载仔细看</b></p>
<h1 id="服务消费端执行逻辑"><a href="#服务消费端执行逻辑" class="headerlink" title="服务消费端执行逻辑"></a>服务消费端执行逻辑</h1><ol>
<li>InvokerInvocationHandler判断如果是对象内部方法toString、$destroy、hashCode，直接处理返回，否则构造RpcInvocation对象，调用下一层</li>
<li>MockClusterInvoker：mock逻辑</li>
<li>AbstractCluster$Interceptor处理逻辑是AbstractClusterInvoker，这个类是把RpcContext中设置的attachments放入到RpcInvocation，调用服务目录路由链列举Invokers，根据Invokers获取负载均衡策略（多个Invokers选用第一个）</li>
<li>FailoverClusterInvoker.doInvoke()根据负载策略选出一个Invoker，然后执行，这里会有容错的逻辑，重试，默认执行3次，重试两次</li>
<li>RegistryDirectory$InvokerDelegate的父类InvokerWrapper调用invoke，这里没做什么</li>
<li>开始执行Filter链，当Filter执行完返回结果后，就会执行Result#whenCompleteWithContext</li>
<li>ConsumerContextFilter.invoke，设置RpcContext中LocalAddress、RemoteAddress、RemoteApplicationName、remote.application属性</li>
<li>FutureFilter.invoke</li>
<li>MonitorFilter.invoke，设置monitor_filter_start_time属性，方法的执行次数+1</li>
<li>ListenerInvokerWrapper.invoke没做什么</li>
<li><font color='red'><b>AsyncToSyncInvoker.invoke，异步转同步，先调用下层Invoker异步执行，如果是同步方法就会阻塞Integer.MAX_VALUE毫秒获取结果</b></font></li>
<li>AbstractInvoker.invoke：先调用DubboInvoker.doInvoke方法，如果出现异常，转换为AsyncRpcResult返回</li>
<li>DubboInvoker.doInvoke，从clients选择一个client进行发生数据，如果不用返回结果，则调用client.send，如果需要返回结果，则调用client.request，得到结果后，封装成AsyncRpcResult对象返回结果</li>
<li>这里调用的ReferenceCountExchangeClient.request，没有做什么，调用下一层</li>
<li>HeaderExchangeClient.request，这里没有做什么，调用下一层</li>
<li><font color='red'><b>HeaderExchangeChannel.request，这里构建Request，并且会构造一个DefaultFuture对象来返回，其中DefaultFuture会阻塞timeout（用户配置，默认1s）的时间来等待结果，DefaultFuture也是实现CompletableFuture，在构造DefaultFuture的时候，会把requestId和DefaultFuture放进去FUTURES map里，当提供者返回结果，就会调用HeaderExchangeHandler.handleResponse的方法，这时候会调用DefaultFuture.received方法，根据FUTURES map来获取DefaultFuture，然后执行DefaultFuture.doReceived方法，返回Response</b></font></li>
<li>AbstractPeer.send方法，没有做什么</li>
<li>AbstractClient.send</li>
<li>调用NettyChannel.send方法，调用NioSocketChannel.writeAndFlush方法，最底层是Netty非阻塞式发送数据</li>
</ol>
<h2 id="消费端异常处理"><a href="#消费端异常处理" class="headerlink" title="消费端异常处理"></a>消费端异常处理</h2><p>我们知道服务提供者如果出现异常，其实是包装成AppResponse正常信息返回，那消费者需要抛出这个异常信息，那这块是在哪里做的？在InvokerInvocationHandler.invoke返回值的recreate方法，这个最终会调用到AppResponse#recreate，里面包含异常信息就throw抛出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// AsyncRpcResult.recreate -&gt; AppResponse.recreate</span></span><br><span class="line">        <span class="keyword">return</span> invoker.invoke(rpcInvocation).recreate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppResponse</span> <span class="keyword">implements</span> <span class="title">Result</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">recreate</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (exception != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// fix issue#619</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// get Throwable class</span></span><br><span class="line">                Class clazz = exception.getClass();</span><br><span class="line">                <span class="keyword">while</span> (!clazz.getName().equals(Throwable.class.getName())) &#123;</span><br><span class="line">                    clazz = clazz.getSuperclass();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// get stackTrace value</span></span><br><span class="line">                Field stackTraceField = clazz.getDeclaredField(<span class="string">&quot;stackTrace&quot;</span>);</span><br><span class="line">                stackTraceField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                Object stackTrace = stackTraceField.get(exception);</span><br><span class="line">                <span class="keyword">if</span> (stackTrace == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    exception.setStackTrace(<span class="keyword">new</span> StackTraceElement[<span class="number">0</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> exception;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ps:这里在说明一点，是什么样的错误dubbo才会容错呢？如果是业务异常，正常抛出，也不会mock，也不会容错，如果是系统的异常RpcException（超时异常、系统异常）则会mock容错</p>
<h1 id="服务提供者执行逻辑"><a href="#服务提供者执行逻辑" class="headerlink" title="服务提供者执行逻辑"></a>服务提供者执行逻辑</h1><ol>
<li>NettyServerHandler.channelRead读取数据，交给下一层</li>
<li>AbstractPeer.received没有做什么，直接调用下一层</li>
<li>MultiMessageHandler.received，判断msg是MultiMessageHandler，如果是的话获取单个message，调用下一层</li>
<li>HeartbeatHandler.received，判断msg是心跳请求，是的话返回response，如果是心跳响应，不做什么，最后则调用下一层</li>
<li>AllChannelHandler.received，把msg构建成ChannelEventRunnable，放到线程池里面，然后在ChannelEventRunnable里的run方法调用下一层</li>
<li>DecodeHandler.received，反编译，设置RpcInvocation methodName、parameterTypes、arguments、attachments等属性，然后调用下一层</li>
<li><font color='red'><b>HeaderExchangeHandlerHeaderExchangeHandler.handleRequest方法，先构建Response对象，调用下层的ExchangeHandlerAdapter.reply方法返回CompletionStage对象，CompletionStage是CompletableFuture父类，然后CompletionStage.whenComplete方法绑定回调函数，当ExchangeHandlerAdapter.reply返回结果，就会设置Response对象，然后返回到消费者</b></font></li>
<li>ExchangeHandlerAdapter.reply，从exporter获取Invoker，然后执行Invoker.invoke</li>
<li>这里的就会执行ProtocolFilterWrapper$Invoker的Filter链，当Filter执行完返回结果后，就会执行Result#whenCompleteWithContext</li>
<li>EchoFilter.invoke，判断当前请求是不是一个回声测试，如果是，则不后续调用了，否则调用下一层</li>
<li>ClassLoaderFilter.invoke，设置设置当前线程类加载器为执行的服务接口的类加载器，调用下一层</li>
<li>GenericFilter.invoke，把泛化信息包装成RpcInvocation对象，调用下一层</li>
<li>ContextFilter.invoke，设置RpcContext里面context属性，调用下一层</li>
<li>TraceFilter.invoke，先执行下一层，然后记录信息</li>
<li>TimeoutFilter.invoke，设置invocation的timeout_filter_start_time值，调用下一层，但是当后面内容调用完成后，会回调TimeoutFilter.onResponse方法，里面有验证超时，但是只是打印了warn日志</li>
<li>MonitorFilter.invoke，设置monitor_filter_start_time属性，方法的执行次数+1</li>
<li>ExceptionFilter.invoke，没有做什么，直接调用下一层，但是后面执行完成，会回调ExceptionFilter.onResponse方法，对不同的异常做处理</li>
<li>InvokerWrapper.invoke 没有做什么，调用下一层</li>
<li>AbstractProxyInvoker.invoke，没有做什么，直接调用下一层</li>
<li><font color='red'><b>AbstractProxyInvoker.invoke，先调用JavassistProxyFactory.getInvoker里面的wrapper.invokeMethod方法，调用真正的方法返回，包装成CompletableFuture，这里然后执行方法CompletableFuture.handle，等待CompletableFuture执行完再包装成AsyncRpcResult返回</b></font></li>
</ol>
<h2 id="服务端异常处理"><a href="#服务端异常处理" class="headerlink" title="服务端异常处理"></a>服务端异常处理</h2><p>ExceptionFilter是服务端过滤器，当结果返回后，会执行onResponse方法，此方法来判断异常信息</p>
<ol>
<li>异常信息是Exception，不用做处理</li>
<li>接口信息中定义异常信息，不用做处理</li>
<li>如果异常和接口方法的jar是一个，不用做处理</li>
<li>异常类名以java打头或者javax打头的，不用做处理</li>
<li>异常如果是RpcException，不用做处理</li>
<li>其他识别不了的直接转换成RuntimeException</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Licensed to the Apache Software Foundation (ASF) under one or more</span></span><br><span class="line"><span class="comment"> * contributor license agreements.  See the NOTICE file distributed with</span></span><br><span class="line"><span class="comment"> * this work for additional information regarding copyright ownership.</span></span><br><span class="line"><span class="comment"> * The ASF licenses this file to You under the Apache License, Version 2.0</span></span><br><span class="line"><span class="comment"> * (the &quot;License&quot;); you may not use this file except in compliance with</span></span><br><span class="line"><span class="comment"> * the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">package</span> org.apache.dubbo.rpc.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.constants.CommonConstants;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.extension.Activate;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.logger.Logger;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.logger.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.utils.ReflectUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.rpc.Filter;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.rpc.Invocation;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.rpc.Invoker;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.rpc.Result;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.rpc.RpcContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.rpc.RpcException;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.rpc.service.GenericService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ExceptionInvokerFilter</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Functions:</span></span><br><span class="line"><span class="comment"> * &lt;ol&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;unexpected exception will be logged in ERROR level on provider side. Unexpected exception are unchecked</span></span><br><span class="line"><span class="comment"> * exception not declared on the interface&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;Wrap the exception not introduced in API package into RuntimeException. Framework will serialize the outer exception but stringnize its cause in order to avoid of possible serialization problem on client side&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/ol&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Activate(group = CommonConstants.PROVIDER)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span>, <span class="title">Filter</span>.<span class="title">Listener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(ExceptionFilter.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> invoker.invoke(invocation);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异常处理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> appResponse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> invoker</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> invocation</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Result appResponse, Invoker&lt;?&gt; invoker, Invocation invocation)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (appResponse.hasException() &amp;&amp; GenericService.class != invoker.getInterface()) &#123; <span class="comment">// 存在异常</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Throwable exception = appResponse.getException();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// directly throw if it&#x27;s checked exception</span></span><br><span class="line">                <span class="keyword">if</span> (!(exception <span class="keyword">instanceof</span> RuntimeException) &amp;&amp; (exception <span class="keyword">instanceof</span> Exception)) &#123; <span class="comment">// java可以识别异常，可以直接返回</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// directly throw if the exception appears in the signature</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Method method = invoker.getInterface().getMethod(invocation.getMethodName(), invocation.getParameterTypes());</span><br><span class="line">                    Class&lt;?&gt;[] exceptionClassses = method.getExceptionTypes();</span><br><span class="line">                    <span class="keyword">for</span> (Class&lt;?&gt; exceptionClass : exceptionClassses) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (exception.getClass().equals(exceptionClass)) &#123; <span class="comment">// 接口方法定义异常信息直接返回</span></span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// for the exception not found in method&#x27;s signature, print ERROR message in server&#x27;s log.</span></span><br><span class="line">                logger.error(<span class="string">&quot;Got unchecked and undeclared exception which called by &quot;</span> + RpcContext.getContext().getRemoteHost() + <span class="string">&quot;. service: &quot;</span> + invoker.getInterface().getName() + <span class="string">&quot;, method: &quot;</span> + invocation.getMethodName() + <span class="string">&quot;, exception: &quot;</span> + exception.getClass().getName() + <span class="string">&quot;: &quot;</span> + exception.getMessage(), exception);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// directly throw if exception class and interface class are in the same jar file.</span></span><br><span class="line">                String serviceFile = ReflectUtils.getCodeBase(invoker.getInterface()); <span class="comment">// 接口方法的文件路径</span></span><br><span class="line">                String exceptionFile = ReflectUtils.getCodeBase(exception.getClass()); <span class="comment">// 异常的文件路径</span></span><br><span class="line">                <span class="keyword">if</span> (serviceFile == <span class="keyword">null</span> || exceptionFile == <span class="keyword">null</span> || serviceFile.equals(exceptionFile)) &#123; <span class="comment">// 异常的文件路径和接口方法路径相同</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// directly throw if it&#x27;s JDK exception</span></span><br><span class="line">                String className = exception.getClass().getName();</span><br><span class="line">                <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;java.&quot;</span>) || className.startsWith(<span class="string">&quot;javax.&quot;</span>)) &#123; <span class="comment">// jdk自带的</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// directly throw if it&#x27;s dubbo exception</span></span><br><span class="line">                <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> RpcException) &#123; <span class="comment">// dubbo自定义的异常</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// otherwise, wrap with RuntimeException and throw back to the client</span></span><br><span class="line">                appResponse.setException(<span class="keyword">new</span> RuntimeException(StringUtils.toString(exception))); <span class="comment">// 识别不了的异常转换成RuntimeException异常处理</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;Fail to ExceptionFilter when called by &quot;</span> + RpcContext.getContext().getRemoteHost() + <span class="string">&quot;. service: &quot;</span> + invoker.getInterface().getName() + <span class="string">&quot;, method: &quot;</span> + invocation.getMethodName() + <span class="string">&quot;, exception: &quot;</span> + e.getClass().getName() + <span class="string">&quot;: &quot;</span> + e.getMessage(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e, Invoker&lt;?&gt; invoker, Invocation invocation)</span> </span>&#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Got unchecked and undeclared exception which called by &quot;</span> + RpcContext.getContext().getRemoteHost() + <span class="string">&quot;. service: &quot;</span> + invoker.getInterface().getName() + <span class="string">&quot;, method: &quot;</span> + invocation.getMethodName() + <span class="string">&quot;, exception: &quot;</span> + e.getClass().getName() + <span class="string">&quot;: &quot;</span> + e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// For test purpose</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLogger</span><span class="params">(Logger logger)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="线程模型"><a href="#线程模型" class="headerlink" title="线程模型"></a>线程模型</h1><p><img src="/images/dubbo-7-2.png" alt="线程模型" loading="lazy"></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/dubbo/" rel="tag"># dubbo</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/02/04/dubbo%E4%B9%8B%E5%BC%95%E5%85%A5%E6%9C%8D%E5%8A%A1%E8%AF%A6%E8%A7%A3/" rel="prev" title="dubbo之引入服务详解">
                  <i class="fa fa-chevron-left"></i> dubbo之引入服务详解
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/02/20/mysql%E4%B9%8B%E7%B4%A2%E5%BC%95%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="next" title="mysql之索引底层数据结构">
                  mysql之索引底层数据结构 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李俊龙</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
