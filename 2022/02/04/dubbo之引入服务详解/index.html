<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"theme-next.js.org","root":"/","images":"/images","scheme":"Gemini","version":"8.6.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="dubbo之引入服务详解前言：分析的dubbo源码是2.7.7版本 入口流程图 123456789public synchronized T get() &amp;#123;    if (destroyed) &amp;#123;        throw new IllegalStateException(&quot;The invoker of ReferenceConfig(&quot; + url +">
<meta property="og:type" content="article">
<meta property="og:title" content="dubbo之引入服务详解">
<meta property="og:url" content="https://theme-next.js.org/2022/02/04/dubbo%E4%B9%8B%E5%BC%95%E5%85%A5%E6%9C%8D%E5%8A%A1%E8%AF%A6%E8%A7%A3/index.html">
<meta property="og:site_name" content="天真有邪">
<meta property="og:description" content="dubbo之引入服务详解前言：分析的dubbo源码是2.7.7版本 入口流程图 123456789public synchronized T get() &amp;#123;    if (destroyed) &amp;#123;        throw new IllegalStateException(&quot;The invoker of ReferenceConfig(&quot; + url +">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://theme-next.js.org/images/dubbo-6-1.png">
<meta property="og:image" content="https://theme-next.js.org/images/dubbo-6-2.png">
<meta property="og:image" content="https://theme-next.js.org/images/dubbo-6-3.png">
<meta property="og:image" content="https://theme-next.js.org/images/dubbo-6-3-1.png">
<meta property="og:image" content="https://theme-next.js.org/images/dubbo-6-4.png">
<meta property="article:published_time" content="2022-02-04T12:29:01.000Z">
<meta property="article:modified_time" content="2022-04-14T02:39:27.382Z">
<meta property="article:author" content="李俊龙">
<meta property="article:tag" content="dubbo">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://theme-next.js.org/images/dubbo-6-1.png">


<link rel="canonical" href="https://theme-next.js.org/2022/02/04/dubbo%E4%B9%8B%E5%BC%95%E5%85%A5%E6%9C%8D%E5%8A%A1%E8%AF%A6%E8%A7%A3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://theme-next.js.org/2022/02/04/dubbo%E4%B9%8B%E5%BC%95%E5%85%A5%E6%9C%8D%E5%8A%A1%E8%AF%A6%E8%A7%A3/","path":"2022/02/04/dubbo之引入服务详解/","title":"dubbo之引入服务详解"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>dubbo之引入服务详解 | 天真有邪</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">天真有邪</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#dubbo%E4%B9%8B%E5%BC%95%E5%85%A5%E6%9C%8D%E5%8A%A1%E8%AF%A6%E8%A7%A3"><span class="nav-number">1.</span> <span class="nav-text">dubbo之引入服务详解</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%A5%E5%8F%A3"><span class="nav-number">2.</span> <span class="nav-text">入口</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%86%E6%9E%90"><span class="nav-number">3.</span> <span class="nav-text">分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ReferenceConfig-init"><span class="nav-number">4.</span> <span class="nav-text">ReferenceConfig#init</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ReferenceConfig-createProxy"><span class="nav-number">4.1.</span> <span class="nav-text">ReferenceConfig#createProxy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#REF-PROTOCOL-refer-interfaceClass-url"><span class="nav-number">4.2.</span> <span class="nav-text">REF_PROTOCOL.refer(interfaceClass, url)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RegistryDirectory-buildRouterChain"><span class="nav-number">4.2.1.</span> <span class="nav-text">RegistryDirectory.buildRouterChain</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RegistryDirectory-subscribe"><span class="nav-number">4.2.2.</span> <span class="nav-text">RegistryDirectory.subscribe</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DubboInvoker"><span class="nav-number">4.3.</span> <span class="nav-text">DubboInvoker</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%99%84%E5%BD%95"><span class="nav-number">6.</span> <span class="nav-text">附录</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">李俊龙</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">34</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://theme-next.js.org/2022/02/04/dubbo%E4%B9%8B%E5%BC%95%E5%85%A5%E6%9C%8D%E5%8A%A1%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李俊龙">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天真有邪">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          dubbo之引入服务详解
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-04 20:29:01" itemprop="dateCreated datePublished" datetime="2022-02-04T20:29:01+08:00">2022-02-04</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-04-14 10:39:27" itemprop="dateModified" datetime="2022-04-14T10:39:27+08:00">2022-04-14</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/dubbo/" itemprop="url" rel="index"><span itemprop="name">dubbo</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="dubbo之引入服务详解"><a href="#dubbo之引入服务详解" class="headerlink" title="dubbo之引入服务详解"></a>dubbo之引入服务详解</h1><p>前言：分析的dubbo源码是2.7.7版本</p>
<h1 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h1><p>流程图<br><img src="/images/dubbo-6-1.png" alt="入口" loading="lazy"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (destroyed) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;The invoker of ReferenceConfig(&quot;</span> + url + <span class="string">&quot;) has already destroyed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ref == <span class="keyword">null</span>) &#123;</span><br><span class="line">        init(); <span class="comment">// 初始化</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ref;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>

<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">dubbo引入要做什么？一看到这个其实是有点懵的，dubbo服务导出的时候逻辑还有点清晰，那引入呢？我们这块只能先分析下调用逻辑</span><br><span class="line"></span><br><span class="line">消费者端：</span><br><span class="line">private A a;</span><br><span class="line">a.a();</span><br><span class="line"></span><br><span class="line">当调用一个接口方法时逻辑是其实这里的a是一个代理对象，那下面的逻辑就是</span><br><span class="line"></span><br><span class="line">代理对象.方法()&#123;</span><br><span class="line">    // 分析下方法里面应该做什么</span><br><span class="line"></span><br><span class="line">    1. 构建一下invocation</span><br><span class="line">    2. 调用的时候就是invoker.invoke(invocation);</span><br><span class="line">    3. 启动下nettyClient;</span><br><span class="line">    4. 发送下请求</span><br><span class="line"></span><br><span class="line">    // 上面四步基本都是知道的，我们接着再分析下</span><br><span class="line">    0. 获取下providers的URL（监听）</span><br><span class="line">    1.1 mock</span><br><span class="line">    1.2 路由（监听）</span><br><span class="line">    1.3 负载</span><br><span class="line">    2.1 容错</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">由上面的逻辑我们总结下调用思路</span><br><span class="line">    0. 读取下providers的URL（读取要缓存下，并且要监听）</span><br><span class="line">    1. 构建下Invocation</span><br><span class="line">    2. MockClusterInvoker.invoke</span><br><span class="line">        FailbackClusterInvoker.invoke（容错）</span><br><span class="line">            RegistryDirectory.list（这里的服务目录RegistryDirectory可以理解成消费端的缓存）</span><br><span class="line">            0. 缓存providers URL(监听)</span><br><span class="line">            1. 路由（监听）</span><br><span class="line">            2. 负载</span><br><span class="line">            4. 选取一个真正的Invoker，然后调用Invoker.invoke方法</span><br><span class="line">    3. 启动下nettyClient</span><br><span class="line">    4. 发生请求</span><br><span class="line"></span><br><span class="line">在上面调用总结下，我们总结下引入要做的事情</span><br><span class="line">1. 其实就是构建Invoker链</span><br><span class="line">2. 构建RegistryDirectory，里面包含List&lt;Invoker&gt;，其中的Invoker就是DubboInvoker</span><br><span class="line">3. 监听逻辑</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="ReferenceConfig-init"><a href="#ReferenceConfig-init" class="headerlink" title="ReferenceConfig#init"></a>ReferenceConfig#init</h1><p>流程图<br><img src="/images/dubbo-6-2.png" alt="init" loading="lazy"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 初始化，这里初始化后，ref就赋值了</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (initialized) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bootstrap == <span class="keyword">null</span>) &#123; <span class="comment">// 初始化配置</span></span><br><span class="line">            bootstrap = DubboBootstrap.getInstance();</span><br><span class="line">            bootstrap.init();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        checkAndUpdateSubConfigs(); <span class="comment">// 获取最新最全的ReferenceConfig配置</span></span><br><span class="line"></span><br><span class="line">        checkStubAndLocal(interfaceClass);</span><br><span class="line">        ConfigValidationUtils.checkMock(interfaceClass, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">        map.put(SIDE_KEY, CONSUMER_SIDE);</span><br><span class="line"></span><br><span class="line">        ReferenceConfigBase.appendRuntimeParameters(map);</span><br><span class="line">        <span class="keyword">if</span> (!ProtocolUtils.isGeneric(generic)) &#123;</span><br><span class="line">            String revision = Version.getVersion(interfaceClass, version);</span><br><span class="line">            <span class="keyword">if</span> (revision != <span class="keyword">null</span> &amp;&amp; revision.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                map.put(REVISION_KEY, revision);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String[] methods = Wrapper.getWrapper(interfaceClass).getMethodNames();</span><br><span class="line">            <span class="keyword">if</span> (methods.length == <span class="number">0</span>) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;No method found in service interface &quot;</span> + interfaceClass.getName());</span><br><span class="line">                map.put(METHODS_KEY, ANY_VALUE);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                map.put(METHODS_KEY, StringUtils.join(<span class="keyword">new</span> HashSet&lt;String&gt;(Arrays.asList(methods)), COMMA_SEPARATOR));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        map.put(INTERFACE_KEY, interfaceName);</span><br><span class="line">        AbstractConfig.appendParameters(map, getMetrics());</span><br><span class="line">        AbstractConfig.appendParameters(map, getApplication());</span><br><span class="line">        AbstractConfig.appendParameters(map, getModule());</span><br><span class="line">        <span class="comment">// remove &#x27;default.&#x27; prefix for configs from ConsumerConfig</span></span><br><span class="line">        <span class="comment">// appendParameters(map, consumer, Constants.DEFAULT_KEY);</span></span><br><span class="line">        AbstractConfig.appendParameters(map, consumer);</span><br><span class="line">        AbstractConfig.appendParameters(map, <span class="keyword">this</span>);</span><br><span class="line">        MetadataReportConfig metadataReportConfig = getMetadataReportConfig();</span><br><span class="line">        <span class="keyword">if</span> (metadataReportConfig != <span class="keyword">null</span> &amp;&amp; metadataReportConfig.isValid()) &#123;</span><br><span class="line">            map.putIfAbsent(METADATA_KEY, REMOTE_METADATA_STORAGE_TYPE);</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String, AsyncMethodInfo&gt; attributes = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(getMethods())) &#123;</span><br><span class="line">            attributes = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (MethodConfig methodConfig : getMethods()) &#123;</span><br><span class="line">                AbstractConfig.appendParameters(map, methodConfig, methodConfig.getName());</span><br><span class="line">                String retryKey = methodConfig.getName() + <span class="string">&quot;.retry&quot;</span>;</span><br><span class="line">                <span class="keyword">if</span> (map.containsKey(retryKey)) &#123;</span><br><span class="line">                    String retryValue = map.remove(retryKey);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">&quot;false&quot;</span>.equals(retryValue)) &#123;</span><br><span class="line">                        map.put(methodConfig.getName() + <span class="string">&quot;.retries&quot;</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                AsyncMethodInfo asyncMethodInfo = AbstractConfig.convertMethodConfig2AsyncInfo(methodConfig);</span><br><span class="line">                <span class="keyword">if</span> (asyncMethodInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">//                    consumerModel.getMethodModel(methodConfig.getName()).addAttribute(ASYNC_KEY, asyncMethodInfo);</span></span><br><span class="line">                    attributes.put(methodConfig.getName(), asyncMethodInfo);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String hostToRegistry = ConfigUtils.getSystemProperty(DUBBO_IP_TO_REGISTRY);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(hostToRegistry)) &#123;</span><br><span class="line">            hostToRegistry = NetUtils.getLocalHost();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isInvalidLocalHost(hostToRegistry)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Specified invalid registry ip from property:&quot;</span> + DUBBO_IP_TO_REGISTRY + <span class="string">&quot;, value:&quot;</span> + hostToRegistry);</span><br><span class="line">        &#125;</span><br><span class="line">        map.put(REGISTER_IP_KEY, hostToRegistry);</span><br><span class="line"></span><br><span class="line">        serviceMetadata.getAttachments().putAll(map);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * &quot;init&quot; -&gt; &quot;false&quot;</span></span><br><span class="line"><span class="comment">         * &quot;side&quot; -&gt; &quot;consumer&quot;</span></span><br><span class="line"><span class="comment">         * &quot;register.ip&quot; -&gt; &quot;127.0.0.1&quot;</span></span><br><span class="line"><span class="comment">         * &quot;release&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;methods&quot; -&gt; &quot;sayHello,sayHelloAsync&quot;</span></span><br><span class="line"><span class="comment">         * &quot;dubbo&quot; -&gt; &quot;2.0.2&quot;</span></span><br><span class="line"><span class="comment">         * &quot;pid&quot; -&gt; &quot;15300&quot;</span></span><br><span class="line"><span class="comment">         * &quot;interface&quot; -&gt; &quot;org.apache.dubbo.demo.DemoService&quot;</span></span><br><span class="line"><span class="comment">         * &quot;version&quot; -&gt; &quot;1.0.0&quot;</span></span><br><span class="line"><span class="comment">         * &quot;timeout&quot; -&gt; &quot;3000&quot;</span></span><br><span class="line"><span class="comment">         * &quot;revision&quot; -&gt; &quot;1.0.0&quot;</span></span><br><span class="line"><span class="comment">         * &quot;application&quot; -&gt; &quot;dubbo-demo-annotation-consumer&quot;</span></span><br><span class="line"><span class="comment">         * &quot;sticky&quot; -&gt; &quot;false&quot;</span></span><br><span class="line"><span class="comment">         * &quot;timestamp&quot; -&gt; &quot;1644129114622&quot;</span></span><br><span class="line"><span class="comment">         * &quot;group&quot; -&gt; &quot;jianghe-group&quot;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ref = createProxy(map);</span><br><span class="line"></span><br><span class="line">        serviceMetadata.setTarget(ref);</span><br><span class="line">        serviceMetadata.addAttribute(PROXY_CLASS_REF, ref);</span><br><span class="line">        ConsumerModel consumerModel = repository.lookupReferredService(serviceMetadata.getServiceKey());</span><br><span class="line">        consumerModel.setProxyObject(ref);</span><br><span class="line">        consumerModel.init(attributes);</span><br><span class="line"></span><br><span class="line">        initialized = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// dispatch a ReferenceConfigInitializedEvent since 2.7.4</span></span><br><span class="line">        dispatch(<span class="keyword">new</span> ReferenceConfigInitializedEvent(<span class="keyword">this</span>, invoker));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>上面初始化ReferenceBean参数很大部分和ServiceBean类似，都是获取最新最全的配置，然后将信息放入到map里面，这块就不细说了，详细可以看ServiceBean配置，重要的是<code>createProxy</code>，这个就是创建代理对象，然后设置到<code>ConsumerModel</code>，<code>ConsumerModel</code>是在调用的时候使用的，后续调用的时候再介绍。<br>ReferenceBean初始化完成后就发布<code>ReferenceConfigInitializedEvent</code>成功事件</p>
<h2 id="ReferenceConfig-createProxy"><a href="#ReferenceConfig-createProxy" class="headerlink" title="ReferenceConfig#createProxy"></a>ReferenceConfig#createProxy</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;, &quot;deprecation&quot;&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> T <span class="title">createProxy</span><span class="params">(Map&lt;String, String&gt; map)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (shouldJvmRefer(map)) &#123; <span class="comment">// false</span></span><br><span class="line">            URL url = <span class="keyword">new</span> URL(LOCAL_PROTOCOL, LOCALHOST_VALUE, <span class="number">0</span>, interfaceClass.getName()).addParameters(map);</span><br><span class="line">            invoker = REF_PROTOCOL.refer(interfaceClass, url);</span><br><span class="line">            <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;Using injvm service &quot;</span> + interfaceClass.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            urls.clear();</span><br><span class="line">            <span class="keyword">if</span> (url != <span class="keyword">null</span> &amp;&amp; url.length() &gt; <span class="number">0</span>) &#123; <span class="comment">// user specified URL, could be peer-to-peer address, or register center&#x27;s address.</span></span><br><span class="line">                String[] us = SEMICOLON_SPLIT_PATTERN.split(url);</span><br><span class="line">                <span class="keyword">if</span> (us != <span class="keyword">null</span> &amp;&amp; us.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (String u : us) &#123;</span><br><span class="line">                        URL url = URL.valueOf(u);</span><br><span class="line">                        <span class="keyword">if</span> (StringUtils.isEmpty(url.getPath())) &#123;</span><br><span class="line">                            url = url.setPath(interfaceName);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (UrlUtils.isRegistry(url)) &#123;</span><br><span class="line">                            urls.add(url.addParameterAndEncoded(REFER_KEY, StringUtils.toQueryString(map)));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            urls.add(ClusterUtils.mergeUrl(url, map));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// assemble URL from register center&#x27;s configuration</span></span><br><span class="line">                <span class="comment">// if protocols not injvm checkRegistry</span></span><br><span class="line">                <span class="keyword">if</span> (!LOCAL_PROTOCOL.equalsIgnoreCase(getProtocol())) &#123; <span class="comment">// true</span></span><br><span class="line">                    checkRegistry(); <span class="comment">// 检查协议</span></span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * 这里的this就是ReferenceConfig，将ReferenceConfig属性转换为URL</span></span><br><span class="line"><span class="comment">                     * </span></span><br><span class="line"><span class="comment">                     * registry://127.0.0.1:2181/org.apache.dubbo.registry.RegistryService?application=dubbo-demo-annotation-consumer&amp;dubbo=2.0.2&amp;pid=12982&amp;registry=zookeeper&amp;timestamp=1644053669416</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    List&lt;URL&gt; us = ConfigValidationUtils.loadRegistries(<span class="keyword">this</span>, <span class="keyword">false</span>);</span><br><span class="line">                    <span class="keyword">if</span> (CollectionUtils.isNotEmpty(us)) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (URL u : us) &#123;</span><br><span class="line">                            URL monitorUrl = ConfigValidationUtils.loadMonitor(<span class="keyword">this</span>, u);</span><br><span class="line">                            <span class="keyword">if</span> (monitorUrl != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                map.put(MONITOR_KEY, URL.encode(monitorUrl.toFullString()));</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">/**</span></span><br><span class="line"><span class="comment">                             * 里面会包含refer关键字</span></span><br><span class="line"><span class="comment">                             * registry://127.0.0.1:2181/org.apache.dubbo.registry.RegistryService?application=dubbo-demo-annotation-consumer&amp;dubbo=2.0.2&amp;pid=12982&amp;refer=application%3Ddubbo-demo-annotation-consumer%26dubbo%3D2.0.2%26group%3Djianghe-group%26init%3Dfalse%26interface%3Dorg.apache.dubbo.demo.DemoService%26methods%3DsayHello%2CsayHelloAsync%26pid%3D12982%26register.ip%3D127.0.0.1%26revision%3D1.0.0%26side%3Dconsumer%26sticky%3Dfalse%26timestamp%3D1644053460153%26version%3D1.0.0&amp;registry=zookeeper&amp;timestamp=1644053669416</span></span><br><span class="line"><span class="comment">                             */</span></span><br><span class="line">                            urls.add(u.addParameterAndEncoded(REFER_KEY, StringUtils.toQueryString(map)));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (urls.isEmpty()) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;No such any registry to reference &quot;</span> + interfaceName + <span class="string">&quot; on the consumer &quot;</span> + NetUtils.getLocalHost() + <span class="string">&quot; use dubbo version &quot;</span> + Version.getVersion() + <span class="string">&quot;, please config &lt;dubbo:registry address=\&quot;...\&quot; /&gt; to your spring config.&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">            * 这里的注册中心如果是一个走的逻辑不一致，如果是多个走的逻辑也不一致。</span></span><br><span class="line"><span class="comment">            **/</span></span><br><span class="line">            <span class="keyword">if</span> (urls.size() == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 动态目录</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                invoker = REF_PROTOCOL.refer(interfaceClass, urls.get(<span class="number">0</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 静态目录</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                List&lt;Invoker&lt;?&gt;&gt; invokers = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;?&gt;&gt;();</span><br><span class="line">                URL registryURL = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (URL url : urls) &#123;</span><br><span class="line">                    invokers.add(REF_PROTOCOL.refer(interfaceClass, url));</span><br><span class="line">                    <span class="keyword">if</span> (UrlUtils.isRegistry(url)) &#123;</span><br><span class="line">                        registryURL = url; <span class="comment">// use last registry url</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (registryURL != <span class="keyword">null</span>) &#123; <span class="comment">// registry url is available</span></span><br><span class="line">                    <span class="comment">// for multi-subscription scenario, use &#x27;zone-aware&#x27; policy by default</span></span><br><span class="line">                    URL u = registryURL.addParameterIfAbsent(CLUSTER_KEY, ZoneAwareCluster.NAME);</span><br><span class="line">                    <span class="comment">// The invoker wrap relation would be like: ZoneAwareClusterInvoker(StaticDirectory) -&gt; FailoverClusterInvoker(RegistryDirectory, routing happens here) -&gt; Invoker</span></span><br><span class="line">                    invoker = CLUSTER.join(<span class="keyword">new</span> StaticDirectory(u, invokers));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123; <span class="comment">// not a registry url, must be direct invoke.</span></span><br><span class="line">                    invoker = CLUSTER.join(<span class="keyword">new</span> StaticDirectory(invokers));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (shouldCheck() &amp;&amp; !invoker.isAvailable()) &#123;</span><br><span class="line">            invoker.destroy();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Failed to check the status of the service &quot;</span></span><br><span class="line">                    + interfaceName</span><br><span class="line">                    + <span class="string">&quot;. No provider available for the service &quot;</span></span><br><span class="line">                    + (group == <span class="keyword">null</span> ? <span class="string">&quot;&quot;</span> : group + <span class="string">&quot;/&quot;</span>)</span><br><span class="line">                    + interfaceName +</span><br><span class="line">                    (version == <span class="keyword">null</span> ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;:&quot;</span> + version)</span><br><span class="line">                    + <span class="string">&quot; from the url &quot;</span></span><br><span class="line">                    + invoker.getUrl()</span><br><span class="line">                    + <span class="string">&quot; to the consumer &quot;</span></span><br><span class="line">                    + NetUtils.getLocalHost() + <span class="string">&quot; use dubbo version &quot;</span> + Version.getVersion());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;Refer dubbo service &quot;</span> + interfaceClass.getName() + <span class="string">&quot; from url &quot;</span> + invoker.getUrl());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@since</span> 2.7.0</span></span><br><span class="line"><span class="comment">         * ServiceData Store</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String metadata = map.get(METADATA_KEY);</span><br><span class="line">        WritableMetadataService metadataService = WritableMetadataService.getExtension(metadata == <span class="keyword">null</span> ? DEFAULT_METADATA_STORAGE_TYPE : metadata);</span><br><span class="line">        <span class="keyword">if</span> (metadataService != <span class="keyword">null</span>) &#123;</span><br><span class="line">            URL consumerURL = <span class="keyword">new</span> URL(CONSUMER_PROTOCOL, map.remove(REGISTER_IP_KEY), <span class="number">0</span>, map.get(INTERFACE_KEY), map);</span><br><span class="line">            metadataService.publishServiceDefinition(consumerURL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 创建javassist代理类，实际调用的是InvokerInvocationHandler</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// create service proxy</span></span><br><span class="line">        <span class="keyword">return</span> (T) PROXY_FACTORY.getProxy(invoker, ProtocolUtils.isGeneric(generic));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>上面的逻辑才算真正的到核心里面</p>
<ol>
<li><code>List&lt;URL&gt; us = ConfigValidationUtils.loadRegistries(this, false);</code>生成注册中心的URL</li>
<li><b>根据URL然后生成引用的Invoker，<code>invoker = REF_PROTOCOL.refer(interfaceClass, urls.get(0))</code></b>（这个一定要知道是怎么回事）</li>
<li>Invoker生成后，经过<code>PROXY_FACTORY.getProxy(invoker, ProtocolUtils.isGeneric(generic))</code>生成代理类</li>
<li><font color='red'><b>生成的代理类对应的Handler就是InvokerInvocationHandler，那这里就是调用的入口</b></font></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractProxyFactory</span> <span class="keyword">implements</span> <span class="title">ProxyFactory</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Class&lt;?&gt;[] INTERNAL_INTERFACES = <span class="keyword">new</span> Class&lt;?&gt;[]&#123;</span><br><span class="line">            EchoService.class, Destroyable.class</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Invoker&lt;T&gt; invoker)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getProxy(invoker, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Invoker&lt;T&gt; invoker, <span class="keyword">boolean</span> generic)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; interfaces = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        String config = invoker.getUrl().getParameter(INTERFACES);</span><br><span class="line">        <span class="keyword">if</span> (config != <span class="keyword">null</span> &amp;&amp; config.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            String[] types = COMMA_SPLIT_PATTERN.split(config);</span><br><span class="line">            <span class="keyword">for</span> (String type : types) &#123;</span><br><span class="line">                <span class="comment">// TODO can we load successfully for a different classloader?.</span></span><br><span class="line">                interfaces.add(ReflectUtils.forName(type));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (generic) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!GenericService.class.isAssignableFrom(invoker.getInterface())) &#123;</span><br><span class="line">                interfaces.add(com.alibaba.dubbo.rpc.service.GenericService.class);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// find the real interface from url</span></span><br><span class="line">                String realInterface = invoker.getUrl().getParameter(Constants.INTERFACE);</span><br><span class="line">                interfaces.add(ReflectUtils.forName(realInterface));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                <span class="comment">// ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        interfaces.add(invoker.getInterface());</span><br><span class="line">        interfaces.addAll(Arrays.asList(INTERNAL_INTERFACES));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> getProxy(invoker, interfaces.toArray(<span class="keyword">new</span> Class&lt;?&gt;[<span class="number">0</span>]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Invoker&lt;T&gt; invoker, Class&lt;?&gt;[] types)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavassistProxyFactory</span> <span class="keyword">extends</span> <span class="title">AbstractProxyFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Invoker&lt;T&gt; invoker, Class&lt;?&gt;[] interfaces)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (T) Proxy.getProxy(interfaces).newInstance(<span class="keyword">new</span> InvokerInvocationHandler(invoker));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="REF-PROTOCOL-refer-interfaceClass-url"><a href="#REF-PROTOCOL-refer-interfaceClass-url" class="headerlink" title="REF_PROTOCOL.refer(interfaceClass, url)"></a>REF_PROTOCOL.refer(interfaceClass, url)</h2><p>这个方法就是生成Invoker的，具体流程见下面，详细可以看流程图</p>
<p>流程图<br><img src="/images/dubbo-6-3.png" alt="createProxy" loading="lazy"></p>
<p></p>

<ol>
<li>interfaceClass是要引入服务的接口，url是注册中心的url(registry://)</li>
<li>根据spi底层会调用到RegistryProtocol，但是注意这里是有Wrapper，ProtocolFilterWrapper、ProtocolListenerWrapper这两个Wrapper很熟悉，服务导出的时候使用的，经过两个Wrapper类后，最终调用到RegistryProtocol#refer方法<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; type, URL url)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 把registry://换成zookeeper://</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        url = getRegistryUrl(url);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * registryFactory：Registry$Adaptive</span></span><br><span class="line"><span class="comment">         * 这是通过setRegistryFactory方法，通过spi的方式来获取设置的，在哪里获取的时候呢？在ReferenceConfig类中REF_PROTOCOL.refer来获取的</span></span><br><span class="line"><span class="comment">         * 这里也能更加理解SPI的ioc，由于这里设置是根据接口和name来获取对应对象，RegistryFactory的name就是registryFactory，这里是获取不到对象的，但是如果这个接口有实现类，但是没有对应的实现类，就会返回Adaptive类，详细可借鉴类来阅读org.apache.dubbo.remoting.zookeeper.ZookeeperTransporter$Adaptive</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 那这里获取的Registry调用链</span></span><br><span class="line"><span class="comment">         *  org.apache.dubbo.registry.RegistryFactoryWrapper#getRegistry(org.apache.dubbo.common.URL)</span></span><br><span class="line"><span class="comment">         *      org.apache.dubbo.registry.support.AbstractRegistryFactory#getRegistry(org.apache.dubbo.common.URL)</span></span><br><span class="line"><span class="comment">         *          org.apache.dubbo.registry.support.AbstractRegistryFactory#createRegistry(org.apache.dubbo.common.URL)</span></span><br><span class="line"><span class="comment">         *              org.apache.dubbo.registry.zookeeper.ZookeeperRegistryFactory#createRegistry(org.apache.dubbo.common.URL)</span></span><br><span class="line"><span class="comment">         *                  org.apache.dubbo.registry.zookeeper.ZookeeperRegistry#ZookeeperRegistry(org.apache.dubbo.common.URL, org.apache.dubbo.remoting.zookeeper.ZookeeperTransporter)</span></span><br><span class="line"><span class="comment">         *                      org.apache.dubbo.registry.support.FailbackRegistry#FailbackRegistry(org.apache.dubbo.common.URL)</span></span><br><span class="line"><span class="comment">         *                          org.apache.dubbo.registry.support.AbstractRegistry#AbstractRegistry(org.apache.dubbo.common.URL)</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Registry其实是：</span></span><br><span class="line"><span class="comment">         *  ListenerRegistryWrapper -&gt; ZookeeperRegistry</span></span><br><span class="line"><span class="comment">         *  &lt;b&gt;</span></span><br><span class="line"><span class="comment">         *      注意，这里的路径这么深其实就是为了构造ZookeeperRegistry，这里其实就是为了创建consumers下的节点，ZookeeperRegistry里面也是包含创建好的zkClient</span></span><br><span class="line"><span class="comment">         *  &lt;/b&gt;</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * url：zookeeper://127.0.0.1:2181/org.apache.dubbo.registry.RegistryService?application=dubbo-demo-annotation-consumer&amp;dubbo=2.0.2&amp;pid=15549&amp;refer=application%3Ddubbo-demo-annotation-consumer%26dubbo%3D2.0.2%26group%3Djianghe-group%26init%3Dfalse%26interface%3Dorg.apache.dubbo.demo.DemoService%26methods%3DsayHello%2CsayHelloAsync%26pid%3D15549%26register.ip%3D127.0.0.1%26revision%3D1.0.0%26side%3Dconsumer%26sticky%3Dfalse%26timeout%3D3000%26timestamp%3D1644131247489%26version%3D1.0.0&amp;timestamp=1644131249527</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Registry registry = registryFactory.getRegistry(url);</span><br><span class="line">        <span class="keyword">if</span> (RegistryService.class.equals(type)) &#123; <span class="comment">// false，老版本兼容解决问题</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * proxyFactory：ProxyFactory$Adaptive，</span></span><br><span class="line"><span class="comment">             * 这是通过setProxyFactory方法，spi的方式来设置的</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">return</span> proxyFactory.getInvoker((T) registry, type, url);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * &quot;init&quot; -&gt; &quot;false&quot;</span></span><br><span class="line"><span class="comment">         * &quot;side&quot; -&gt; &quot;consumer&quot;</span></span><br><span class="line"><span class="comment">         * &quot;register.ip&quot; -&gt; &quot;127.0.0.1&quot;</span></span><br><span class="line"><span class="comment">         * &quot;methods&quot; -&gt; &quot;sayHello,sayHelloAsync&quot;</span></span><br><span class="line"><span class="comment">         * &quot;dubbo&quot; -&gt; &quot;2.0.2&quot;</span></span><br><span class="line"><span class="comment">         * &quot;pid&quot; -&gt; &quot;15300&quot;</span></span><br><span class="line"><span class="comment">         * &quot;interface&quot; -&gt; &quot;org.apache.dubbo.demo.DemoService&quot;</span></span><br><span class="line"><span class="comment">         * &quot;version&quot; -&gt; &quot;1.0.0&quot;</span></span><br><span class="line"><span class="comment">         * &quot;timeout&quot; -&gt; &quot;3000&quot;</span></span><br><span class="line"><span class="comment">         * &quot;revision&quot; -&gt; &quot;1.0.0&quot;</span></span><br><span class="line"><span class="comment">         * &quot;application&quot; -&gt; &quot;dubbo-demo-annotation-consumer&quot;</span></span><br><span class="line"><span class="comment">         * &quot;sticky&quot; -&gt; &quot;false&quot;</span></span><br><span class="line"><span class="comment">         * &quot;group&quot; -&gt; &quot;jianghe-group&quot;</span></span><br><span class="line"><span class="comment">         * &quot;timestamp&quot; -&gt; &quot;1644129114622&quot;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// group=&quot;a,b&quot; or group=&quot;*&quot;</span></span><br><span class="line">        Map&lt;String, String&gt; qs = StringUtils.parseQueryString(url.getParameterAndDecoded(REFER_KEY));</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * jianghe-group</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String group = qs.get(GROUP_KEY);</span><br><span class="line">        <span class="keyword">if</span> (group != <span class="keyword">null</span> &amp;&amp; group.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((COMMA_SPLIT_PATTERN.split(group)).length &gt; <span class="number">1</span> || <span class="string">&quot;*&quot;</span>.equals(group)) &#123; <span class="comment">// 多group</span></span><br><span class="line">                <span class="keyword">return</span> doRefer(getMergeableCluster(), registry, type, url);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> doRefer(cluster, registry, type, url);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><code>Registry registry = registryFactory.getRegistry(url)</code>工厂模式，底层最终构建ZooKeeperRegistry，底层肯定操作zookeeper</li>
<li>然后调用RegistryProtocol.doRefer 真正引入<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 真正的引用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cluster</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">doRefer</span><span class="params">(Cluster cluster, Registry registry, Class&lt;T&gt; type, URL url)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 构造服务目录</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * zookeeper://127.0.0.1:2181/org.apache.dubbo.registry.RegistryService?application=dubbo-demo-annotation-consumer&amp;dubbo=2.0.2&amp;pid=15300&amp;refer=application%3Ddubbo-demo-annotation-consumer%26dubbo%3D2.0.2%26group%3Djianghe-group%26init%3Dfalse%26interface%3Dorg.apache.dubbo.demo.DemoService%26methods%3DsayHello%2CsayHelloAsync%26pid%3D15300%26register.ip%3D127.0.0.1%26revision%3D1.0.0%26side%3Dconsumer%26sticky%3Dfalse%26timeout%3D3000%26timestamp%3D1644129114622%26version%3D1.0.0&amp;timestamp=1644129134554</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        RegistryDirectory&lt;T&gt; directory = <span class="keyword">new</span> RegistryDirectory&lt;T&gt;(type, url); <span class="comment">// 构造服务目录</span></span><br><span class="line">        directory.setRegistry(registry); <span class="comment">// ListenerRegistryWrapper -&gt; ZookeeperRegistry</span></span><br><span class="line">        directory.setProtocol(protocol); <span class="comment">// Protocol$Adaptive</span></span><br><span class="line">        <span class="comment">// all attributes of REFER_KEY</span></span><br><span class="line">        Map&lt;String, String&gt; parameters = <span class="keyword">new</span> HashMap&lt;String, String&gt;(directory.getConsumerUrl().getParameters());</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * subscribeUrl</span></span><br><span class="line"><span class="comment">         *  consumer://127.0.0.1/org.apache.dubbo.demo.DemoService?application=dubbo-demo-annotation-consumer&amp;dubbo=2.0.2&amp;group=jianghe-group&amp;init=false&amp;interface=org.apache.dubbo.demo.DemoService&amp;methods=sayHello,sayHelloAsync&amp;pid=15812&amp;revision=1.0.0&amp;side=consumer&amp;sticky=false&amp;timeout=3000&amp;timestamp=1644134813635&amp;version=1.0.0</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        URL subscribeUrl = <span class="keyword">new</span> URL(CONSUMER_PROTOCOL, parameters.remove(REGISTER_IP_KEY), <span class="number">0</span>, type.getName(), parameters);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 这里判断的逻辑还是register是否为true &amp;&amp; 接口不是*</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (directory.isShouldRegister()) &#123; <span class="comment">// true</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 简化URL</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            directory.setRegisteredConsumerUrl(subscribeUrl);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * zookeeper 注册服务</span></span><br><span class="line"><span class="comment">             *  ListenerRegistryWrapper#register -&gt; FailbackRegistry#register(ZookeeperRegistry的) -&gt; ZookeeperRegistry#doRegister(org.apache.dubbo.common.URL)</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            registry.register(directory.getRegisteredConsumerUrl());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 构建路由链，路由链是调用的时候起作用的，这里就是调用的时候M-&gt;N</span></span><br><span class="line"><span class="comment">         * 新版本标签路由目录：/dubbo/config/dubbo/dubbo-demo-annotation-provider.tag-router</span></span><br><span class="line"><span class="comment">         * 新版本条件路由目录：/dubbo/config/dubbo/org.apache.dubbo.demo.DemoService:1.0.0:jianghe-group.condition-router</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        directory.buildRouterChain(subscribeUrl); <span class="comment">// 路由链</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 订阅（最终会调用到）</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * toSubscribeUrl(subscribeUrl)增加了参数category=providers,configurators,routers</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * consumer://127.0.0.1/org.apache.dubbo.demo.DemoService?application=dubbo-demo-annotation-consumer&amp;category=providers,configurators,routers&amp;dubbo=2.0.2&amp;group=jianghe-group&amp;init=false&amp;interface=org.apache.dubbo.demo.DemoService&amp;methods=sayHello,sayHelloAsync&amp;pid=15812&amp;revision=1.0.0&amp;side=consumer&amp;sticky=false&amp;timeout=3000&amp;timestamp=1644134813635&amp;version=1.0.0</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 当前应用对应的动态配置目录：/dubbo/config/dubbo/dubbo-demo-annotation-consumer.configurators</span></span><br><span class="line"><span class="comment">         * 当前服务对应的动态配置目录：/dubbo/config/dubbo/org.apache.dubbo.demo.DemoService:1.0.0:jianghe-group.configurators</span></span><br><span class="line"><span class="comment">         * 当前引入服务提供者的目录：/dubbo/org.apache.dubbo.demo.DemoService/providers</span></span><br><span class="line"><span class="comment">         * 当前引入服务动态配置目录（兼容老版本，这里只有针对服务的，没有应用的）：/dubbo/org.apache.dubbo.demo.DemoService/configurators</span></span><br><span class="line"><span class="comment">         * 当前引入服务路由目录（兼容老版本，这里只有针对服务的，没有应用的）：/dubbo/org.apache.dubbo.demo.DemoService/routers</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        directory.subscribe(toSubscribeUrl(subscribeUrl)); <span class="comment">// 订阅</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 构建Invoker链</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 将RegistryDirectory作为属性，RegistryDirectory里面有包含List&lt;DubboInvoker&gt;，最终返回一个Invoker</span></span><br><span class="line"><span class="comment">         * MockClusterInvoker -&gt;</span></span><br><span class="line"><span class="comment">         *  AbstractCluster$Interceptor</span></span><br><span class="line"><span class="comment">         *      FailoverClusterInvoker -&gt;</span></span><br><span class="line"><span class="comment">         *          RegistryDirectory -&gt;</span></span><br><span class="line"><span class="comment">         *              List&lt;RegistryDirectory$InvokerDelegate&gt;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Invoker&lt;T&gt; invoker = cluster.join(directory);</span><br><span class="line">        List&lt;RegistryProtocolListener&gt; listeners = findRegistryProtocolListeners(url);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(listeners)) &#123; <span class="comment">// 空的</span></span><br><span class="line">            <span class="keyword">return</span> invoker;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        RegistryInvokerWrapper&lt;T&gt; registryInvokerWrapper = <span class="keyword">new</span> RegistryInvokerWrapper&lt;&gt;(directory, cluster, invoker, subscribeUrl);</span><br><span class="line">        <span class="keyword">for</span> (RegistryProtocolListener listener : listeners) &#123;</span><br><span class="line">            listener.onRefer(<span class="keyword">this</span>, registryInvokerWrapper);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> registryInvokerWrapper;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li>这里构建了一个服务目录RegistryDirectory（路由，负载，动态配置）</li>
<li><code>registry.register(directory.getRegisteredConsumerUrl())</code>这个就很清晰，这个就是创建consumers消费者</li>
<li><code>directory.buildRouterChain(subscribeUrl)</code>建立路由链</li>
<li><code>directory.subscribe(toSubscribeUrl(subscribeUrl))</code>订阅服务，这里其实就是动态配置（<b>完成监听器的订阅后，会自动触发一次去获取动态配置</b>）</li>
<li><font color='red'><b>然后调用cluster.join(directory)根据服务目录构建Invoker，通过SPI方式返回Invoker</b></font><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MockClusterInvoker -&gt;</span><br><span class="line">    AbstractCluster$Interceptor</span><br><span class="line">        FailoverClusterInvoker -&gt;</span><br><span class="line">            RegistryDirectory -&gt;</span><br><span class="line">                List&lt;RegistryDirectory$InvokerDelegate&gt;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="RegistryDirectory-buildRouterChain"><a href="#RegistryDirectory-buildRouterChain" class="headerlink" title="RegistryDirectory.buildRouterChain"></a>RegistryDirectory.buildRouterChain</h3><p>buildRouterChain最终调用构建RouterChain(URL url)，这里的url就是：consumer://127.0.0.1/org.apache.dubbo.demo.DemoService?application=dubbo-demo-annotation-consumer&amp;category=providers,configurators,routers&amp;dubbo=2.0.2&amp;group=jianghe-group&amp;init=false&amp;interface=org.apache.dubbo.demo.DemoService&amp;methods=sayHello,sayHelloAsync&amp;pid=15812&amp;revision=1.0.0&amp;side=consumer&amp;sticky=false&amp;timeout=3000&amp;timestamp=1644134813635&amp;version=1.0.0</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">RouterChain</span><span class="params">(URL url)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 0 = &#123;MockRouterFactory@4528&#125;</span></span><br><span class="line"><span class="comment">        * 1 = &#123;TagRouterFactory@4529&#125; 标签路由</span></span><br><span class="line"><span class="comment">        * 2 = &#123;AppRouterFactory@4530&#125;  应用条件路由</span></span><br><span class="line"><span class="comment">        * 3 = &#123;ServiceRouterFactory@4531&#125; 服务条件路由</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    List&lt;RouterFactory&gt; extensionFactories = ExtensionLoader.getExtensionLoader(RouterFactory.class)</span><br><span class="line">            .getActivateExtension(url, <span class="string">&quot;router&quot;</span>);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 工厂模式，RouterFactory根据url生成各个Router</span></span><br><span class="line"><span class="comment">        * MockInvokersSelector 这个可以再看下，不是很清晰</span></span><br><span class="line"><span class="comment">        * 注意，这里生成的Router是真是可用的</span></span><br><span class="line"><span class="comment">        *  1. 其中AppRouter和ServiceRouter已经是完全可以用的，里面也有从配置中心读取的内容，监听</span></span><br><span class="line"><span class="comment">        *  2. TagRouter还不可用，为什么？标签路由是根据提供者名称来配置，目前是无法获取到提供者的名称的，哪里能获取，/providers下面是可以获取到的</span></span><br><span class="line"><span class="comment">        *      那TagRouter什么时候起作用？RegistryDirectory#refreshInvoker方法里面</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * 0 = &#123;MockInvokersSelector@3917&#125;</span></span><br><span class="line"><span class="comment">        * 1 = &#123;TagRouter@3918&#125;</span></span><br><span class="line"><span class="comment">        * 2 = &#123;AppRouter@3919&#125;</span></span><br><span class="line"><span class="comment">        * 3 = &#123;ServiceRouter@3920&#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    List&lt;Router&gt; routers = extensionFactories.stream()</span><br><span class="line">            .map(factory -&gt; factory.getRouter(url))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 排序</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    initWithRouters(routers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RouterChain是泛型，泛型是URL，每个URL绑定一个路由链，其中URL直接跟routers属性绑定 </p>
<p>builtinRouters：</p>
<ol>
<li>{MockInvokersSelector@3917} ，Mock路由</li>
<li>{TagRouter@3918} ，标签路由</li>
<li>{AppRouter@3919} ，应用条件路由</li>
<li>{ServiceRouter@3920} ，服务条件路由</li>
</ol>
<p>routers（有顺序的，根据优先级排序）：</p>
<ol>
<li>MockInvokersSelector，优先级是 = Integer.MIN_VALUE </li>
<li>TagRouter，优先级 = 100</li>
<li>ServiceRouter（这是新版本监听服务路由），优先级 = 140<br>监听的路径：/dubbo/config/dubbo/org.apache.dubbo.demo.DemoService:1.0.0:jianghe-group.condition-router</li>
<li>AppRouter（这是新版本监听应用路由），优先级 = 150<br>监听的路径：/dubbo/config/dubbo/dubbo-demo-annotation-consumer.condition-router</li>
</ol>
<p><font color='red'><b>注意，这里生成的Router是真是可用的</b></font><br><b></p>
<ol>
<li>MockInvokersSelector 这个可以再看下，不是很清晰</li>
<li>其中AppRouter和ServiceRouter已经是完全可以用的，里面也有从配置中心读取的内容，监听</li>
<li>TagRouter还不可用，为什么？标签路由是根据提供者名称来配置，目前是无法获取到提供者的名称的，哪里能获取，提供者/providers下面URL是可以获取到的</li>
<li>那TagRouter什么时候起作用？RegistryDirectory#refreshInvoker方法里面</b>

</li>
</ol>
<h3 id="RegistryDirectory-subscribe"><a href="#RegistryDirectory-subscribe" class="headerlink" title="RegistryDirectory.subscribe"></a>RegistryDirectory.subscribe</h3><p>订阅这块比较复杂，单列出来说，有新老版本，这里的url就是consumer://127.0.0.1/org.apache.dubbo.demo.DemoService?application=dubbo-demo-annotation-consumer&amp;category=providers,configurators,routers&amp;dubbo=2.0.2&amp;group=jianghe-group&amp;init=false&amp;interface=org.apache.dubbo.demo.DemoService&amp;methods=sayHello,sayHelloAsync&amp;pid=13273&amp;revision=1.0.0&amp;side=consumer&amp;sticky=false&amp;timestamp=1644054153748&amp;version=1.0.0<br>流程图<br><img src="/images/dubbo-6-3-1.png" alt="服务目录订阅" loading="lazy"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(URL url)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * consumer://127.0.0.1/org.apache.dubbo.demo.DemoService?application=dubbo-demo-annotation-consumer&amp;category=providers,configurators,routers&amp;dubbo=2.0.2&amp;group=jianghe-group&amp;init=false&amp;interface=org.apache.dubbo.demo.DemoService&amp;methods=sayHello,sayHelloAsync&amp;pid=13273&amp;revision=1.0.0&amp;side=consumer&amp;sticky=false&amp;timestamp=1644054153748&amp;version=1.0.0</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    setConsumerUrl(url);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 新版本的应用配置</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    CONSUMER_CONFIGURATION_LISTENER.addNotifyListener(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 新版本的服务配置监听</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    serviceConfigurationListener = <span class="keyword">new</span> ReferenceConfigurationListener(<span class="keyword">this</span>, url);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 老版本的服务配置监听</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    registry.subscribe(url, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>ConsumerConfigurationListener这个是新版本的应用动态配置监听<br> 监听路径：/dubbo/config/dubbo/dubbo-demo-consumer-application.configurators</li>
<li>ReferenceConfigurationListener这个是新版本的服务动态配置监听<br> 监听路径：/dubbo/config/dubbo/org.apache.dubbo.demo.DemoService:1.0.0:jianghe-group.configurators</li>
<li><code>registry.subscribe(url, this);</code>这个是老版本的动态配置监听，这里会包含下面三个目录，其中<code>/dubbo/org.apache.dubbo.demo.DemoService/providers</code>这不算是老的配置，这里为什么会放在一起，只是目录前缀一致<ol>
<li>当前引入服务提供者的目录：/dubbo/org.apache.dubbo.demo.DemoService/providers</li>
<li>当前引入服务动态配置目录（兼容老版本，这里只有针对服务的，没有应用的）：/dubbo/org.apache.dubbo.demo.DemoService/configurators</li>
<li>当前引入服务路由目录（兼容老版本，这里只有针对服务的，没有应用的）：/dubbo/org.apache.dubbo.demo.DemoService/routers</li>
</ol>
</li>
<li>然后最终调用ZookeeperRegistry.doSubscribe<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> listener 这里的监听器就是RegistryDirectory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSubscribe</span><span class="params">(<span class="keyword">final</span> URL url, <span class="keyword">final</span> NotifyListener listener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 判断接口是否为*</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (ANY_VALUE.equals(url.getServiceInterface())) &#123; <span class="comment">// false</span></span><br><span class="line">                String root = toRootPath();</span><br><span class="line">                ConcurrentMap&lt;NotifyListener, ChildListener&gt; listeners = zkListeners.computeIfAbsent(url, k -&gt; <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;());</span><br><span class="line">                ChildListener zkListener = listeners.computeIfAbsent(listener, k -&gt; (parentPath, currentChilds) -&gt; &#123;</span><br><span class="line">                    <span class="keyword">for</span> (String child : currentChilds) &#123;</span><br><span class="line">                        child = URL.decode(child);</span><br><span class="line">                        <span class="keyword">if</span> (!anyServices.contains(child)) &#123;</span><br><span class="line">                            anyServices.add(child);</span><br><span class="line">                            subscribe(url.setPath(child).addParameters(INTERFACE_KEY, child,</span><br><span class="line">                                    Constants.CHECK_KEY, String.valueOf(<span class="keyword">false</span>)), k);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                zkClient.create(root, <span class="keyword">false</span>);</span><br><span class="line">                List&lt;String&gt; services = zkClient.addChildListener(root, zkListener);</span><br><span class="line">                <span class="keyword">if</span> (CollectionUtils.isNotEmpty(services)) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (String service : services) &#123;</span><br><span class="line">                        service = URL.decode(service);</span><br><span class="line">                        anyServices.add(service);</span><br><span class="line">                        subscribe(url.setPath(service).addParameters(INTERFACE_KEY, service,</span><br><span class="line">                                Constants.CHECK_KEY, String.valueOf(<span class="keyword">false</span>)), listener);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                List&lt;URL&gt; urls = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 0 = &quot;/dubbo/org.apache.dubbo.demo.DemoService/providers&quot;</span></span><br><span class="line"><span class="comment">                 * 1 = &quot;/dubbo/org.apache.dubbo.demo.DemoService/configurators&quot;</span></span><br><span class="line"><span class="comment">                 * 2 = &quot;/dubbo/org.apache.dubbo.demo.DemoService/routers&quot;</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">for</span> (String path : toCategoriesPath(url)) &#123; <span class="comment">//监听服务</span></span><br><span class="line">                    ConcurrentMap&lt;NotifyListener, ChildListener&gt; listeners = zkListeners.computeIfAbsent(url, k -&gt; <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;());</span><br><span class="line">                    ChildListener zkListener = listeners.computeIfAbsent(listener, k -&gt; (parentPath, currentChilds) -&gt; ZookeeperRegistry.<span class="keyword">this</span>.notify(url, k, toUrlsWithEmpty(url, parentPath, currentChilds)));</span><br><span class="line">                    zkClient.create(path, <span class="keyword">false</span>); <span class="comment">// 持久化节点</span></span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * 这里获取的就是子目录的路径值</span></span><br><span class="line"><span class="comment">                     * path：/dubbo/org.apache.dubbo.demo.DemoService/providers</span></span><br><span class="line"><span class="comment">                     * children(这里是子目录，不是节点内容)：</span></span><br><span class="line"><span class="comment">                     *  1. dubbo%3A%2F%2F172.16.116.200%3A21881%2Forg.apache.dubbo.demo.DemoService%3Fanyhost%3Dtrue%26application%3Ddubbo-demo-annotation-provider%26deprecated%3Dfalse%26dubbo%3D2.0.2%26dynamic%3Dtrue%26generic%3Dfalse%26group%3Djianghe-group%26interface%3Dorg.apache.dubbo.demo.DemoService%26loadbalance%3Dleastactive%26methods%3DsayHello%2CsayHelloAsync%26pid%3D2456%26release%3D%26revision%3D1.0.0%26side%3Dprovider%26timeout%3D1000%26timestamp%3D1644460848263%26version%3D1.0.0</span></span><br><span class="line"><span class="comment">                     *  2. dubbo%3A%2F%2F172.16.116.200%3A21880%2Forg.apache.dubbo.demo.DemoService%3Fanyhost%3Dtrue%26application%3Ddubbo-demo-annotation-provider%26deprecated%3Dfalse%26dubbo%3D2.0.2%26dynamic%3Dtrue%26generic%3Dfalse%26group%3Djianghe-group%26interface%3Dorg.apache.dubbo.demo.DemoService%26loadbalance%3Dleastactive%26methods%3DsayHello%2CsayHelloAsync%26pid%3D2456%26release%3D%26revision%3D1.0.0%26side%3Dprovider%26timeout%3D1000%26timestamp%3D1644460847650%26version%3D1.0.0</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    List&lt;String&gt; children = zkClient.addChildListener(path, zkListener); <span class="comment">// 监听</span></span><br><span class="line">                    <span class="keyword">if</span> (children != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        urls.addAll(toUrlsWithEmpty(url, path, children));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 主动去监听，主动去触发</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 * url:</span></span><br><span class="line"><span class="comment">                 *  consumer://127.0.0.1/org.apache.dubbo.demo.DemoService?application=dubbo-demo-annotation-consumer&amp;category=providers,configurators,routers&amp;dubbo=2.0.2&amp;group=jianghe-group&amp;init=false&amp;interface=org.apache.dubbo.demo.DemoService&amp;methods=sayHello,sayHelloAsync&amp;pid=13534&amp;revision=1.0.0&amp;side=consumer&amp;sticky=false&amp;timestamp=1644055748778&amp;version=1.0.0</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 * urls:</span></span><br><span class="line"><span class="comment">                 *  0 = &#123;URL@4912&#125; &quot;dubbo://127.0.0.1:21880/org.apache.dubbo.demo.DemoService?anyhost=true&amp;application=dubbo-demo-annotation-provider&amp;deprecated=false&amp;dubbo=2.0.2&amp;dynamic=true&amp;generic=false&amp;group=jianghe-group&amp;interface=org.apache.dubbo.demo.DemoService&amp;loadbalance=leastactive&amp;methods=sayHello,sayHelloAsync&amp;pid=12965&amp;release=&amp;revision=1.0.0&amp;side=provider&amp;timeout=5000&amp;timestamp=1644052494096&amp;version=1.0.0&quot;</span></span><br><span class="line"><span class="comment">                 * 1 = &#123;URL@4913&#125; &quot;dubbo://127.0.0.1:21881/org.apache.dubbo.demo.DemoService?anyhost=true&amp;application=dubbo-demo-annotation-provider&amp;deprecated=false&amp;dubbo=2.0.2&amp;dynamic=true&amp;generic=false&amp;group=jianghe-group&amp;interface=org.apache.dubbo.demo.DemoService&amp;loadbalance=leastactive&amp;methods=sayHello,sayHelloAsync&amp;pid=12965&amp;release=&amp;revision=1.0.0&amp;side=provider&amp;timeout=1000&amp;timestamp=1644052494777&amp;version=1.0.0&quot;</span></span><br><span class="line"><span class="comment">                 * 2 = &#123;URL@4917&#125; &quot;empty://127.0.0.1/org.apache.dubbo.demo.DemoService?application=dubbo-demo-annotation-consumer&amp;category=configurators&amp;dubbo=2.0.2&amp;group=jianghe-group&amp;init=false&amp;interface=org.apache.dubbo.demo.DemoService&amp;methods=sayHello,sayHelloAsync&amp;pid=13534&amp;revision=1.0.0&amp;side=consumer&amp;sticky=false&amp;timestamp=1644055748778&amp;version=1.0.0&quot;</span></span><br><span class="line"><span class="comment">                 * 3 = &#123;URL@4918&#125; &quot;empty://127.0.0.1/org.apache.dubbo.demo.DemoService?application=dubbo-demo-annotation-consumer&amp;category=routers&amp;dubbo=2.0.2&amp;group=jianghe-group&amp;init=false&amp;interface=org.apache.dubbo.demo.DemoService&amp;methods=sayHello,sayHelloAsync&amp;pid=13534&amp;revision=1.0.0&amp;side=consumer&amp;sticky=false&amp;timestamp=1644055748778&amp;version=1.0.0&quot;</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                notify(url, listener, urls);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">&quot;Failed to subscribe &quot;</span> + url + <span class="string">&quot; to zookeeper &quot;</span> + getUrl() + <span class="string">&quot;, cause: &quot;</span> + e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li>根据三个类目路径，获取到信息，主动调用notify(url, listener, urls);<ol>
<li>/dubbo/org.apache.dubbo.demo.DemoService/providers</li>
<li>/dubbo/org.apache.dubbo.demo.DemoService/configurators</li>
<li>/dubbo/org.apache.dubbo.demo.DemoService/routers</li>
</ol>
</li>
<li>然后调用到AbstractRegistry#notify，这里的listener是RegistryDirectory，最终会调用到RegistryDirectory#notify方法，其中categoryList就是节点内容，例如/providers那就是该接口的提供者列表<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Notify changes from the Provider side.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url      consumer side url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> listener listener</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> urls     provider latest urls</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(URL url, NotifyListener listener, List&lt;URL&gt; urls)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (url == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;notify url == null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (listener == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;notify listener == null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((CollectionUtils.isEmpty(urls))</span><br><span class="line">                &amp;&amp; !ANY_VALUE.equals(url.getServiceInterface())) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;Ignore empty notify urls for subscribe url &quot;</span> + url);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;Notify urls for subscribe url &quot;</span> + url + <span class="string">&quot;, urls: &quot;</span> + urls);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// keep every provider&#x27;s category.</span></span><br><span class="line">        Map&lt;String, List&lt;URL&gt;&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (URL u : urls) &#123;</span><br><span class="line">            <span class="keyword">if</span> (UrlUtils.isMatch(url, u)) &#123;</span><br><span class="line">                String category = u.getParameter(CATEGORY_KEY, DEFAULT_CATEGORY);</span><br><span class="line">                List&lt;URL&gt; categoryList = result.computeIfAbsent(category, k -&gt; <span class="keyword">new</span> ArrayList&lt;&gt;());</span><br><span class="line">                categoryList.add(u);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (result.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String, List&lt;URL&gt;&gt; categoryNotified = notified.computeIfAbsent(url, u -&gt; <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;());</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 其中的result有三个值</span></span><br><span class="line"><span class="comment">         * key = routers</span></span><br><span class="line"><span class="comment">         * value = empty://127.0.0.1/org.apache.dubbo.demo.DemoService?application=dubbo-demo-annotation-consumer&amp;category=routers&amp;dubbo=2.0.2&amp;group=jianghe-group&amp;init=false&amp;interface=org.apache.dubbo.demo.DemoService&amp;methods=sayHello,sayHelloAsync&amp;pid=18535&amp;revision=1.0.0&amp;side=consumer&amp;sticky=false&amp;timeout=3000&amp;timestamp=1644215337200&amp;version=1.0.0</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * key = configurators</span></span><br><span class="line"><span class="comment">         * value = empty://127.0.0.1/org.apache.dubbo.demo.DemoService?application=dubbo-demo-annotation-consumer&amp;category=configurators&amp;dubbo=2.0.2&amp;group=jianghe-group&amp;init=false&amp;interface=org.apache.dubbo.demo.DemoService&amp;methods=sayHello,sayHelloAsync&amp;pid=18535&amp;revision=1.0.0&amp;side=consumer&amp;sticky=false&amp;timeout=3000&amp;timestamp=1644215337200&amp;version=1.0.0</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * key = providers</span></span><br><span class="line"><span class="comment">         * value =</span></span><br><span class="line"><span class="comment">         *  dubbo://127.0.0.1:21881/org.apache.dubbo.demo.DemoService?anyhost=true&amp;application=dubbo-demo-annotation-provider&amp;deprecated=false&amp;dubbo=2.0.2&amp;dynamic=true&amp;generic=false&amp;group=jianghe-group&amp;interface=org.apache.dubbo.demo.DemoService&amp;loadbalance=leastactive&amp;methods=sayHello,sayHelloAsync&amp;pid=17908&amp;release=&amp;revision=1.0.0&amp;side=provider&amp;timeout=1000&amp;timestamp=1644205565914&amp;version=1.0.0</span></span><br><span class="line"><span class="comment">         *  dubbo://127.0.0.1:21880/org.apache.dubbo.demo.DemoService?anyhost=true&amp;application=dubbo-demo-annotation-provider&amp;deprecated=false&amp;dubbo=2.0.2&amp;dynamic=true&amp;generic=false&amp;group=jianghe-group&amp;interface=org.apache.dubbo.demo.DemoService&amp;loadbalance=leastactive&amp;methods=sayHello,sayHelloAsync&amp;pid=17908&amp;release=&amp;revision=1.0.0&amp;side=provider&amp;timeout=5000&amp;timestamp=1644205564950&amp;version=1.0.0</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, List&lt;URL&gt;&gt; entry : result.entrySet()) &#123;</span><br><span class="line">            String category = entry.getKey();</span><br><span class="line">            List&lt;URL&gt; categoryList = entry.getValue();</span><br><span class="line">            categoryNotified.put(category, categoryList);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 这里就是调用RegistryDirectory.notify接口，真正监听器的notify方法</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            listener.notify(categoryList);</span><br><span class="line">            <span class="comment">// We will update our cache file after each notification.</span></span><br><span class="line">            <span class="comment">// When our Registry has a subscribe failure due to network jitter, we can return at least the existing cache URL.</span></span><br><span class="line">            saveProperties(url); <span class="comment">// 持久化</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li>这个就是RegistryDirectory#notify，<ol>
<li>如果获取到/configurators内容，就会放到configurators配置里，获取内容，监听，然后会调用refreshOverrideAndInvoker里的overrideDirectoryUrl方法重写URL</li>
<li>如果获取到/routers内容，就会设置到RouterChain里面，调用的时候使用路由链</li>
<li>如果获取到/providers，就会调用refreshOverrideAndInvoker里的refreshInvoker获取Invoker<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这里是真正唤醒的方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> urls The list of registered information , is always not empty. The meaning is the same as the return value of &#123;<span class="doctag">@link</span> org.apache.dubbo.registry.RegistryService#lookup(URL)&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(List&lt;URL&gt; urls)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, List&lt;URL&gt;&gt; categoryUrls = urls.stream()</span><br><span class="line">                .filter(Objects::nonNull)</span><br><span class="line">                .filter(<span class="keyword">this</span>::isValidCategory)</span><br><span class="line">                .filter(<span class="keyword">this</span>::isNotCompatibleFor26x)</span><br><span class="line">                .collect(Collectors.groupingBy(<span class="keyword">this</span>::judgeCategory));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 老版本的动态配置</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        List&lt;URL&gt; configuratorURLs = categoryUrls.getOrDefault(CONFIGURATORS_CATEGORY, Collections.emptyList());</span><br><span class="line">        <span class="keyword">this</span>.configurators = Configurator.toConfigurators(configuratorURLs).orElse(<span class="keyword">this</span>.configurators);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 老版本路由的动态配置</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        List&lt;URL&gt; routerURLs = categoryUrls.getOrDefault(ROUTERS_CATEGORY, Collections.emptyList());</span><br><span class="line">        toRouters(routerURLs).ifPresent(<span class="keyword">this</span>::addRouters);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 这里就是查询提供者的信息</span></span><br><span class="line"><span class="comment">         * 这里的提供者为什么在这里？其实是跟目录有关系，/dubbo/org.apache.dubbo.demo.DemoService/providers</span></span><br><span class="line"><span class="comment">         * 跟上面的路径只有后面/providers 不一样，其他都是这样，所以提供者就在这里</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// providers</span></span><br><span class="line">        List&lt;URL&gt; providerURLs = categoryUrls.getOrDefault(PROVIDERS_CATEGORY, Collections.emptyList());</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 3.x added for extend URL address</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ExtensionLoader&lt;AddressListener&gt; addressListenerExtensionLoader = ExtensionLoader.getExtensionLoader(AddressListener.class);</span><br><span class="line">        List&lt;AddressListener&gt; supportedListeners = addressListenerExtensionLoader.getActivateExtension(getUrl(), (String[]) <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (supportedListeners != <span class="keyword">null</span> &amp;&amp; !supportedListeners.isEmpty()) &#123; <span class="comment">// 扩展类，扩展URL</span></span><br><span class="line">            <span class="keyword">for</span> (AddressListener addressListener : supportedListeners) &#123;</span><br><span class="line">                providerURLs = addressListener.notify(providerURLs, getConsumerUrl(),<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 只有categoryUrls中的key是providers，下面的providerURLs才会有值</span></span><br><span class="line"><span class="comment">         * 0 = &#123;URL@4147&#125; &quot;dubbo://127.0.0.1:21881/org.apache.dubbo.demo.DemoService?anyhost=true&amp;application=dubbo-demo-annotation-provider&amp;deprecated=false&amp;dubbo=2.0.2&amp;dynamic=true&amp;generic=false&amp;group=jianghe-group&amp;interface=org.apache.dubbo.demo.DemoService&amp;loadbalance=leastactive&amp;methods=sayHello,sayHelloAsync&amp;pid=17908&amp;release=&amp;revision=1.0.0&amp;side=provider&amp;timeout=1000&amp;timestamp=1644205565914&amp;version=1.0.0&quot;</span></span><br><span class="line"><span class="comment">         * 1 = &#123;URL@4148&#125; &quot;dubbo://127.0.0.1:21880/org.apache.dubbo.demo.DemoService?anyhost=true&amp;application=dubbo-demo-annotation-provider&amp;deprecated=false&amp;dubbo=2.0.2&amp;dynamic=true&amp;generic=false&amp;group=jianghe-group&amp;interface=org.apache.dubbo.demo.DemoService&amp;loadbalance=leastactive&amp;methods=sayHello,sayHelloAsync&amp;pid=17908&amp;release=&amp;revision=1.0.0&amp;side=provider&amp;timeout=5000&amp;timestamp=1644205564950&amp;version=1.0.0&quot;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        refreshOverrideAndInvoker(providerURLs);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li>配置更新这块不细说了，有时间可以再看，我们详细看下refreshInvoker(urls)，这个的urls就是<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0 = &#123;URL@4147&#125; &quot;dubbo://127.0.0.1:21881/org.apache.dubbo.demo.DemoService?anyhost=true&amp;application=dubbo-demo-annotation-provider&amp;deprecated=false&amp;dubbo=2.0.2&amp;dynamic=true&amp;generic=false&amp;group=jianghe-group&amp;interface=org.apache.dubbo.demo.DemoService&amp;loadbalance=leastactive&amp;methods=sayHello,sayHelloAsync&amp;pid=17908&amp;release=&amp;revision=1.0.0&amp;side=provider&amp;timeout=1000&amp;timestamp=1644205565914&amp;version=1.0.0&quot;</span><br><span class="line">1 = &#123;URL@4148&#125; &quot;dubbo://127.0.0.1:21880/org.apache.dubbo.demo.DemoService?anyhost=true&amp;application=dubbo-demo-annotation-provider&amp;deprecated=false&amp;dubbo=2.0.2&amp;dynamic=true&amp;generic=false&amp;group=jianghe-group&amp;interface=org.apache.dubbo.demo.DemoService&amp;loadbalance=leastactive&amp;methods=sayHello,sayHelloAsync&amp;pid=17908&amp;release=&amp;revision=1.0.0&amp;side=provider&amp;timeout=5000&amp;timestamp=1644205564950&amp;version=1.0.0&quot;</span><br></pre></td></tr></table></figure>
其中toInvokers就是url转Invoker，routerChain.setInvokers(newInvokers)这个是完善TagRouter，TagRouter需要服务提供者名称来配置规则，就是获取到提供者的URL上才能解析标签路由<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Convert the invokerURL list to the Invoker Map. The rules of the conversion are as follows:</span></span><br><span class="line"><span class="comment">     * &lt;ol&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt; If URL has been converted to invoker, it is no longer re-referenced and obtained directly from the cache,</span></span><br><span class="line"><span class="comment">     * and notice that any parameter changes in the URL will be re-referenced.&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;If the incoming invoker list is not empty, it means that it is the latest invoker list.&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;If the list of incoming invokerUrl is empty, It means that the rule is only a override rule or a route</span></span><br><span class="line"><span class="comment">     * rule, which needs to be re-contrasted to decide whether to re-reference.&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;/ol&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> invokerUrls this parameter can&#x27;t be null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 2017/8/31 FIXME The thread pool should be used to refresh the address, otherwise the task may be accumulated.</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refreshInvoker</span><span class="params">(List&lt;URL&gt; invokerUrls)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(invokerUrls, <span class="string">&quot;invokerUrls should not be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (invokerUrls.size() == <span class="number">1</span></span><br><span class="line">                &amp;&amp; invokerUrls.get(<span class="number">0</span>) != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; EMPTY_PROTOCOL.equals(invokerUrls.get(<span class="number">0</span>).getProtocol())) &#123;</span><br><span class="line">            <span class="keyword">this</span>.forbidden = <span class="keyword">true</span>; <span class="comment">// Forbid to access</span></span><br><span class="line">            <span class="keyword">this</span>.invokers = Collections.emptyList();</span><br><span class="line">            routerChain.setInvokers(<span class="keyword">this</span>.invokers);</span><br><span class="line">            destroyAllInvokers(); <span class="comment">// Close all invokers</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 这里例子是2个，就走复杂逻辑</span></span><br><span class="line">            <span class="keyword">this</span>.forbidden = <span class="keyword">false</span>; <span class="comment">// Allow to access</span></span><br><span class="line">            Map&lt;String, Invoker&lt;T&gt;&gt; oldUrlInvokerMap = <span class="keyword">this</span>.urlInvokerMap; <span class="comment">// local reference</span></span><br><span class="line">            <span class="keyword">if</span> (invokerUrls == Collections.&lt;URL&gt;emptyList()) &#123;</span><br><span class="line">                invokerUrls = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (invokerUrls.isEmpty() &amp;&amp; <span class="keyword">this</span>.cachedInvokerUrls != <span class="keyword">null</span>) &#123;</span><br><span class="line">                invokerUrls.addAll(<span class="keyword">this</span>.cachedInvokerUrls);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.cachedInvokerUrls = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">                <span class="keyword">this</span>.cachedInvokerUrls.addAll(invokerUrls);<span class="comment">//Cached invoker urls, convenient for comparison</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (invokerUrls.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 根据提供者的url来转换Invoker</span></span><br><span class="line"><span class="comment">             * 从这里构造的Invoker里面是包含Filter链的，主要是在protocol.refer(serviceType, url)里面构建的</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            Map&lt;String, Invoker&lt;T&gt;&gt; newUrlInvokerMap = toInvokers(invokerUrls);<span class="comment">// Translate url list to Invoker map</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * If the calculation is wrong, it is not processed.</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * 1. The protocol configured by the client is inconsistent with the protocol of the server.</span></span><br><span class="line"><span class="comment">             *    eg: consumer protocol = dubbo, provider only has other protocol services(rest).</span></span><br><span class="line"><span class="comment">             * 2. The registration center is not robust and pushes illegal specification data.</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (CollectionUtils.isEmptyMap(newUrlInvokerMap)) &#123;</span><br><span class="line">                logger.error(<span class="keyword">new</span> IllegalStateException(<span class="string">&quot;urls to invokers error .invokerUrls.size :&quot;</span> + invokerUrls.size() + <span class="string">&quot;, invoker.size :0. urls :&quot;</span> + invokerUrls</span><br><span class="line">                        .toString()));</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            List&lt;Invoker&lt;T&gt;&gt; newInvokers = Collections.unmodifiableList(<span class="keyword">new</span> ArrayList&lt;&gt;(newUrlInvokerMap.values()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// pre-route and build cache, notice that route cache should build on original Invoker list.</span></span><br><span class="line">            <span class="comment">// toMergeMethodInvokerMap() will wrap some invokers having different groups, those wrapped invokers not should be routed.</span></span><br><span class="line">            routerChain.setInvokers(newInvokers); <span class="comment">// 这里是TagRoute调用</span></span><br><span class="line">            <span class="keyword">this</span>.invokers = multiGroup ? toMergeInvokerList(newInvokers) : newInvokers;</span><br><span class="line">            <span class="keyword">this</span>.urlInvokerMap = newUrlInvokerMap;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                destroyUnusedInvokers(oldUrlInvokerMap, newUrlInvokerMap); <span class="comment">// Close the unused Invoker</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;destroyUnusedInvokers error. &quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><font color='red'><b>然后调用toInvokers(invokerUrls)根据URL转换成Invoker，得到结果List<Invoker>放入到RegistryDirectory里面</b></font><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Turn urls into invokers, and if url has been refer, will not re-reference.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> urls</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> invokers</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Invoker&lt;T&gt;&gt; toInvokers(List&lt;URL&gt; urls) &#123;</span><br><span class="line">        Map&lt;String, Invoker&lt;T&gt;&gt; newUrlInvokerMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (urls == <span class="keyword">null</span> || urls.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> newUrlInvokerMap;</span><br><span class="line">        &#125;</span><br><span class="line">        Set&lt;String&gt; keys = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        String queryProtocols = <span class="keyword">this</span>.queryMap.get(PROTOCOL_KEY); <span class="comment">// ReferenceBean里面有配置protocol</span></span><br><span class="line">        <span class="comment">// 遍历当前所有的提供者服务</span></span><br><span class="line">        <span class="keyword">for</span> (URL providerUrl : urls) &#123;</span><br><span class="line">            <span class="comment">// If protocol is configured at the reference side, only the matching protocol is selected</span></span><br><span class="line">            <span class="keyword">if</span> (queryProtocols != <span class="keyword">null</span> &amp;&amp; queryProtocols.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> accept = <span class="keyword">false</span>;</span><br><span class="line">                String[] acceptProtocols = queryProtocols.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (String acceptProtocol : acceptProtocols) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (providerUrl.getProtocol().equals(acceptProtocol)) &#123;</span><br><span class="line">                        accept = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!accept) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (EMPTY_PROTOCOL.equals(providerUrl.getProtocol())) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!ExtensionLoader.getExtensionLoader(Protocol.class).hasExtension(providerUrl.getProtocol())) &#123; <span class="comment">// 扩展</span></span><br><span class="line">                logger.error(<span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Unsupported protocol &quot;</span> + providerUrl.getProtocol() +</span><br><span class="line">                        <span class="string">&quot; in notified url: &quot;</span> + providerUrl + <span class="string">&quot; from registry &quot;</span> + getUrl().getAddress() +</span><br><span class="line">                        <span class="string">&quot; to consumer &quot;</span> + NetUtils.getLocalHost() + <span class="string">&quot;, supported protocol: &quot;</span> +</span><br><span class="line">                        ExtensionLoader.getExtensionLoader(Protocol.class).getSupportedExtensions()));</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 根据当前提供者的url来获取最终的url</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            URL url = mergeUrl(providerUrl);</span><br><span class="line"></span><br><span class="line">            String key = url.toFullString(); <span class="comment">// The parameter urls are sorted</span></span><br><span class="line">            <span class="keyword">if</span> (keys.contains(key)) &#123; <span class="comment">// Repeated url</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            keys.add(key);</span><br><span class="line">            <span class="comment">// Cache key is url that does not merge with consumer side parameters, regardless of how the consumer combines parameters, if the server url changes, then refer again</span></span><br><span class="line">            Map&lt;String, Invoker&lt;T&gt;&gt; localUrlInvokerMap = <span class="keyword">this</span>.urlInvokerMap; <span class="comment">// local reference</span></span><br><span class="line">            Invoker&lt;T&gt; invoker = localUrlInvokerMap == <span class="keyword">null</span> ? <span class="keyword">null</span> : localUrlInvokerMap.get(key);</span><br><span class="line">            <span class="keyword">if</span> (invoker == <span class="keyword">null</span>) &#123; <span class="comment">// Not in the cache, refer again</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">boolean</span> enabled = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (url.hasParameter(DISABLED_KEY)) &#123;</span><br><span class="line">                        enabled = !url.getParameter(DISABLED_KEY, <span class="keyword">false</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        enabled = url.getParameter(ENABLED_KEY, <span class="keyword">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">                        <span class="comment">/**</span></span><br><span class="line"><span class="comment">                         * 这里就会调用DubboProtocol.refer，里面当然肯定会有Wrapper类，非常重要</span></span><br><span class="line"><span class="comment">                         * RegistryDirectory$InvokerDelegate -&gt;</span></span><br><span class="line"><span class="comment">                         *  ListenerInvokerWrapper -&gt;</span></span><br><span class="line"><span class="comment">                         *      Invoker$0(ConsumerContextFilter)</span></span><br><span class="line"><span class="comment">                         *      Invoker$1(FutureFilter)</span></span><br><span class="line"><span class="comment">                         *      Invoker$2(MonitorFilter) -&gt;</span></span><br><span class="line"><span class="comment">                         *                               AsyncToSyncInvoker -&gt;</span></span><br><span class="line"><span class="comment">                         *                                  DubboInvoker</span></span><br><span class="line"><span class="comment">                         *</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line">                        invoker = <span class="keyword">new</span> InvokerDelegate&lt;&gt;(protocol.refer(serviceType, url), url, providerUrl);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    logger.error(<span class="string">&quot;Failed to refer invoker for interface:&quot;</span> + serviceType + <span class="string">&quot;,url:(&quot;</span> + url + <span class="string">&quot;)&quot;</span> + t.getMessage(), t);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (invoker != <span class="keyword">null</span>) &#123; <span class="comment">// Put new invoker in cache</span></span><br><span class="line">                    newUrlInvokerMap.put(key, invoker);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                newUrlInvokerMap.put(key, invoker);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        keys.clear();</span><br><span class="line">        <span class="keyword">return</span> newUrlInvokerMap;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li>调用mergeUrl(providerUrl)来获取最终的URL，这里providerUrl是提供者url<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Merge url parameters. the order is: override &gt; -D &gt;Consumer &gt; Provider</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> providerUrl</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> URL <span class="title">mergeUrl</span><span class="params">(URL providerUrl)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ReferenceBean里面的属性</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        providerUrl = ClusterUtils.mergeUrl(providerUrl, queryMap); <span class="comment">// Merge the consumer side parameters</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 动态配置</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        providerUrl = overrideWithConfigurator(providerUrl);</span><br><span class="line">        <span class="comment">// check=false</span></span><br><span class="line">        providerUrl = providerUrl.addParameter(Constants.CHECK_KEY, String.valueOf(<span class="keyword">false</span>)); <span class="comment">// Do not check whether the connection is successful or not, always create Invoker!</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// The combination of directoryUrl and override is at the end of notify, which can&#x27;t be handled here</span></span><br><span class="line">        <span class="keyword">this</span>.overrideDirectoryUrl = <span class="keyword">this</span>.overrideDirectoryUrl.addParametersIfAbsent(providerUrl.getParameters()); <span class="comment">// Merge the provider side parameters</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((providerUrl.getPath() == <span class="keyword">null</span> || providerUrl.getPath()</span><br><span class="line">                .length() == <span class="number">0</span>) &amp;&amp; DUBBO_PROTOCOL.equals(providerUrl.getProtocol())) &#123; <span class="comment">// Compatible version 1.0</span></span><br><span class="line">            <span class="comment">//fix by tony.chenl DUBBO-44</span></span><br><span class="line">            String path = directoryUrl.getParameter(INTERFACE_KEY);</span><br><span class="line">            <span class="keyword">if</span> (path != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> i = path.indexOf(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">                <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    path = path.substring(i + <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                i = path.lastIndexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">                <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    path = path.substring(<span class="number">0</span>, i);</span><br><span class="line">                &#125;</span><br><span class="line">                providerUrl = providerUrl.setPath(path);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> providerUrl;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> URL <span class="title">overrideWithConfigurator</span><span class="params">(URL providerUrl)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 老版本动态配置</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// override url with configurator from &quot;override://&quot; URL for dubbo 2.6 and before</span></span><br><span class="line">        providerUrl = overrideWithConfigurators(<span class="keyword">this</span>.configurators, providerUrl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 新版本应用动态配置</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// override url with configurator from configurator from &quot;app-name.configurators&quot;</span></span><br><span class="line">        providerUrl = overrideWithConfigurators(CONSUMER_CONFIGURATION_LISTENER.getConfigurators(), providerUrl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 新版本服务动态配置</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// override url with configurator from configurators from &quot;service-name.configurators&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (serviceConfigurationListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            providerUrl = overrideWithConfigurators(serviceConfigurationListener.getConfigurators(), providerUrl);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> providerUrl;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><code>new InvokerDelegate&lt;&gt;(protocol.refer(serviceType, url), url, providerUrl)</code>其中<code>protocol.refer(serviceType, url)</code>会获取到Invoker，然后将结果作为属性创建InvokerDelegate，直接返回</li>
<li><font color='red'><b>protocol.refer(serviceType, url)这里的protocol是DubboProtocol，这里同样会经过Wrapper类，ProtocolFilterWrapper、ProtocolListenerWrapper调用后，最终会调用DubboProtocol.refer，逻辑和服务导出有点类似，这里直接出结果，不仔细描述，可以跟着代码走一下</b></font></li>
<li>那最终得到的Invoker是什么？</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RegistryDirectory$InvokerDelegate -&gt;</span><br><span class="line">    ListenerInvokerWrapper -&gt;</span><br><span class="line">        ProtocolFilterWrapper$Invoker(Invoker$<span class="number">0</span>(ConsumerContextFilter) -&gt; Invoker$<span class="number">1</span>(FutureFilter) -&gt; Invoker$<span class="number">2</span>(MonitorFilter)) -&gt;</span><br><span class="line">           AsyncToSyncInvoker -&gt;</span><br><span class="line">                DubboInvoker</span><br></pre></td></tr></table></figure>
<h2 id="DubboInvoker"><a href="#DubboInvoker" class="headerlink" title="DubboInvoker"></a>DubboInvoker</h2><p>构建DubboInvoker，底层会构建client，构建client也会启动netty，详细可看下面流程图。<br><font color='red'><b>和服务导出的时候类似，客户端也会有从服务端返回数据过来，这里也有handler处理<br>NettyClientHandler -&gt; NettyClient -&gt; MultiMessageHandler -&gt; HeartbeatHandler -&gt; AllChannelHandler -&gt; DecodeHandler -&gt; HeaderExchangeHandler -&gt; DubboProtocol$ExchangeHandlerAdapter<br>里面除了NettyClientHandler -&gt; NettyClient（AbstractPeer#received）和服务端不一样，其他的handler和服务导出导出一样，但是仔细看下代码，发现消费者handler和服务者handler是一样的<br></b></font></p>
<p>流程图<br><img src="/images/dubbo-6-4.png" alt="DubboInvoker" loading="lazy"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractProtocol</span> <span class="keyword">implements</span> <span class="title">Protocol</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; type, URL url)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncToSyncInvoker&lt;&gt;(protocolBindingRefer(type, url));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboProtocol</span> <span class="keyword">extends</span> <span class="title">AbstractProtocol</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">protocolBindingRefer</span><span class="params">(Class&lt;T&gt; serviceType, URL url)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">        optimizeSerialization(url);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// create rpc invoker.</span></span><br><span class="line">        DubboInvoker&lt;T&gt; invoker = <span class="keyword">new</span> DubboInvoker&lt;T&gt;(serviceType, url, getClients(url), invokers);</span><br><span class="line">        invokers.add(invoker);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> invoker;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ol>
<li>ReferenceBean.get()获取代理类</li>
<li>如果调用方法，直接调用到InvokerInvocationHandler</li>
<li>其中的Invoker其实是下面的<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">MockClusterInvoker -&gt;</span><br><span class="line">    AbstractCluster$Interceptor</span><br><span class="line">        FailoverClusterInvoker -&gt;</span><br><span class="line">            RegistryDirectory -&gt;</span><br><span class="line">                路由</span><br><span class="line">                List&lt;RegistryDirectory$InvokerDelegate&gt;</span><br><span class="line">                负载</span><br><span class="line">                    RegistryDirectory$InvokerDelegate</span><br><span class="line">                        ListenerInvokerWrapper -&gt;</span><br><span class="line">                            ProtocolFilterWrapper$Invoker(Invoker$0(ConsumerContextFilter) -&gt; Invoker$1(FutureFilter) -&gt; Invoker$2(MonitorFilter)) -&gt;</span><br><span class="line">                                AsyncToSyncInvoker -&gt;</span><br><span class="line">                                    DubboInvoker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1. MockClusterInvoker：完成mock功能</span><br><span class="line">2. FailoverClusterInvoker：完成集群容错功能，重试功能</span><br><span class="line">3. ProtocolFilterWrapper$Invoker：完成对filter调用</span><br><span class="line">4. DubboInvoker：通过dubbo协议发送数据</span><br></pre></td></tr></table></figure></li>
<li>NettyClient连接，发送请求返回（这块调用的时候仔细看下）</li>
</ol>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p>见源码：<a target="_blank" rel="noopener" href="https://github.com/tahw/dubbo">https://github.com/tahw/dubbo</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/dubbo/" rel="tag"># dubbo</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/01/18/dubbo%E4%B9%8B%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1%E8%AF%A6%E8%A7%A3/" rel="prev" title="dubbo之导出服务详解">
                  <i class="fa fa-chevron-left"></i> dubbo之导出服务详解
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/02/11/dubbo%E4%B9%8B%E8%B0%83%E7%94%A8%E8%AF%A6%E8%A7%A3/" rel="next" title="dubbo之调用详解">
                  dubbo之调用详解 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李俊龙</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
