<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"theme-next.js.org","root":"/","images":"/images","scheme":"Gemini","version":"8.6.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="dubbo之与spring整合源码问题 dubbo怎么启动服务来监听的？ dubbo怎么生成代理类？ dubbo怎么注册服务的？  内容带着上面的问题，我们通过下面要描述的内容来解释  dubbo里面的properties文件解析 dubbo里面的@Service解析 dubbo里面的@Reference解析  前言这里描述下前言，dubbo和spring整合源码，这里会有大量设计到spring知">
<meta property="og:type" content="article">
<meta property="og:title" content="dubbo之与spring整合源码">
<meta property="og:url" content="https://theme-next.js.org/2022/01/10/dubbo%E4%B9%8B%E4%B8%8Espring%E6%95%B4%E5%90%88%E6%BA%90%E7%A0%81/index.html">
<meta property="og:site_name" content="天真有邪">
<meta property="og:description" content="dubbo之与spring整合源码问题 dubbo怎么启动服务来监听的？ dubbo怎么生成代理类？ dubbo怎么注册服务的？  内容带着上面的问题，我们通过下面要描述的内容来解释  dubbo里面的properties文件解析 dubbo里面的@Service解析 dubbo里面的@Reference解析  前言这里描述下前言，dubbo和spring整合源码，这里会有大量设计到spring知">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://theme-next.js.org/images/dubbo-4-1.png">
<meta property="og:image" content="https://theme-next.js.org/images/dubbo-4-2.png">
<meta property="og:image" content="https://theme-next.js.org/images/dubbo-4-3.png">
<meta property="og:image" content="https://theme-next.js.org/images/dubbo-4-4.png">
<meta property="og:image" content="https://theme-next.js.org/images/dubbo-4-4-%E7%BB%AD.png">
<meta property="article:published_time" content="2022-01-10T07:40:12.000Z">
<meta property="article:modified_time" content="2022-04-13T02:09:05.240Z">
<meta property="article:author" content="李俊龙">
<meta property="article:tag" content="dubbo">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://theme-next.js.org/images/dubbo-4-1.png">


<link rel="canonical" href="https://theme-next.js.org/2022/01/10/dubbo%E4%B9%8B%E4%B8%8Espring%E6%95%B4%E5%90%88%E6%BA%90%E7%A0%81/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://theme-next.js.org/2022/01/10/dubbo%E4%B9%8B%E4%B8%8Espring%E6%95%B4%E5%90%88%E6%BA%90%E7%A0%81/","path":"2022/01/10/dubbo之与spring整合源码/","title":"dubbo之与spring整合源码"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>dubbo之与spring整合源码 | 天真有邪</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">天真有邪</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-summaries"><a href="/summaries/" rel="section"><i class="fa fa-calendar fa-fw"></i>总结</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#dubbo%E4%B9%8B%E4%B8%8Espring%E6%95%B4%E5%90%88%E6%BA%90%E7%A0%81"><span class="nav-number">1.</span> <span class="nav-text">dubbo之与spring整合源码</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98"><span class="nav-number">1.1.</span> <span class="nav-text">问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AE%B9"><span class="nav-number">1.2.</span> <span class="nav-text">内容</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.3.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%A5%E5%8F%A3"><span class="nav-number">1.4.</span> <span class="nav-text">入口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EnableDubbo"><span class="nav-number">1.5.</span> <span class="nav-text">@EnableDubbo</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#EnableDubboConfig"><span class="nav-number">1.5.1.</span> <span class="nav-text">@EnableDubboConfig</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#DubboConfigConfigurationRegistrar"><span class="nav-number">1.5.1.1.</span> <span class="nav-text">DubboConfigConfigurationRegistrar</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ConfigurationBeanBindingsRegister"><span class="nav-number">1.5.1.1.1.</span> <span class="nav-text">ConfigurationBeanBindingsRegister</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ConfigurationBeanBindingPostProcessor"><span class="nav-number">1.5.1.1.2.</span> <span class="nav-text">ConfigurationBeanBindingPostProcessor</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#DefaultConfigurationBeanBinder"><span class="nav-number">1.5.1.1.3.</span> <span class="nav-text">DefaultConfigurationBeanBinder</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.5.1.2.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DubboComponentScan"><span class="nav-number">1.5.2.</span> <span class="nav-text">@DubboComponentScan</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#DubboComponentScanRegistrar"><span class="nav-number">1.5.2.1.</span> <span class="nav-text">DubboComponentScanRegistrar</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ServiceAnnotationBeanPostProcessor"><span class="nav-number">1.5.2.1.1.</span> <span class="nav-text">ServiceAnnotationBeanPostProcessor</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ServiceBean"><span class="nav-number">1.5.2.1.1.1.</span> <span class="nav-text">ServiceBean</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-1"><span class="nav-number">1.5.2.2.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference%E5%A4%84%E7%90%86"><span class="nav-number">1.6.</span> <span class="nav-text">@Reference处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AbstractAnnotationBeanPostProcessor"><span class="nav-number">1.6.1.</span> <span class="nav-text">AbstractAnnotationBeanPostProcessor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ReferenceAnnotationBeanPostProcessor"><span class="nav-number">1.6.2.</span> <span class="nav-text">ReferenceAnnotationBeanPostProcessor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-2"><span class="nav-number">1.6.3.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%90%8E"><span class="nav-number">1.7.</span> <span class="nav-text">写在最后</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">李俊龙</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">34</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://theme-next.js.org/2022/01/10/dubbo%E4%B9%8B%E4%B8%8Espring%E6%95%B4%E5%90%88%E6%BA%90%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李俊龙">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天真有邪">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          dubbo之与spring整合源码
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-01-10 15:40:12" itemprop="dateCreated datePublished" datetime="2022-01-10T15:40:12+08:00">2022-01-10</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-04-13 10:09:05" itemprop="dateModified" datetime="2022-04-13T10:09:05+08:00">2022-04-13</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/dubbo/" itemprop="url" rel="index"><span itemprop="name">dubbo</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="dubbo之与spring整合源码"><a href="#dubbo之与spring整合源码" class="headerlink" title="dubbo之与spring整合源码"></a>dubbo之与spring整合源码</h1><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ol>
<li>dubbo怎么启动服务来监听的？</li>
<li>dubbo怎么生成代理类？</li>
<li>dubbo怎么注册服务的？</li>
</ol>
<h2 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h2><p>带着上面的问题，我们通过下面要描述的内容来解释</p>
<ol>
<li>dubbo里面的properties文件解析</li>
<li>dubbo里面的@Service解析</li>
<li>dubbo里面的@Reference解析</li>
</ol>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这里描述下前言，dubbo和spring整合源码，这里会有大量设计到spring知识点的内容，如有不懂，可自行学习，如需要介绍的，也会说明。主题还是在dubbo上，请知晓。</p>
<a id="more"></a>
<h2 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h2><p>我们通过dubbo源码的方式来知晓dubbo入口，我们也进一步来理解dubbo源码，下面是dubbo-example例子下面的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext(ProviderConfiguration.class);</span><br><span class="line">        context.start();</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     *  1. 解析下配置</span></span><br><span class="line"><span class="comment">     *  2. 扫描<span class="doctag">@Service</span>注解</span></span><br><span class="line"><span class="comment">     *      * 暴露服务，启动netty</span></span><br><span class="line"><span class="comment">     *  3. 扫描<span class="doctag">@Reference</span>注解</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="meta">@EnableDubbo(scanBasePackages = &quot;org.apache.dubbo.demo.provider&quot;)</span></span><br><span class="line">    <span class="meta">@PropertySource(&quot;classpath:/spring/dubbo-provider.properties&quot;)</span> <span class="comment">// 这个就是读取的配置</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderConfiguration</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> RegistryConfig <span class="title">registryConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            RegistryConfig registryConfig = <span class="keyword">new</span> RegistryConfig();</span><br><span class="line">            registryConfig.setAddress(<span class="string">&quot;zookeeper://127.0.0.1:2181&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> registryConfig;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过上面的代码，我们可知，这里最主要的就是@PropertySource和@EnableDubbo，@PropertySource其实就是将dubbo-provider.properties配置文件的内容加载到spring容器中，Environment这个类就能获取对应的属性，一般就是key、value的键值对，也能通过@Value的方式来获取对应值，而@EnableDubbo其实就是对应启动dubbo相关，可想而知，这个是dubbo里面的重中之重，那我们这就开始我们的探索吧~</p>
<h2 id="EnableDubbo"><a href="#EnableDubbo" class="headerlink" title="@EnableDubbo"></a>@EnableDubbo</h2><p>流程如下<br><img src="/images/dubbo-4-1.png" alt="EnableDubbo流程" loading="lazy"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...省略</span></span><br><span class="line"><span class="meta">@EnableDubboConfig</span></span><br><span class="line"><span class="meta">@DubboComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableDubbo &#123;</span><br><span class="line">    <span class="comment">//...省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>见上面，@EnableDubbo其实有两个比较重要的注解，一个是@EnableDubboConfig，一个是@DubboComponentScan，这两个类也就是我们的入口</p>
<h3 id="EnableDubboConfig"><a href="#EnableDubboConfig" class="headerlink" title="@EnableDubboConfig"></a>@EnableDubboConfig</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(DubboConfigConfigurationRegistrar.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableDubboConfig &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * It indicates whether binding to multiple Spring Beans.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the default value is &lt;code&gt;false&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@revised</span> 2.5.9</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">multiple</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有一个注解@Import，导入<code>DubboConfigConfigurationRegistrar</code>类，作为spring的bean</p>
<h4 id="DubboConfigConfigurationRegistrar"><a href="#DubboConfigConfigurationRegistrar" class="headerlink" title="DubboConfigConfigurationRegistrar"></a>DubboConfigConfigurationRegistrar</h4><p>整体流程<br><img src="/images/dubbo-4-2.png" alt="DubboConfigConfigurationRegistrar" loading="lazy"></p>
<p>这个方法就是注入一些bean到spring容器里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 流程如下</span></span><br><span class="line"><span class="comment"> * `<span class="doctag">@EnableDubbo</span> -&gt; <span class="doctag">@EnableDubboConfig</span> -&gt; <span class="doctag">@import</span>(DubboConfigConfigurationRegistrar)`</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboConfigConfigurationRegistrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        AnnotationAttributes attributes = AnnotationAttributes.fromMap(</span><br><span class="line">                importingClassMetadata.getAnnotationAttributes(EnableDubboConfig.class.getName())); <span class="comment">// 获取@EnableDubboConfig注解的属性</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> multiple = attributes.getBoolean(<span class="string">&quot;multiple&quot;</span>); <span class="comment">// 默认为true</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Single Config Bindings</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * beanName：dubboConfigConfiguration.Single</span></span><br><span class="line"><span class="comment">         * beanClass：DubboConfigConfiguration.Single.class</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        registerBeans(registry, DubboConfigConfiguration.Single.class); <span class="comment">// 注册bean，beanName：</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 默认为true</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (multiple) &#123; <span class="comment">// Since 2.6.6 https://github.com/apache/dubbo/issues/3193</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * beanName：dubboConfigConfiguration.Multiple</span></span><br><span class="line"><span class="comment">             * beanClass：DubboConfigConfiguration.Multiple.class</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            registerBeans(registry, DubboConfigConfiguration.Multiple.class);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Since 2.7.6</span></span><br><span class="line">        registerCommonBeans(registry); <span class="comment">// 注册commonBean</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 注册bean</span></span><br><span class="line"><span class="comment">* annotatedClasses就是DubboConfigConfiguration.Single.class、DubboConfigConfiguration.Multiple.class。还有可能是其他注解，registry就是spring容器，将</span></span><br><span class="line"><span class="comment">* annotatedClasses注册到spring容器里</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerBeans</span><span class="params">(BeanDefinitionRegistry registry, Class&lt;?&gt;... annotatedClasses)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ObjectUtils.isEmpty(annotatedClasses)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Set&lt;Class&lt;?&gt;&gt; classesToRegister = <span class="keyword">new</span> LinkedHashSet&lt;Class&lt;?&gt;&gt;(asList(annotatedClasses));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove all annotated-classes that have been registered</span></span><br><span class="line">    Iterator&lt;Class&lt;?&gt;&gt; iterator = classesToRegister.iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">        Class&lt;?&gt; annotatedClass = iterator.next();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * bean容器里是否存在</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (isPresentBean(registry, annotatedClass)) &#123;</span><br><span class="line">            iterator.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    AnnotatedBeanDefinitionReader reader = <span class="keyword">new</span> AnnotatedBeanDefinitionReader(registry);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(registry.getClass().getSimpleName() + <span class="string">&quot; will register annotated classes : &quot;</span> + asList(annotatedClasses) + <span class="string">&quot; .&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reader.register(classesToRegister.toArray(EMPTY_CLASS_ARRAY)); <span class="comment">// 注册bean</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 注册公共的bean到spring容器，用于后续加载</span></span><br><span class="line"><span class="comment">* 比较重要</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerCommonBeans</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 这里是处理<span class="doctag">@Reference</span>注解</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    <span class="comment">// Since 2.5.7 Register @Reference Annotation Bean Processor as an infrastructure Bean</span></span><br><span class="line">    registerInfrastructureBean(registry, ReferenceAnnotationBeanPostProcessor.BEAN_NAME,</span><br><span class="line">            ReferenceAnnotationBeanPostProcessor.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 设置别名，使用AbstractConfig的id属性</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    <span class="comment">// Since 2.7.4 [Feature] https://github.com/apache/dubbo/issues/5093</span></span><br><span class="line">    registerInfrastructureBean(registry, DubboConfigAliasPostProcessor.BEAN_NAME,</span><br><span class="line">            DubboConfigAliasPostProcessor.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * dubbo启动完成，然后暴露一些其他可扩展，这里可以再看下</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    <span class="comment">// Since 2.7.5 Register DubboLifecycleComponentApplicationListener as an infrastructure Bean</span></span><br><span class="line">    registerInfrastructureBean(registry, DubboLifecycleComponentApplicationListener.BEAN_NAME,</span><br><span class="line">            DubboLifecycleComponentApplicationListener.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * dubbo监听服务，监听spring容器启动完成，这里就会暴露服务，启动netty</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    <span class="comment">// Since 2.7.4 Register DubboBootstrapApplicationListener as an infrastructure Bean</span></span><br><span class="line">    registerInfrastructureBean(registry, DubboBootstrapApplicationListener.BEAN_NAME,</span><br><span class="line">            DubboBootstrapApplicationListener.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 属性填充，设置AbstractConfig 子类配置类的id和name属性</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    <span class="comment">// Since 2.7.6 Register DubboConfigDefaultPropertyValueBeanPostProcessor as an infrastructure Bean</span></span><br><span class="line">    registerInfrastructureBean(registry, DubboConfigDefaultPropertyValueBeanPostProcessor.BEAN_NAME,</span><br><span class="line">            DubboConfigDefaultPropertyValueBeanPostProcessor.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注册<code>DubboConfigConfiguration.Single.class</code>、<code>DubboConfigConfiguration.Multiple.class</code>，然后还有注册一些公共的后置处理器和监听器，这些类都是比较重要的，其中我们可以看到的是<code>ReferenceAnnotationBeanPostProcessor</code>，这个就是处理@Reference注解的，其他可见上面注释</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboConfigConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Single Dubbo &#123;<span class="doctag">@link</span> AbstractConfig Config&#125; Bean Binding</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@EnableConfigurationBeanBindings(&#123;</span></span><br><span class="line"><span class="meta">            @EnableConfigurationBeanBinding(prefix = &quot;dubbo.application&quot;, type = ApplicationConfig.class),</span></span><br><span class="line"><span class="meta">            @EnableConfigurationBeanBinding(prefix = &quot;dubbo.module&quot;, type = ModuleConfig.class),</span></span><br><span class="line"><span class="meta">            @EnableConfigurationBeanBinding(prefix = &quot;dubbo.registry&quot;, type = RegistryConfig.class),</span></span><br><span class="line"><span class="meta">            @EnableConfigurationBeanBinding(prefix = &quot;dubbo.protocol&quot;, type = ProtocolConfig.class),</span></span><br><span class="line"><span class="meta">            @EnableConfigurationBeanBinding(prefix = &quot;dubbo.monitor&quot;, type = MonitorConfig.class),</span></span><br><span class="line"><span class="meta">            @EnableConfigurationBeanBinding(prefix = &quot;dubbo.provider&quot;, type = ProviderConfig.class),</span></span><br><span class="line"><span class="meta">            @EnableConfigurationBeanBinding(prefix = &quot;dubbo.consumer&quot;, type = ConsumerConfig.class),</span></span><br><span class="line"><span class="meta">            @EnableConfigurationBeanBinding(prefix = &quot;dubbo.config-center&quot;, type = ConfigCenterBean.class),</span></span><br><span class="line"><span class="meta">            @EnableConfigurationBeanBinding(prefix = &quot;dubbo.metadata-report&quot;, type = MetadataReportConfig.class),</span></span><br><span class="line"><span class="meta">            @EnableConfigurationBeanBinding(prefix = &quot;dubbo.metrics&quot;, type = MetricsConfig.class),</span></span><br><span class="line"><span class="meta">            @EnableConfigurationBeanBinding(prefix = &quot;dubbo.ssl&quot;, type = SslConfig.class)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Single</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Multiple Dubbo &#123;<span class="doctag">@link</span> AbstractConfig Config&#125; Bean Binding</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@EnableConfigurationBeanBindings(&#123;</span></span><br><span class="line"><span class="meta">            @EnableConfigurationBeanBinding(prefix = &quot;dubbo.applications&quot;, type = ApplicationConfig.class, multiple = true),</span></span><br><span class="line"><span class="meta">            @EnableConfigurationBeanBinding(prefix = &quot;dubbo.modules&quot;, type = ModuleConfig.class, multiple = true),</span></span><br><span class="line"><span class="meta">            @EnableConfigurationBeanBinding(prefix = &quot;dubbo.registries&quot;, type = RegistryConfig.class, multiple = true),</span></span><br><span class="line"><span class="meta">            @EnableConfigurationBeanBinding(prefix = &quot;dubbo.protocols&quot;, type = ProtocolConfig.class, multiple = true),</span></span><br><span class="line"><span class="meta">            @EnableConfigurationBeanBinding(prefix = &quot;dubbo.monitors&quot;, type = MonitorConfig.class, multiple = true),</span></span><br><span class="line"><span class="meta">            @EnableConfigurationBeanBinding(prefix = &quot;dubbo.providers&quot;, type = ProviderConfig.class, multiple = true),</span></span><br><span class="line"><span class="meta">            @EnableConfigurationBeanBinding(prefix = &quot;dubbo.consumers&quot;, type = ConsumerConfig.class, multiple = true),</span></span><br><span class="line"><span class="meta">            @EnableConfigurationBeanBinding(prefix = &quot;dubbo.config-centers&quot;, type = ConfigCenterBean.class, multiple = true),</span></span><br><span class="line"><span class="meta">            @EnableConfigurationBeanBinding(prefix = &quot;dubbo.metadata-reports&quot;, type = MetadataReportConfig.class, multiple = true),</span></span><br><span class="line"><span class="meta">            @EnableConfigurationBeanBinding(prefix = &quot;dubbo.metricses&quot;, type = MetricsConfig.class, multiple = true)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Multiple</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(ConfigurationBeanBindingsRegister.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableConfigurationBeanBindings &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the array of &#123;<span class="doctag">@link</span> EnableConfigurationBeanBinding EnableConfigurationBeanBindings&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    EnableConfigurationBeanBinding[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ConfigurationBeanBindingsRegister"><a href="#ConfigurationBeanBindingsRegister" class="headerlink" title="ConfigurationBeanBindingsRegister"></a>ConfigurationBeanBindingsRegister</h5><p>此类就是对用户配置的properties解析，然后对应配置参数，生成对应的ApplicationConfig bean、ModuleConfig bean等对象，然后这里生产的bean其实是不完全的，因为属性还是空的，什么时候会填充呢？其实生成这些bean的时候其实会绑定一个后置处理器，那就是ConfigurationBeanBindingPostProcessor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 流程</span></span><br><span class="line"><span class="comment"> * `<span class="doctag">@EnableDubbo</span> -&gt; <span class="doctag">@EnableDubboConfig</span> -&gt; <span class="doctag">@import</span>(DubboConfigConfigurationRegistrar) -&gt; 将DubboConfigConfiguration.Single.class、DubboConfigConfiguration.Multiple.class注入到spring bean里，然后会加载上面的注解<span class="doctag">@EnableConfigurationBeanBindings</span> -&gt; <span class="doctag">@import</span>(ConfigurationBeanBindingsRegister)`</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigurationBeanBindingsRegister</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span>, <span class="title">EnvironmentAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ConfigurableEnvironment environment;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这里会进入两次，一次是DubboConfigConfiguration.Single.class的属性，一次是DubboConfigConfiguration.Multiple.class的属性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> importingClassMetadata</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        AnnotationAttributes attributes = AnnotationAttributes.fromMap(</span><br><span class="line">                importingClassMetadata.getAnnotationAttributes(EnableConfigurationBeanBindings.class.getName()));</span><br><span class="line"></span><br><span class="line">        AnnotationAttributes[] annotationAttributes = attributes.getAnnotationArray(<span class="string">&quot;value&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ConfigurationBeanBindingRegistrar registrar = <span class="keyword">new</span> ConfigurationBeanBindingRegistrar();</span><br><span class="line"></span><br><span class="line">        registrar.setEnvironment(environment);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (AnnotationAttributes element : annotationAttributes) &#123;</span><br><span class="line">            registrar.registerConfigurationBeanDefinitions(element, registry);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(Environment environment)</span> </span>&#123;</span><br><span class="line">        Assert.isInstanceOf(ConfigurableEnvironment.class, environment);</span><br><span class="line">        <span class="keyword">this</span>.environment = (ConfigurableEnvironment) environment;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * `<span class="doctag">@EnableDubbo</span> -&gt; <span class="doctag">@EnableDubboConfig</span> -&gt; <span class="doctag">@import</span>(DubboConfigConfigurationRegistrar) -&gt; <span class="doctag">@EnableConfigurationBeanBindings</span> -&gt; <span class="doctag">@EnableConfigurationBeanBinding</span></span></span><br><span class="line"><span class="comment"> * -&gt; <span class="doctag">@import</span>(ConfigurationBeanBindingRegistrar)`</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The &#123;<span class="doctag">@link</span> ImportBeanDefinitionRegistrar&#125; implementation for &#123;<span class="doctag">@link</span> EnableConfigurationBeanBinding <span class="doctag">@EnableConfigurationBinding</span>&#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> &lt;a href=&quot;mailto:mercyblitz@gmail.com&quot;&gt;Mercy&lt;/a&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigurationBeanBindingRegistrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span>, <span class="title">EnvironmentAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> Class ENABLE_CONFIGURATION_BINDING_CLASS = EnableConfigurationBeanBinding.class;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String ENABLE_CONFIGURATION_BINDING_CLASS_NAME = ENABLE_CONFIGURATION_BINDING_CLASS.getName();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Log log = LogFactory.getLog(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ConfigurableEnvironment environment;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这个方法其实没有走，<span class="doctag">@EnableDubbo</span> 注释是没有调用到这里的</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> metadata</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; attributes = metadata.getAnnotationAttributes(ENABLE_CONFIGURATION_BINDING_CLASS_NAME);</span><br><span class="line"></span><br><span class="line">        registerConfigurationBeanDefinitions(attributes, registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * `<span class="doctag">@EnableDubbo</span>` 流程走到这里，会调用这里，但是不是通过ConfigurationBeanBindingRegistrar.registerBeanDefinitions调用过来，是通过ConfigurationBeanBindingsRegister#registerBeanDefinitions调用过来，手动创建ConfigurationBeanBindingRegistrar，然后直接调用registerConfigurationBeanDefinitions方法</span></span><br><span class="line"><span class="comment">     * 那这里还有个问题，其中的environment那是怎么来的？这里也是赋值得来的</span></span><br><span class="line"><span class="comment">     * ConfigurationBeanBindingRegistrar registrar = new ConfigurationBeanBindingRegistrar();</span></span><br><span class="line"><span class="comment">     * registrar.setEnvironment(environment)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> attributes</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerConfigurationBeanDefinitions</span><span class="params">(Map&lt;String, Object&gt; attributes, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * dubbo.application</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String prefix = getRequiredAttribute(attributes, <span class="string">&quot;prefix&quot;</span>);</span><br><span class="line"></span><br><span class="line">        prefix = environment.resolvePlaceholders(prefix);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ApplicationConfig.class</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Class&lt;?&gt; configClass = getRequiredAttribute(attributes, <span class="string">&quot;type&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * false</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">boolean</span> multiple = getAttribute(attributes, <span class="string">&quot;multiple&quot;</span>, valueOf(DEFAULT_MULTIPLE));</span><br><span class="line">        <span class="comment">// true</span></span><br><span class="line">        <span class="keyword">boolean</span> ignoreUnknownFields = getAttribute(attributes, <span class="string">&quot;ignoreUnknownFields&quot;</span>, valueOf(DEFAULT_IGNORE_UNKNOWN_FIELDS));</span><br><span class="line">        <span class="comment">// true</span></span><br><span class="line">        <span class="keyword">boolean</span> ignoreInvalidFields = getAttribute(attributes, <span class="string">&quot;ignoreInvalidFields&quot;</span>, valueOf(DEFAULT_IGNORE_INVALID_FIELDS));</span><br><span class="line"></span><br><span class="line">        registerConfigurationBeans(prefix, configClass, multiple, ignoreUnknownFields, ignoreInvalidFields, registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerConfigurationBeans</span><span class="params">(String prefix, Class&lt;?&gt; configClass, <span class="keyword">boolean</span> multiple,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">boolean</span> ignoreUnknownFields, <span class="keyword">boolean</span> ignoreInvalidFields,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 这里就是获取子属性</span></span><br><span class="line"><span class="comment">         * 以dubbo.application为属性来说，这里返回的就是</span></span><br><span class="line"><span class="comment">         * name -&gt; dubbo-demo-annotation-provider</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Map&lt;String, Object&gt; configurationProperties = PropertySourcesUtils.getSubProperties(environment.getPropertySources(), environment, prefix);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(configurationProperties)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;There is no property for binding to configuration class [&quot;</span> + configClass.getName()</span><br><span class="line">                        + <span class="string">&quot;] within prefix [&quot;</span> + prefix + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 这里是兼容的，如果是单个配置就是spring生成的beanName，如果是多个配置，那就是取的是用户自己配置的</span></span><br><span class="line"><span class="comment">         * dubbo.application.name=dubbo-demo-annotation-provider该配置就是</span></span><br><span class="line"><span class="comment">         * beanName：org.apache.dubbo.config.ApplicationConfig#0</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * dubbo.protocols.p1.name=dubbo</span></span><br><span class="line"><span class="comment">         * dubbo.protocols.p1.port=20880</span></span><br><span class="line"><span class="comment">         * dubbo.protocols.p1.host=0.0.0.0</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * dubbo.protocols.p2.name=dubbo</span></span><br><span class="line"><span class="comment">         * dubbo.protocols.p2.port=20881</span></span><br><span class="line"><span class="comment">         * dubbo.protocols.p2.host=0.0.0.0</span></span><br><span class="line"><span class="comment">         * beanName：p1 | p2</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Set&lt;String&gt; beanNames = multiple ? resolveMultipleBeanNames(configurationProperties) :</span><br><span class="line">                singleton(resolveSingleBeanName(configurationProperties, configClass, registry));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 这里就是根据beanName，class来注册到spring容器里，这里是有一个问题的，这里的属性其实是没有填充的</span></span><br><span class="line"><span class="comment">             * 那什么时候填充呢？通过后置处理器来填充ConfigurationBeanBindingPostProcessor</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            registerConfigurationBean(beanName, configClass, multiple, ignoreUnknownFields, ignoreInvalidFields,</span><br><span class="line">                    configurationProperties, registry);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 这里增加一个后置处理器来绑定，这里注册就是ConfigurationBeanBindingPostProcessor，这里虽然会多次调用，但是只是会注册一次</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        registerConfigurationBindingBeanPostProcessor(registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerConfigurationBean</span><span class="params">(String beanName, Class&lt;?&gt; configClass, <span class="keyword">boolean</span> multiple,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           <span class="keyword">boolean</span> ignoreUnknownFields, <span class="keyword">boolean</span> ignoreInvalidFields,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           Map&lt;String, Object&gt; configurationProperties,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        BeanDefinitionBuilder builder = rootBeanDefinition(configClass);</span><br><span class="line"></span><br><span class="line">        AbstractBeanDefinition beanDefinition = builder.getBeanDefinition();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 这里绑定真正的属性的时候就会起到作用了</span></span><br><span class="line"><span class="comment">         * 将改bd的source属性设置为EnableConfigurationBeanBinding.class</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        setSource(beanDefinition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 获取全部属性</span></span><br><span class="line"><span class="comment">         * 只有multiple为true的时候，才会去解析，为false的时候直接就返回configurationProperties</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Map&lt;String, Object&gt; subProperties = resolveSubProperties(multiple, beanName, configurationProperties);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置BeanDefinition的属性</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        initBeanMetadataAttributes(beanDefinition, subProperties, ignoreUnknownFields, ignoreInvalidFields);</span><br><span class="line"></span><br><span class="line">        registry.registerBeanDefinition(beanName, beanDefinition);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;The configuration bean definition [name : &quot;</span> + beanName + <span class="string">&quot;, content : &quot;</span> + beanDefinition</span><br><span class="line">                    + <span class="string">&quot;] has been registered.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ConfigurationBeanBindingPostProcessor"><a href="#ConfigurationBeanBindingPostProcessor" class="headerlink" title="ConfigurationBeanBindingPostProcessor"></a>ConfigurationBeanBindingPostProcessor</h5><p>这是一个后置处理器，里面就是属性绑定，这里有个逻辑，判断是bd source属性为EnableConfigurationBeanBinding.class，并不会全部处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigurationBeanBindingPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span>, <span class="title">BeanFactoryAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">        BeanDefinition beanDefinition = getNullableBeanDefinition(beanName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isConfigurationBean(bean, beanDefinition)) &#123;</span><br><span class="line">            bindConfigurationBean(bean, beanDefinition);</span><br><span class="line">            customize(beanName, bean); <span class="comment">// TODO 通用配置，底层调用没有进行什么逻辑</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bindConfigurationBean</span><span class="params">(Object configurationBean, BeanDefinition beanDefinition)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * name -&gt; dubbo-demo-annotation-provider</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Map&lt;String, Object&gt; configurationProperties = getConfigurationProperties(beanDefinition);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * true</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">boolean</span> ignoreUnknownFields = getIgnoreUnknownFields(beanDefinition);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * true</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">boolean</span> ignoreInvalidFields = getIgnoreInvalidFields(beanDefinition);</span><br><span class="line"></span><br><span class="line">        getConfigurationBeanBinder().bind(configurationProperties, ignoreUnknownFields, ignoreInvalidFields, configurationBean);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;The configuration bean [&quot;</span> + configurationBean + <span class="string">&quot;] have been binding by the &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;configuration properties [&quot;</span> + configurationProperties + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="DefaultConfigurationBeanBinder"><a href="#DefaultConfigurationBeanBinder" class="headerlink" title="DefaultConfigurationBeanBinder"></a>DefaultConfigurationBeanBinder</h5><p>这个是采用的spring的databinder技术，properties属性是key-value里面，DataBinder技术就是key和属性比较，如果匹配，就会赋值</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">dubbo.application.name</span>=<span class="string">dubbo-demo-annotation-provider  </span></span><br></pre></td></tr></table></figure>
<p>ApplicationConfig配置，其中name属性就是dubbo-demo-annotation-provider</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">dubbo.protocols.p1.name</span>=<span class="string">dubbo</span></span><br><span class="line"><span class="meta">dubbo.protocols.p1.port</span>=<span class="string">20880</span></span><br><span class="line"><span class="meta">dubbo.protocols.p1.host</span>=<span class="string">0.0.0.0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">dubbo.protocols.p2.name</span>=<span class="string">dubbo</span></span><br><span class="line"><span class="meta">dubbo.protocols.p2.port</span>=<span class="string">20881</span></span><br><span class="line"><span class="meta">dubbo.protocols.p2.host</span>=<span class="string">0.0.0.0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ProtocolConfig配置，这里是两个bean对象，beanName分别是p1和p2，对应name、port、host里面值</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p><font color='red'><b>@EnableDubboConfig就是对properties属性解析，然后根据属性来生成对象bean，然后注册一些后置处理器和监听器，用于后续使用</b></font></p>
<h3 id="DubboComponentScan"><a href="#DubboComponentScan" class="headerlink" title="@DubboComponentScan"></a>@DubboComponentScan</h3><p>流程<br><img src="/images/dubbo-4-3.png" alt="DubboComponentScan整体流程" loading="lazy"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(DubboComponentScanRegistrar.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DubboComponentScan &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Alias for the &#123;<span class="doctag">@link</span> #basePackages()&#125; attribute. Allows for more concise annotation</span></span><br><span class="line"><span class="comment">     * declarations e.g.: &#123;<span class="doctag">@code</span> <span class="doctag">@DubboComponentScan</span>(&quot;org.my.pkg&quot;)&#125; instead of</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> <span class="doctag">@DubboComponentScan</span>(basePackages=&quot;org.my.pkg&quot;)&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the base packages to scan</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Base packages to scan for annotated <span class="doctag">@Service</span> classes. &#123;<span class="doctag">@link</span> #value()&#125; is an</span></span><br><span class="line"><span class="comment">     * alias for (and mutually exclusive with) this attribute.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * Use &#123;<span class="doctag">@link</span> #basePackageClasses()&#125; for a type-safe alternative to String-based</span></span><br><span class="line"><span class="comment">     * package names.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the base packages to scan</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] basePackages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Type-safe alternative to &#123;<span class="doctag">@link</span> #basePackages()&#125; for specifying the packages to</span></span><br><span class="line"><span class="comment">     * scan for annotated <span class="doctag">@Service</span> classes. The package of each class specified will be</span></span><br><span class="line"><span class="comment">     * scanned.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> classes from the base packages to scan</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Class&lt;?&gt;[] basePackageClasses() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="DubboComponentScanRegistrar"><a href="#DubboComponentScanRegistrar" class="headerlink" title="DubboComponentScanRegistrar"></a>DubboComponentScanRegistrar</h4><p>这里就是注册ServiceAnnotationBeanPostProcessor，然后将配置的路径以构造函数放入对应属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *流程如下</span></span><br><span class="line"><span class="comment"> *`<span class="doctag">@EnableDubbo</span> -&gt; <span class="doctag">@DubboComponentScan</span> -&gt; <span class="doctag">@import</span>(DubboComponentScanRegistrar)`</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboComponentScanRegistrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 路径：org.apache.dubbo.demo.provider</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Set&lt;String&gt; packagesToScan = getPackagesToScan(importingClassMetadata);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 注册ServiceAnnotationBeanPostProcessor.class</span></span><br><span class="line"><span class="comment">         * 设置packagesToScan路径</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        registerServiceAnnotationBeanPostProcessor(packagesToScan, registry);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// @since 2.7.6 Register the common beans</span></span><br><span class="line">        registerCommonBeans(registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Registers &#123;<span class="doctag">@link</span> ServiceAnnotationBeanPostProcessor&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> packagesToScan packages to scan without resolving placeholders</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry       &#123;<span class="doctag">@link</span> BeanDefinitionRegistry&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 2.5.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerServiceAnnotationBeanPostProcessor</span><span class="params">(Set&lt;String&gt; packagesToScan, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        BeanDefinitionBuilder builder = rootBeanDefinition(ServiceAnnotationBeanPostProcessor.class);</span><br><span class="line">        builder.addConstructorArgValue(packagesToScan); <span class="comment">// 构造函数</span></span><br><span class="line">        builder.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">        AbstractBeanDefinition beanDefinition = builder.getBeanDefinition();</span><br><span class="line">        BeanDefinitionReaderUtils.registerWithGeneratedName(beanDefinition, registry);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ServiceAnnotationBeanPostProcessor"><a href="#ServiceAnnotationBeanPostProcessor" class="headerlink" title="ServiceAnnotationBeanPostProcessor"></a>ServiceAnnotationBeanPostProcessor</h5><p><code>ServiceAnnotationBeanPostProcessor</code>这个其实是<code>BeanFactoryPostProcessor</code>，名字有意义，这个是注入bean的。<br>这个作用有两个</p>
<ol>
<li>就是去扫描类上面加了@Service注解，然后将其扫描成spring bean。<ol>
<li>这个扫描器不仅扫描出来一个bd，还会生成额外的ServiceBean类，ServiceBean也会放入到spring中</li>
</ol>
</li>
<li>注入<code>DubboBootstrapApplicationListener</code>，这个类很重要的，这个类是做什么的呢？这个是监听器，但是是spring监听器，监听的是spring容器启动完成，然后开始导出dubbo服务</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceAnnotationBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanDefinitionRegistryPostProcessor</span>, <span class="title">EnvironmentAware</span>,</span></span><br><span class="line"><span class="class">        <span class="title">ResourceLoaderAware</span>, <span class="title">BeanClassLoaderAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这里是什么时机调用呢？这里的名字其实有歧义，如果不仔细看的话，这是一个后置处理器，但是这个ServiceAnnotationBeanPostProcessor这个类其实是BeanFactoryPostProcessor，bean工厂的后置处理器，这个是注册bean的，那BeanPostProcessor是用作什么的，那是加工bean(依赖)</span></span><br><span class="line"><span class="comment">     * 比BeanPostProcessor还要早，但是会比<span class="doctag">@Import</span>类后</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> BeansException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// @since 2.7.5</span></span><br><span class="line">        registerBeans(registry, DubboBootstrapApplicationListener.class);</span><br><span class="line"></span><br><span class="line">        Set&lt;String&gt; resolvedPackagesToScan = resolvePackagesToScan(packagesToScan);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(resolvedPackagesToScan)) &#123;</span><br><span class="line">            registerServiceBeans(resolvedPackagesToScan, registry);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;packagesToScan is empty , ServiceBean registry will be ignored!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Registers Beans whose classes was annotated &#123;<span class="doctag">@link</span> Service&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> packagesToScan The base packages to scan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry       &#123;<span class="doctag">@link</span> BeanDefinitionRegistry&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerServiceBeans</span><span class="params">(Set&lt;String&gt; packagesToScan, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 扫描器，这块继承的ClassPathBeanDefinitionScanner，没有修改什么，设置useDefaultFilters=false(意义在不扫描spring的注解)，只是扫描dubbo的注解</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        DubboClassPathBeanDefinitionScanner scanner =</span><br><span class="line">                <span class="keyword">new</span> DubboClassPathBeanDefinitionScanner(registry, environment, resourceLoader);</span><br><span class="line"></span><br><span class="line">        BeanNameGenerator beanNameGenerator = resolveBeanNameGenerator(registry);</span><br><span class="line"></span><br><span class="line">        scanner.setBeanNameGenerator(beanNameGenerator);</span><br><span class="line"></span><br><span class="line">        scanner.addIncludeFilter(<span class="keyword">new</span> AnnotationTypeFilter(Service.class)); <span class="comment">// 增加扫描类型</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Add the compatibility for legacy Dubbo&#x27;s <span class="doctag">@Service</span></span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * The issue : https://github.com/apache/dubbo/issues/4330</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@since</span> 2.7.3</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        scanner.addIncludeFilter(<span class="keyword">new</span> AnnotationTypeFilter(com.alibaba.dubbo.config.annotation.Service.class));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String packageToScan : packagesToScan) &#123; <span class="comment">// 目录</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Registers @Service Bean first</span></span><br><span class="line">            scanner.scan(packageToScan);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 扫描器，扫描出org.apache.dubbo.config.annotation.Service和com.alibaba.dubbo.config.annotation.Service类</span></span><br><span class="line"><span class="comment">             * 作为spring容器的bean</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="comment">// Finds all BeanDefinitionHolders of @Service whether @ComponentScan scans or not.</span></span><br><span class="line">            Set&lt;BeanDefinitionHolder&gt; beanDefinitionHolders =</span><br><span class="line">                    findServiceBeanDefinitionHolders(scanner, packageToScan, registry, beanNameGenerator);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!CollectionUtils.isEmpty(beanDefinitionHolders)) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 这里需要注意下，这里不仅是注册的DemoServiceImpl，也注册了ServiceBean</span></span><br><span class="line"><span class="comment">                 * 这里ServiceBean的意义在哪？</span></span><br><span class="line"><span class="comment">                 *  1. <span class="doctag">@Service</span> 注解这么多配置，需要放在哪</span></span><br><span class="line"><span class="comment">                 *  2. <span class="doctag">@Service</span> 也是一个服务</span></span><br><span class="line"><span class="comment">                 *  3. 跟原有的接口也有关系，ref关联DemoServiceImpl</span></span><br><span class="line"><span class="comment">                 *  4. 那这里应该有很多ServiceBean，一个被<span class="doctag">@Service</span>注释的类，都会存在，这里就是ByName，class是一致的，但是beanName是不一样的，每个beanName就是</span></span><br><span class="line"><span class="comment">                 *  ServiceAnnotationBeanPostProcessor#generateServiceBeanName生成</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">for</span> (BeanDefinitionHolder beanDefinitionHolder : beanDefinitionHolders) &#123;</span><br><span class="line">                    registerServiceBean(beanDefinitionHolder, registry, scanner);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">                    logger.info(beanDefinitionHolders.size() + <span class="string">&quot; annotated Dubbo&#x27;s @Service Components &#123; &quot;</span> +</span><br><span class="line">                            beanDefinitionHolders +</span><br><span class="line">                            <span class="string">&quot; &#125; were scanned under package[&quot;</span> + packageToScan + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                    logger.warn(<span class="string">&quot;No Spring Bean annotating Dubbo&#x27;s @Service was found under package[&quot;</span></span><br><span class="line">                            + packageToScan + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ServiceBean"><a href="#ServiceBean" class="headerlink" title="ServiceBean"></a>ServiceBean</h6><p>这里的ServiceBean存在的意义，存储@Service注解里面的内容，ServiceBean就是表示一个Dubbo服务。如果要判断本地是否有dubbo service服务，那需要判断spring里面有ServiceBean<br>ServiceBean的beanName：ServiceBean:interfaceClassName:version:group<br>ServiceBean里面有很多属性，例如</p>
<ol>
<li>ref，表示服务的具体实现类 </li>
<li>interface，表示服务的接⼝ </li>
<li>parameters，表示服务的参数（@Service注解中所配置的信息） </li>
<li>application，表示服务所属的应⽤ </li>
<li>protocols，表示服务所使⽤的协议 </li>
<li>registries，表示服务所要注册的注册中⼼</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Registers &#123;<span class="doctag">@link</span> ServiceBean&#125; from new annotated &#123;<span class="doctag">@link</span> Service&#125; &#123;<span class="doctag">@link</span> BeanDefinition&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanDefinitionHolder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> scanner</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ServiceBean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> BeanDefinition</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerServiceBean</span><span class="params">(BeanDefinitionHolder beanDefinitionHolder, BeanDefinitionRegistry registry,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     DubboClassPathBeanDefinitionScanner scanner)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 这里<span class="doctag">@Service</span>扫描出来的类</span></span><br><span class="line"><span class="comment">         * org.apache.dubbo.demo.provider.DemoServiceImpl</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Class&lt;?&gt; beanClass = resolveClass(beanDefinitionHolder);</span><br><span class="line">        <span class="comment">// @Service 注解类</span></span><br><span class="line">        Annotation service = findServiceAnnotation(beanClass);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The &#123;<span class="doctag">@link</span> AnnotationAttributes&#125; of <span class="doctag">@Service</span> annotation</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 获取<span class="doctag">@Service</span>注解的属性</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * &quot;actives&quot; -&gt; &#123;Integer@1955&#125; 0</span></span><br><span class="line"><span class="comment">         * &quot;proxy&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;document&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;export&quot; -&gt; &#123;Boolean@1961&#125; true</span></span><br><span class="line"><span class="comment">         * &quot;stub&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;local&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;executes&quot; -&gt; &#123;Integer@1955&#125; 0</span></span><br><span class="line"><span class="comment">         * &quot;layer&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;sent&quot; -&gt; &#123;Boolean@1970&#125; false</span></span><br><span class="line"><span class="comment">         * &quot;mock&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;async&quot; -&gt; &#123;Boolean@1970&#125; false</span></span><br><span class="line"><span class="comment">         * &quot;retries&quot; -&gt; &#123;Integer@1975&#125; 2</span></span><br><span class="line"><span class="comment">         * &quot;token&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;listener&quot; -&gt; &#123;String[0]@1979&#125; []</span></span><br><span class="line"><span class="comment">         * &quot;tag&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;registry&quot; -&gt; &#123;String[0]@1983&#125; []</span></span><br><span class="line"><span class="comment">         * &quot;delay&quot; -&gt; &#123;Integer@1955&#125; 0</span></span><br><span class="line"><span class="comment">         * &quot;owner&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;monitor&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;cluster&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;timeout&quot; -&gt; &#123;Integer@1955&#125; 0</span></span><br><span class="line"><span class="comment">         * &quot;weight&quot; -&gt; &#123;Integer@1955&#125; 0</span></span><br><span class="line"><span class="comment">         * &quot;module&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;dynamic&quot; -&gt; &#123;Boolean@1961&#125; true</span></span><br><span class="line"><span class="comment">         * &quot;deprecated&quot; -&gt; &#123;Boolean@1970&#125; false</span></span><br><span class="line"><span class="comment">         * &quot;connections&quot; -&gt; &#123;Integer@1955&#125; 0</span></span><br><span class="line"><span class="comment">         * &quot;onconnect&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;ondisconnect&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;callbacks&quot; -&gt; &#123;Integer@2003&#125; 1</span></span><br><span class="line"><span class="comment">         * &quot;loadbalance&quot; -&gt; &quot;random&quot;</span></span><br><span class="line"><span class="comment">         * &quot;validation&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;application&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;interfaceClass&quot; -&gt; &#123;Class@2011&#125; &quot;void&quot;</span></span><br><span class="line"><span class="comment">         * &quot;accesslog&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;interfaceName&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;group&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;cache&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;register&quot; -&gt; &#123;Boolean@1961&#125; true</span></span><br><span class="line"><span class="comment">         * &quot;provider&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;parameters&quot; -&gt; &#123;String[0]@2024&#125; []</span></span><br><span class="line"><span class="comment">         * &quot;path&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;protocol&quot; -&gt; &#123;String[0]@2028&#125; []</span></span><br><span class="line"><span class="comment">         * &quot;filter&quot; -&gt; &#123;String[0]@2030&#125; []</span></span><br><span class="line"><span class="comment">         * &quot;version&quot; -&gt; &quot;&quot;</span></span><br><span class="line"><span class="comment">         * &quot;methods&quot; -&gt; &#123;Method[0]@2034&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        AnnotationAttributes serviceAnnotationAttributes = getAnnotationAttributes(service, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; interfaceClass = resolveServiceInterfaceClass(serviceAnnotationAttributes, beanClass);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * demoServiceImpl</span></span><br><span class="line"><span class="comment">         * 这个有什么作用？</span></span><br><span class="line"><span class="comment">         * 其实是通过这个beanName找到对应的bd，然后通过ref设置其中的属性</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String annotatedServiceBeanName = beanDefinitionHolder.getBeanName();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 构建ServiceBean</span></span><br><span class="line"><span class="comment">         * 这里会将ServiceBean里面操作</span></span><br><span class="line"><span class="comment">         * ref：&lt;demoServiceImpl&gt;</span></span><br><span class="line"><span class="comment">         * interface：org.apache.dubbo.demo.DemoService</span></span><br><span class="line"><span class="comment">         * parameters：null</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        AbstractBeanDefinition serviceBeanDefinition =</span><br><span class="line">                buildServiceBeanDefinition(service, serviceAnnotationAttributes, interfaceClass, annotatedServiceBeanName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ServiceBean:org.apache.dubbo.demo.DemoService</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String beanName = generateServiceBeanName(serviceAnnotationAttributes, interfaceClass);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (scanner.checkCandidate(beanName, serviceBeanDefinition)) &#123; <span class="comment">// check duplicated candidate bean</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 定义org.apache.dubbo.config.annotation.Service的类，定义后也能是spring容器里面的一个类，就能使用<span class="doctag">@Autowired</span>注入到其他类上</span></span><br><span class="line"><span class="comment">             * 该类也是spring容器里面的</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            registry.registerBeanDefinition(beanName, serviceBeanDefinition);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;The BeanDefinition[&quot;</span> + serviceBeanDefinition +</span><br><span class="line">                        <span class="string">&quot;] of ServiceBean has been registered with name : &quot;</span> + beanName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;The Duplicated BeanDefinition[&quot;</span> + serviceBeanDefinition +</span><br><span class="line">                        <span class="string">&quot;] of ServiceBean[ bean name : &quot;</span> + beanName +</span><br><span class="line">                        <span class="string">&quot;] was be found , Did @DubboComponentScan scan to same package in many times?&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h4><ol>
<li>这个类就是扫描@Service类，然后将该对象注入到spring容器，并且会生成对应的ServiceBean放入到spring容器</li>
</ol>
<h2 id="Reference处理"><a href="#Reference处理" class="headerlink" title="@Reference处理"></a>@Reference处理</h2><p><code>ReferenceAnnotationBeanPostProcessor</code>就是处理@Reference，实际我们看的时候，其实需要先去看他的父类<code>AbstractAnnotationBeanPostProcessor</code>，这个类实现MergedBeanDefinitionPostProcessor，是一个BeanPostProcessor。他的入口是postProcessMergedBeanDefinition<br>流程<br><img src="/images/dubbo-4-4.png" alt="ReferenceAnnotationBeanPostProcessor流程" loading="lazy"></p>
<h3 id="AbstractAnnotationBeanPostProcessor"><a href="#AbstractAnnotationBeanPostProcessor" class="headerlink" title="AbstractAnnotationBeanPostProcessor"></a>AbstractAnnotationBeanPostProcessor</h3><p>这个类是@Reference的核心，ReferenceAnnotationBeanPostProcessor继承AbstractAnnotationBeanPostProcessor，其实都是先处理AbstractAnnotationBeanPostProcessor，然后再调用到ReferenceAnnotationBeanPostProcessor。</p>
<p>再将ReferenceAnnotationBeanPostProcessor注入spring容器里，会将AbstractAnnotationBeanPostProcessor里面annotationTypes就@Reference注解</p>
<p>查询属性或者方法上找到注入点，然后就会调用到ReferenceAnnotationBeanPostProcessor的doGetInjectedBean方法得到对象，然后注入到属性对象里面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 这里是和AutowiredAnnotationBeanPostProcessor类似，里面的postProcessPropertyValues和postProcessMergedBeanDefinition方法也是差不多的</span></span><br><span class="line"><span class="comment"> * 所有的bean都会走这里的，只要是spring容器里面的bean，但是所有的bean走到这里，只处理<span class="doctag">@Reference</span>属性注入，而AutowiredAnnotationBeanPostProcessor是只处理<span class="doctag">@Autowired</span>属性</span></span><br><span class="line"><span class="comment"> * 这里需要好好理解下</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractAnnotationBeanPostProcessor</span> <span class="keyword">extends</span></span></span><br><span class="line"><span class="class">        <span class="title">InstantiationAwareBeanPostProcessorAdapter</span> <span class="keyword">implements</span> <span class="title">MergedBeanDefinitionPostProcessor</span>, <span class="title">PriorityOrdered</span>,</span></span><br><span class="line"><span class="class">        <span class="title">BeanFactoryAware</span>, <span class="title">BeanClassLoaderAware</span>, <span class="title">EnvironmentAware</span>, <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> CACHE_SIZE = Integer.getInteger(<span class="string">&quot;&quot;</span>, <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这里的类型是什么时候赋值呢？是在ReferenceAnnotationBeanPostProcessor构造函数</span></span><br><span class="line"><span class="comment">     * Reference.class</span></span><br><span class="line"><span class="comment">     * com.alibaba.dubbo.config.annotation.Reference.class</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;? extends Annotation&gt;[] annotationTypes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, AbstractAnnotationBeanPostProcessor.AnnotatedInjectionMetadata&gt; injectionMetadataCache =</span><br><span class="line">            <span class="keyword">new</span> ConcurrentHashMap&lt;String, AbstractAnnotationBeanPostProcessor.AnnotatedInjectionMetadata&gt;(CACHE_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, Object&gt; injectedObjectsCache = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Object&gt;(CACHE_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ConfigurableListableBeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Environment environment;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ClassLoader classLoader;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * make sure higher priority than &#123;<span class="doctag">@link</span> AutowiredAnnotationBeanPostProcessor&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> order = Ordered.LOWEST_PRECEDENCE - <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> annotationTypes the multiple types of &#123;<span class="doctag">@link</span> Annotation annotations&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbstractAnnotationBeanPostProcessor</span><span class="params">(Class&lt;? extends Annotation&gt;... annotationTypes)</span> </span>&#123;</span><br><span class="line">        Assert.notEmpty(annotationTypes, <span class="string">&quot;The argument of annotations&#x27; types must not empty&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.annotationTypes = annotationTypes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Collection&lt;T&gt; <span class="title">combine</span><span class="params">(Collection&lt;? extends T&gt;... elements)</span> </span>&#123;</span><br><span class="line">        List&lt;T&gt; allElements = <span class="keyword">new</span> ArrayList&lt;T&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Collection&lt;? extends T&gt; e : elements) &#123;</span><br><span class="line">            allElements.addAll(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> allElements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Annotation type</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> non-null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@deprecated</span> 2.7.3, uses &#123;<span class="doctag">@link</span> #getAnnotationTypes()&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Class&lt;? extends Annotation&gt; getAnnotationType() &#123;</span><br><span class="line">        <span class="keyword">return</span> annotationTypes[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Class&lt;? extends Annotation&gt;[] getAnnotationTypes() &#123;</span><br><span class="line">        <span class="keyword">return</span> annotationTypes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        Assert.isInstanceOf(ConfigurableListableBeanFactory.class, beanFactory,</span><br><span class="line">                <span class="string">&quot;AnnotationInjectedBeanPostProcessor requires a ConfigurableListableBeanFactory&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.beanFactory = (ConfigurableListableBeanFactory) beanFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 后置处理器第二步处理这里</span></span><br><span class="line"><span class="comment">     * 填充属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PropertyValues <span class="title">postProcessPropertyValues</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            PropertyValues pvs, PropertyDescriptor[] pds, Object bean, String beanName)</span> <span class="keyword">throws</span> BeanCreationException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 寻找注入点</span></span><br><span class="line"><span class="comment">         * 找一下是否属性有<span class="doctag">@Reference</span>标注的field</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        InjectionMetadata metadata = findInjectionMetadata(beanName, bean.getClass(), pvs);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            metadata.inject(bean, beanName, pvs);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BeanCreationException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(beanName, <span class="string">&quot;Injection of @&quot;</span> + getAnnotationType().getSimpleName()</span><br><span class="line">                    + <span class="string">&quot; dependencies is failed&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pvs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Finds &#123;<span class="doctag">@link</span> InjectionMetadata.InjectedElement&#125; Metadata from annotated fields</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanClass The &#123;<span class="doctag">@link</span> Class&#125; of Bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> non-null &#123;<span class="doctag">@link</span> List&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;AbstractAnnotationBeanPostProcessor.AnnotatedFieldElement&gt; findFieldAnnotationMetadata(<span class="keyword">final</span> Class&lt;?&gt; beanClass) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> List&lt;AbstractAnnotationBeanPostProcessor.AnnotatedFieldElement&gt; elements = <span class="keyword">new</span> LinkedList&lt;AbstractAnnotationBeanPostProcessor.AnnotatedFieldElement&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 找到beanClass里面属性是否有Reference.class和com.alibaba.dubbo.config.annotation.Reference.class属性的字段</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ReflectionUtils.doWithFields(beanClass, <span class="keyword">new</span> ReflectionUtils.FieldCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWith</span><span class="params">(Field field)</span> <span class="keyword">throws</span> IllegalArgumentException, IllegalAccessException </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (Class&lt;? extends Annotation&gt; annotationType : getAnnotationTypes()) &#123;</span><br><span class="line"></span><br><span class="line">                    AnnotationAttributes attributes = getAnnotationAttributes(field, annotationType, getEnvironment(), <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (attributes != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (Modifier.isStatic(field.getModifiers())) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                                logger.warn(<span class="string">&quot;@&quot;</span> + annotationType.getName() + <span class="string">&quot; is not supported on static fields: &quot;</span> + field);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        elements.add(<span class="keyword">new</span> AnnotatedFieldElement(field, attributes));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> elements;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Finds &#123;<span class="doctag">@link</span> InjectionMetadata.InjectedElement&#125; Metadata from annotated methods</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanClass The &#123;<span class="doctag">@link</span> Class&#125; of Bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> non-null &#123;<span class="doctag">@link</span> List&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;AbstractAnnotationBeanPostProcessor.AnnotatedMethodElement&gt; findAnnotatedMethodMetadata(<span class="keyword">final</span> Class&lt;?&gt; beanClass) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> List&lt;AbstractAnnotationBeanPostProcessor.AnnotatedMethodElement&gt; elements = <span class="keyword">new</span> LinkedList&lt;AbstractAnnotationBeanPostProcessor.AnnotatedMethodElement&gt;();</span><br><span class="line"></span><br><span class="line">        ReflectionUtils.doWithMethods(beanClass, <span class="keyword">new</span> ReflectionUtils.MethodCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWith</span><span class="params">(Method method)</span> <span class="keyword">throws</span> IllegalArgumentException, IllegalAccessException </span>&#123;</span><br><span class="line"></span><br><span class="line">                Method bridgedMethod = findBridgedMethod(method);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!isVisibilityBridgeMethodPair(method, bridgedMethod)) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (Class&lt;? extends Annotation&gt; annotationType : getAnnotationTypes()) &#123;</span><br><span class="line"></span><br><span class="line">                    AnnotationAttributes attributes = getAnnotationAttributes(bridgedMethod, annotationType, getEnvironment(), <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (attributes != <span class="keyword">null</span> &amp;&amp; method.equals(ClassUtils.getMostSpecificMethod(method, beanClass))) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                                logger.warn(<span class="string">&quot;@&quot;</span> + annotationType.getName() + <span class="string">&quot; annotation is not supported on static methods: &quot;</span> + method);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (method.getParameterTypes().length == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                                logger.warn(<span class="string">&quot;@&quot;</span> + annotationType.getName() + <span class="string">&quot; annotation should only be used on methods with parameters: &quot;</span> +</span><br><span class="line">                                        method);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, beanClass);</span><br><span class="line">                        elements.add(<span class="keyword">new</span> AnnotatedMethodElement(method, pd, attributes));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> elements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AbstractAnnotationBeanPostProcessor.<span class="function">AnnotatedInjectionMetadata <span class="title">buildAnnotatedMetadata</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; beanClass)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 属性</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Collection&lt;AbstractAnnotationBeanPostProcessor.AnnotatedFieldElement&gt; fieldElements = findFieldAnnotationMetadata(beanClass);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 方法</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Collection&lt;AbstractAnnotationBeanPostProcessor.AnnotatedMethodElement&gt; methodElements = findAnnotatedMethodMetadata(beanClass);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AbstractAnnotationBeanPostProcessor.AnnotatedInjectionMetadata(beanClass, fieldElements, methodElements);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> InjectionMetadata <span class="title">findInjectionMetadata</span><span class="params">(String beanName, Class&lt;?&gt; clazz, PropertyValues pvs)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Fall back to class name as cache key, for backwards compatibility with custom callers.</span></span><br><span class="line">        String cacheKey = (StringUtils.hasLength(beanName) ? beanName : clazz.getName());</span><br><span class="line">        <span class="comment">// Quick check on the concurrent map first, with minimal locking.</span></span><br><span class="line">        AbstractAnnotationBeanPostProcessor.AnnotatedInjectionMetadata metadata = <span class="keyword">this</span>.injectionMetadataCache.get(cacheKey);</span><br><span class="line">        <span class="keyword">if</span> (InjectionMetadata.needsRefresh(metadata, clazz)) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>.injectionMetadataCache) &#123;</span><br><span class="line">                metadata = <span class="keyword">this</span>.injectionMetadataCache.get(cacheKey);</span><br><span class="line">                <span class="keyword">if</span> (InjectionMetadata.needsRefresh(metadata, clazz)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (metadata != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        metadata.clear(pvs);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        metadata = buildAnnotatedMetadata(clazz); <span class="comment">// 构建注入元数据</span></span><br><span class="line">                        <span class="keyword">this</span>.injectionMetadataCache.put(cacheKey, metadata);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (NoClassDefFoundError err) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Failed to introspect object class [&quot;</span> + clazz.getName() +</span><br><span class="line">                                <span class="string">&quot;] for annotation metadata: could not find class that it depends on&quot;</span>, err);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> metadata;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * spring的bean都会走到这里，只不过这里只是处理dubbo的<span class="doctag">@Reference</span>注解的属性注入</span></span><br><span class="line"><span class="comment">     * 后置处理器先是处理这里，在这里校验配置的属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessMergedBeanDefinition</span><span class="params">(RootBeanDefinition beanDefinition, Class&lt;?&gt; beanType, String beanName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (beanType != <span class="keyword">null</span>) &#123;</span><br><span class="line">            InjectionMetadata metadata = findInjectionMetadata(beanName, beanType, <span class="keyword">null</span>);</span><br><span class="line">            metadata.checkConfigMembers(beanDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrder</span><span class="params">(<span class="keyword">int</span> order)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.order = order;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Object object : injectedObjectsCache.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">                logger.info(object + <span class="string">&quot; was destroying!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (object <span class="keyword">instanceof</span> DisposableBean) &#123;</span><br><span class="line">                ((DisposableBean) object).destroy();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        injectionMetadataCache.clear();</span><br><span class="line">        injectedObjectsCache.clear();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">            logger.info(getClass() + <span class="string">&quot; was destroying!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanClassLoader</span><span class="params">(ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.classLoader = classLoader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(Environment environment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.environment = environment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Environment <span class="title">getEnvironment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> environment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ClassLoader <span class="title">getClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> classLoader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ConfigurableListableBeanFactory <span class="title">getBeanFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> beanFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets all injected-objects.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> non-null &#123;<span class="doctag">@link</span> Collection&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Collection&lt;Object&gt; <span class="title">getInjectedObjects</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.injectedObjectsCache.values();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get injected-object from specified &#123;<span class="doctag">@link</span> AnnotationAttributes annotation attributes&#125; and Bean Class</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> attributes      &#123;<span class="doctag">@link</span> AnnotationAttributes the annotation attributes&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean            Current bean that will be injected</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName        Current bean name that will be injected</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> injectedType    the type of injected-object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> injectedElement &#123;<span class="doctag">@link</span> InjectionMetadata.InjectedElement&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> An injected object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception If getting is failed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">getInjectedObject</span><span class="params">(AnnotationAttributes attributes, Object bean, String beanName, Class&lt;?&gt; injectedType,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       InjectionMetadata.InjectedElement injectedElement)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// ServiceBean:org.apache.dubbo.demo.DemoService#source=private org.apache.dubbo.demo.DemoService org.apache.dubbo.demo.consumer.comp.DemoServiceComponent.demoService#attributes=&#123;&#125;</span></span><br><span class="line">        String cacheKey = buildInjectedObjectCacheKey(attributes, bean, beanName, injectedType, injectedElement);</span><br><span class="line"></span><br><span class="line">        Object injectedObject = injectedObjectsCache.get(cacheKey);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (injectedObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">            injectedObject = doGetInjectedBean(attributes, bean, beanName, injectedType, injectedElement);</span><br><span class="line">            <span class="comment">// Customized inject-object if necessary</span></span><br><span class="line">            injectedObjectsCache.putIfAbsent(cacheKey, injectedObject);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> injectedObject;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Subclass must implement this method to get injected-object. The context objects could help this method if</span></span><br><span class="line"><span class="comment">     * necessary :</span></span><br><span class="line"><span class="comment">     * &lt;ul&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;&#123;<span class="doctag">@link</span> #getBeanFactory() BeanFactory&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;&#123;<span class="doctag">@link</span> #getClassLoader() ClassLoader&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;&#123;<span class="doctag">@link</span> #getEnvironment() Environment&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> attributes      &#123;<span class="doctag">@link</span> AnnotationAttributes the annotation attributes&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean            Current bean that will be injected</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName        Current bean name that will be injected</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> injectedType    the type of injected-object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> injectedElement &#123;<span class="doctag">@link</span> InjectionMetadata.InjectedElement&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The injected object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception If resolving an injected object is failed.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Object <span class="title">doGetInjectedBean</span><span class="params">(AnnotationAttributes attributes, Object bean, String beanName, Class&lt;?&gt; injectedType,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                InjectionMetadata.InjectedElement injectedElement)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Build a cache key for injected-object. The context objects could help this method if</span></span><br><span class="line"><span class="comment">     * necessary :</span></span><br><span class="line"><span class="comment">     * &lt;ul&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;&#123;<span class="doctag">@link</span> #getBeanFactory() BeanFactory&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;&#123;<span class="doctag">@link</span> #getClassLoader() ClassLoader&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;&#123;<span class="doctag">@link</span> #getEnvironment() Environment&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> attributes      &#123;<span class="doctag">@link</span> AnnotationAttributes the annotation attributes&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean            Current bean that will be injected</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName        Current bean name that will be injected</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> injectedType    the type of injected-object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> injectedElement &#123;<span class="doctag">@link</span> InjectionMetadata.InjectedElement&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Bean cache key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">buildInjectedObjectCacheKey</span><span class="params">(AnnotationAttributes attributes, Object bean, String beanName,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                          Class&lt;?&gt; injectedType,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                          InjectionMetadata.InjectedElement injectedElement)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get &#123;<span class="doctag">@link</span> Map&#125; in injected field.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> non-null ready-only &#123;<span class="doctag">@link</span> Map&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Map&lt;InjectionMetadata.InjectedElement, Object&gt; getInjectedFieldObjectsMap() &#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;InjectionMetadata.InjectedElement, Object&gt; injectedElementBeanMap =</span><br><span class="line">                <span class="keyword">new</span> LinkedHashMap&lt;InjectionMetadata.InjectedElement, Object&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (AbstractAnnotationBeanPostProcessor.AnnotatedInjectionMetadata metadata : injectionMetadataCache.values()) &#123;</span><br><span class="line"></span><br><span class="line">            Collection&lt;AbstractAnnotationBeanPostProcessor.AnnotatedFieldElement&gt; fieldElements = metadata.getFieldElements();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (AbstractAnnotationBeanPostProcessor.AnnotatedFieldElement fieldElement : fieldElements) &#123;</span><br><span class="line"></span><br><span class="line">                injectedElementBeanMap.put(fieldElement, fieldElement.bean);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Collections.unmodifiableMap(injectedElementBeanMap);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get &#123;<span class="doctag">@link</span> Map&#125; in injected method.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> non-null &#123;<span class="doctag">@link</span> Map&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Map&lt;InjectionMetadata.InjectedElement, Object&gt; getInjectedMethodObjectsMap() &#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;InjectionMetadata.InjectedElement, Object&gt; injectedElementBeanMap =</span><br><span class="line">                <span class="keyword">new</span> LinkedHashMap&lt;InjectionMetadata.InjectedElement, Object&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (AbstractAnnotationBeanPostProcessor.AnnotatedInjectionMetadata metadata : injectionMetadataCache.values()) &#123;</span><br><span class="line"></span><br><span class="line">            Collection&lt;AbstractAnnotationBeanPostProcessor.AnnotatedMethodElement&gt; methodElements = metadata.getMethodElements();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (AbstractAnnotationBeanPostProcessor.AnnotatedMethodElement methodElement : methodElements) &#123;</span><br><span class="line"></span><br><span class="line">                injectedElementBeanMap.put(methodElement, methodElement.object);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Collections.unmodifiableMap(injectedElementBeanMap);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> Annotation Annotated&#125; &#123;<span class="doctag">@link</span> InjectionMetadata&#125; implementation</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotatedInjectionMetadata</span> <span class="keyword">extends</span> <span class="title">InjectionMetadata</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Collection&lt;AbstractAnnotationBeanPostProcessor.AnnotatedFieldElement&gt; fieldElements;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Collection&lt;AbstractAnnotationBeanPostProcessor.AnnotatedMethodElement&gt; methodElements;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AnnotatedInjectionMetadata</span><span class="params">(Class&lt;?&gt; targetClass, Collection&lt;AbstractAnnotationBeanPostProcessor.AnnotatedFieldElement&gt; fieldElements,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          Collection&lt;AbstractAnnotationBeanPostProcessor.AnnotatedMethodElement&gt; methodElements)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(targetClass, combine(fieldElements, methodElements));</span><br><span class="line">            <span class="keyword">this</span>.fieldElements = fieldElements;</span><br><span class="line">            <span class="keyword">this</span>.methodElements = methodElements;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Collection&lt;AbstractAnnotationBeanPostProcessor.AnnotatedFieldElement&gt; getFieldElements() &#123;</span><br><span class="line">            <span class="keyword">return</span> fieldElements;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Collection&lt;AbstractAnnotationBeanPostProcessor.AnnotatedMethodElement&gt; getMethodElements() &#123;</span><br><span class="line">            <span class="keyword">return</span> methodElements;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> Annotation Annotated&#125; &#123;<span class="doctag">@link</span> Method&#125; &#123;<span class="doctag">@link</span> InjectionMetadata.InjectedElement&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotatedMethodElement</span> <span class="keyword">extends</span> <span class="title">InjectionMetadata</span>.<span class="title">InjectedElement</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Method method;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AnnotationAttributes attributes;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> Object object;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">AnnotatedMethodElement</span><span class="params">(Method method, PropertyDescriptor pd, AnnotationAttributes attributes)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(method, pd);</span><br><span class="line">            <span class="keyword">this</span>.method = method;</span><br><span class="line">            <span class="keyword">this</span>.attributes = attributes;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 处理方法中包含注解的属性</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(Object bean, String beanName, PropertyValues pvs)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">            Class&lt;?&gt; injectedType = pd.getPropertyType();</span><br><span class="line"></span><br><span class="line">            Object injectedObject = getInjectedObject(attributes, bean, beanName, injectedType, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">            ReflectionUtils.makeAccessible(method);</span><br><span class="line"></span><br><span class="line">            method.invoke(bean, injectedObject);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> Annotation Annotated&#125; &#123;<span class="doctag">@link</span> Field&#125; &#123;<span class="doctag">@link</span> InjectionMetadata.InjectedElement&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotatedFieldElement</span> <span class="keyword">extends</span> <span class="title">InjectionMetadata</span>.<span class="title">InjectedElement</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Field field;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AnnotationAttributes attributes;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> Object bean;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">AnnotatedFieldElement</span><span class="params">(Field field, AnnotationAttributes attributes)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(field, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.field = field;</span><br><span class="line">            <span class="keyword">this</span>.attributes = attributes;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 处理属性中包含注解</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(Object bean, String beanName, PropertyValues pvs)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">            <span class="comment">// org.apache.dubbo.demo.DemoService</span></span><br><span class="line">            Class&lt;?&gt; injectedType = field.getType();</span><br><span class="line"></span><br><span class="line">            Object injectedObject = getInjectedObject(attributes, bean, beanName, injectedType, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">            ReflectionUtils.makeAccessible(field);</span><br><span class="line"></span><br><span class="line">            field.set(bean, injectedObject);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ReferenceAnnotationBeanPostProcessor"><a href="#ReferenceAnnotationBeanPostProcessor" class="headerlink" title="ReferenceAnnotationBeanPostProcessor"></a>ReferenceAnnotationBeanPostProcessor</h3><p>doGetInjectedBean，这个得到的对象肯定是一个代理对象，有代理逻辑，处理对应的请求<br>流程：<br><img src="/images/dubbo-4-4-%E7%BB%AD.png" alt="getOrCreateProxy" loading="lazy"></p>
<p>处理流程如下：</p>
<ol>
<li>获取referencedBeanName，其实就是ServiceBean的beanName</li>
<li>获取ReferenceBeanName，这个生成规则是@Reference+&quot;(&quot;+注解属性遍历+&quot;)&quot;+&quot; &quot;+接口名，如果没有注解属性，直接就是@Reference+&quot; &quot;+接口名</li>
<li>构建ReferenceBean，跟之前的ServiceBean构建类似，也是把属性填充</li>
<li>注册ReferenceBean，如果是本地服务，将其ServiceBean的ref的bean增加一个别名ReferenceBeanName，否则不是本地服务，直接根据ReferenceBeanName注册bean（怎么判断是否是一个本地服务，根据@Reference注解生成ServiceBean的beanName格式的beanName，然后去spring容器里面判断，如果存在则是本地服务）</li>
<li>创建代理对象，如果这里是本地的服务，是ServiceBean的ref生成的代理类，是由ReferencedBeanInvocationHandler生成的代理类，如果不是本地服务，那就是RefereceBean.get()对象</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 这里是处理<span class="doctag">@Reference</span>的，这里是处理属性依赖的，想比较<span class="doctag">@Service</span>是更加复杂的</span></span><br><span class="line"><span class="comment"> * 这里其实和<span class="doctag">@Autowired</span>比较类似，处理逻辑也是和AutowiredAnnotationBeanPostProcessor比较类似了</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReferenceAnnotationBeanPostProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractAnnotationBeanPostProcessor</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">        <span class="title">ApplicationContextAware</span>, <span class="title">ApplicationListener</span>&lt;<span class="title">ServiceBeanExportedEvent</span>&gt; </span>&#123;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * To support the legacy annotation that is <span class="doctag">@com</span>.alibaba.dubbo.config.annotation.Reference since 2.7.3</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReferenceAnnotationBeanPostProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Reference.class, com.alibaba.dubbo.config.annotation.Reference.class);</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">doGetInjectedBean</span><span class="params">(AnnotationAttributes attributes, Object bean, String beanName, Class&lt;?&gt; injectedType,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       InjectionMetadata.InjectedElement injectedElement)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The name of bean that annotated Dubbo&#x27;s &#123;<span class="doctag">@link</span> Service <span class="doctag">@Service</span>&#125; in local Spring &#123;<span class="doctag">@link</span> ApplicationContext&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * referencedBeanName其实就是serviceBeanName</span></span><br><span class="line"><span class="comment">         * ServiceBean:org.apache.dubbo.demo.DemoService</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String referencedBeanName = buildReferencedBeanName(attributes, injectedType);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The name of bean that is declared by &#123;<span class="doctag">@link</span> Reference <span class="doctag">@Reference</span>&#125; annotation injection</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 这里其实是referenceBeanName：<span class="doctag">@Reference</span> org.apache.dubbo.demo.DemoService</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String referenceBeanName = getReferenceBeanName(attributes, injectedType);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 获取ReferenceBean，这里其实和ServiceBean类似，都是处理<span class="doctag">@Reference</span>的属性</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ReferenceBean referenceBean = buildReferenceBeanIfAbsent(referenceBeanName, attributes, injectedType);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 是否本地服务，怎么判断自己的容器里面是否存在dubbo <span class="doctag">@Service</span>的内容，要判断服务类么？这里肯定是不行的，因为<span class="doctag">@Autowired</span>也是可以获取到的，只能通过ServiceBean的方式来获取，就是独一无二的</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">boolean</span> localServiceBean = isLocalServiceBean(referencedBeanName, referenceBean, attributes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 这里同样的注册ReferenceBean</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        registerReferenceBean(referencedBeanName, referenceBean, attributes, localServiceBean, injectedType);</span><br><span class="line"></span><br><span class="line">        cacheInjectedReferenceBean(referenceBean, injectedElement);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 代理类</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> getOrCreateProxy(referencedBeanName, referenceBean, localServiceBean, injectedType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get or Create a proxy of &#123;<span class="doctag">@link</span> ReferenceBean&#125; for the specified the type of Dubbo service interface</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> referencedBeanName   The name of bean that annotated Dubbo&#x27;s &#123;<span class="doctag">@link</span> Service <span class="doctag">@Service</span>&#125; in the Spring &#123;<span class="doctag">@link</span> ApplicationContext&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> referenceBean        the instance of &#123;<span class="doctag">@link</span> ReferenceBean&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> localServiceBean     Is Local Service bean or not</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceInterfaceType the type of Dubbo service interface</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> non-null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 2.7.4</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">getOrCreateProxy</span><span class="params">(String referencedBeanName, ReferenceBean referenceBean, <span class="keyword">boolean</span> localServiceBean,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    Class&lt;?&gt; serviceInterfaceType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (localServiceBean) &#123; <span class="comment">// If the local @Service Bean exists, build a proxy of Service</span></span><br><span class="line">            <span class="keyword">return</span> newProxyInstance(getClassLoader(), <span class="keyword">new</span> Class[]&#123;serviceInterfaceType&#125;,</span><br><span class="line">                    newReferencedBeanInvocationHandler(referencedBeanName));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            exportServiceBeanIfNecessary(referencedBeanName); <span class="comment">// If the referenced ServiceBean exits, export it immediately</span></span><br><span class="line">            <span class="keyword">return</span> referenceBean.get();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ReferencedBeanInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String referencedBeanName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Object bean;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">ReferencedBeanInvocationHandler</span><span class="params">(String referencedBeanName)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.referencedBeanName = referencedBeanName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">            Object result = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (bean == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    init();</span><br><span class="line">                &#125;</span><br><span class="line">                result = method.invoke(bean, args);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">                <span class="comment">// re-throws the actual Exception.</span></span><br><span class="line">                <span class="keyword">throw</span> e.getTargetException();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            ServiceBean serviceBean = applicationContext.getBean(referencedBeanName, ServiceBean.class);</span><br><span class="line">            <span class="keyword">this</span>.bean = serviceBean.getRef();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<br>

<p><font color='red'><b>这里说明下，因为@Reference生成的ReferenceBean对象，但是我们其实要调用的是一个代理对象，见下面，其实demoService和demoService1是一个对象，那我们要兼容@AutoWired对象，ReferenceBean这里其实采用的是FactoryBean，通过get就会获取代理对象</b></font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;demoServiceComponent&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoServiceComponent</span> <span class="keyword">implements</span> <span class="title">DemoService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Reference</span></span><br><span class="line">    <span class="keyword">private</span> DemoService demoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DemoService demoService1;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> demoService.sayHello(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CompletableFuture&lt;String&gt; <span class="title">sayHelloAsync</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h3><p>这个就是处理@Reference，生成ReferenceBean，生成代理对象。</p>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>dubbo和spring整合就写在这里，关于@Service服务导出，@Reference服务调用，后续还会有文章介绍</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/dubbo/" rel="tag"># dubbo</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/12/21/dubbo%E4%B9%8B%E5%8F%AF%E6%89%A9%E5%B1%95SPI%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" rel="prev" title="dubbo之可扩展SPI源码解析">
                  <i class="fa fa-chevron-left"></i> dubbo之可扩展SPI源码解析
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/01/18/dubbo%E4%B9%8B%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1%E8%AF%A6%E8%A7%A3/" rel="next" title="dubbo之导出服务详解">
                  dubbo之导出服务详解 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李俊龙</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
