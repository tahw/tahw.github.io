<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"theme-next.js.org","root":"/","images":"/images","scheme":"Gemini","version":"8.6.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="mysql之索引优化选择数据准备123456789101112131415161718192021222324-- auto-generated definitioncreate table person(    id          int auto_increment comment &amp;#x27;主键&amp;#x27;        primary key,    name        varc">
<meta property="og:type" content="article">
<meta property="og:title" content="mysql之索引优化选择">
<meta property="og:url" content="https://theme-next.js.org/2022/03/10/mysql%E4%B9%8B%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E9%80%89%E6%8B%A9/index.html">
<meta property="og:site_name" content="天真有邪">
<meta property="og:description" content="mysql之索引优化选择数据准备123456789101112131415161718192021222324-- auto-generated definitioncreate table person(    id          int auto_increment comment &amp;#x27;主键&amp;#x27;        primary key,    name        varc">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-10.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-11.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-1.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-2.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-3.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-4.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-5.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-6.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-7.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-8.png">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-9.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-11-1.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-12.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-13.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-14.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-14.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-15.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-16.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-17.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-18.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-19.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-20.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-21.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-22.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-23.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-26.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-24.png">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-27.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-25.png">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-28.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-28.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-28.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-28.jpg">
<meta property="og:image" content="https://theme-next.js.org/images/mysql-4-29.jpg">
<meta property="article:published_time" content="2022-03-10T02:13:21.000Z">
<meta property="article:modified_time" content="2022-04-07T13:13:57.200Z">
<meta property="article:author" content="李俊龙">
<meta property="article:tag" content="mysql">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://theme-next.js.org/images/mysql-4-10.jpg">


<link rel="canonical" href="https://theme-next.js.org/2022/03/10/mysql%E4%B9%8B%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E9%80%89%E6%8B%A9/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://theme-next.js.org/2022/03/10/mysql%E4%B9%8B%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E9%80%89%E6%8B%A9/","path":"2022/03/10/mysql之索引优化选择/","title":"mysql之索引优化选择"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>mysql之索引优化选择 | 天真有邪</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">天真有邪</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-summaries"><a href="/summaries/" rel="section"><i class="fa fa-calendar fa-fw"></i>总结</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#mysql%E4%B9%8B%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E9%80%89%E6%8B%A9"><span class="nav-number">1.</span> <span class="nav-text">mysql之索引优化选择</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87"><span class="nav-number">1.1.</span> <span class="nav-text">数据准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E8%AE%A1%E7%AE%97%E8%8A%B1%E9%94%80trace%E5%B7%A5%E5%85%B7"><span class="nav-number">1.2.</span> <span class="nav-text">索引计算花销trace工具</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E9%80%89%E6%8B%A9"><span class="nav-number">1.3.</span> <span class="nav-text">索引选择</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.3.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gt-lt-%E8%8C%83%E5%9B%B4%E6%9F%A5%E6%89%BE"><span class="nav-number">1.3.2.</span> <span class="nav-text">&gt; &lt;范围查找</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%BA%E5%88%B6%E7%B4%A2%E5%BC%95"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">强制索引</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#in%E3%80%81or-%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.3.3.</span> <span class="nav-text">in、or 查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#like-%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.3.4.</span> <span class="nav-text">like 查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E4%B8%8B%E6%8E%A8"><span class="nav-number">1.3.4.1.</span> <span class="nav-text">索引下推</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E7%BB%93%E5%90%88order-by%E6%8E%92%E5%BA%8F%E4%BD%BF%E7%94%A8"><span class="nav-number">1.3.5.</span> <span class="nav-text">查询结合order by排序使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#sort-buffer"><span class="nav-number">1.3.5.1.</span> <span class="nav-text">sort buffer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%8B%E5%AD%901"><span class="nav-number">1.3.5.2.</span> <span class="nav-text">例子1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%8B%E5%AD%902"><span class="nav-number">1.3.5.3.</span> <span class="nav-text">例子2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%8B%E5%AD%903"><span class="nav-number">1.3.5.4.</span> <span class="nav-text">例子3</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Using-filesort"><span class="nav-number">1.3.5.5.</span> <span class="nav-text">Using filesort</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8D%95%E8%B7%AF%E6%8E%92%E5%BA%8F"><span class="nav-number">1.3.5.5.1.</span> <span class="nav-text">单路排序</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A4%9A%E8%B7%AF%E6%8E%92%E5%BA%8F"><span class="nav-number">1.3.5.5.2.</span> <span class="nav-text">多路排序</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8D%95%E8%B7%AF%E6%8E%92%E5%BA%8F%E5%92%8C%E5%A4%9A%E8%B7%AF%E6%8E%92%E5%BA%8F%E5%AF%B9%E6%AF%94"><span class="nav-number">1.3.5.5.3.</span> <span class="nav-text">单路排序和多路排序对比</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#limit%E5%88%86%E9%A1%B5"><span class="nav-number">1.3.6.</span> <span class="nav-text">limit分页</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BB%E9%94%AE%E5%88%86%E9%A1%B5"><span class="nav-number">1.3.6.1.</span> <span class="nav-text">主键分页</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9D%9E%E4%B8%BB%E9%94%AE%E5%88%86%E9%A1%B5"><span class="nav-number">1.3.6.2.</span> <span class="nav-text">非主键分页</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#join%E5%85%B3%E8%81%94"><span class="nav-number">1.3.7.</span> <span class="nav-text">join关联</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#join-buffer"><span class="nav-number">1.3.7.1.</span> <span class="nav-text">join buffer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A9%B1%E5%8A%A8%E8%A1%A8%E5%92%8C%E8%A2%AB%E9%A9%B1%E5%8A%A8%E8%A1%A8"><span class="nav-number">1.3.7.2.</span> <span class="nav-text">驱动表和被驱动表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Nested-Loop-Join%E7%AE%97%E6%B3%95%EF%BC%88%E5%B5%8C%E5%A5%97%E5%BE%AA%E7%8E%AF%E7%AE%97%E6%B3%95NLJ%EF%BC%89"><span class="nav-number">1.3.7.3.</span> <span class="nav-text">Nested-Loop Join算法（嵌套循环算法NLJ）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Block-Nested-Loop-Join%E7%AE%97%E6%B3%95%EF%BC%88%E5%9F%BA%E4%BA%8E%E5%9D%97%E7%9A%84%E5%B5%8C%E5%A5%97%E5%BE%AA%E7%8E%AF%E7%AE%97%E6%B3%95BNL%EF%BC%89"><span class="nav-number">1.3.7.4.</span> <span class="nav-text">Block Nested-Loop Join算法（基于块的嵌套循环算法BNL）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NLJ-%E5%92%8C-BNL-%E5%AF%B9%E6%AF%94"><span class="nav-number">1.3.7.5.</span> <span class="nav-text">NLJ 和 BNL 对比</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E6%9E%9CBNL%E7%AE%97%E6%B3%95%E9%87%87%E7%94%A8NLJ%E7%AE%97%E6%B3%95%E5%85%B3%E8%81%94%E6%95%88%E7%8E%87"><span class="nav-number">1.3.7.6.</span> <span class="nav-text">如果BNL算法采用NLJ算法关联效率</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%BC%8F"><span class="nav-number">1.3.7.7.</span> <span class="nav-text">优化方式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#in%E3%80%81exist"><span class="nav-number">1.3.8.</span> <span class="nav-text">in、exist</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#count"><span class="nav-number">1.3.9.</span> <span class="nav-text">count(*)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E8%A7%84%E5%88%99"><span class="nav-number">1.4.</span> <span class="nav-text">设计规则</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">李俊龙</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">33</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://theme-next.js.org/2022/03/10/mysql%E4%B9%8B%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E9%80%89%E6%8B%A9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李俊龙">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天真有邪">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          mysql之索引优化选择
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-03-10 10:13:21" itemprop="dateCreated datePublished" datetime="2022-03-10T10:13:21+08:00">2022-03-10</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-04-07 21:13:57" itemprop="dateModified" datetime="2022-04-07T21:13:57+08:00">2022-04-07</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="mysql之索引优化选择"><a href="#mysql之索引优化选择" class="headerlink" title="mysql之索引优化选择"></a>mysql之索引优化选择</h1><h2 id="数据准备"><a href="#数据准备" class="headerlink" title="数据准备"></a>数据准备</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- auto-generated definition</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> person</span><br><span class="line">(</span><br><span class="line">    id          <span class="type">int</span> auto_increment comment <span class="string">&#x27;主键&#x27;</span></span><br><span class="line">        <span class="keyword">primary</span> <span class="keyword">key</span>,</span><br><span class="line">    name        <span class="type">varchar</span>(<span class="number">40</span>)                        <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">    age         <span class="type">int</span>                                <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;年纪&#x27;</span>,</span><br><span class="line">    province    <span class="type">varchar</span>(<span class="number">20</span>)                        <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;省份&#x27;</span>,</span><br><span class="line">    gender      <span class="type">int</span>                                <span class="keyword">null</span> comment <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">    card        <span class="type">varchar</span>(<span class="number">40</span>)                        <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;身份证号&#x27;</span>,</span><br><span class="line">    create_time datetime <span class="keyword">default</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    update_time datetime                           <span class="keyword">null</span> comment <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">    <span class="keyword">constraint</span> unique_index_card</span><br><span class="line">        <span class="keyword">unique</span> (card)</span><br><span class="line">)</span><br><span class="line">    charset <span class="operator">=</span> utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> index index_age</span><br><span class="line">    <span class="keyword">on</span> person (age);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> index index_name_province_gender</span><br><span class="line">    <span class="keyword">on</span> person (name, province, gender);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>通过存储过程的方式来生成测试数据，随便添加测试数据，尽可能让测试数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">procedure</span> insert_emp;</span><br><span class="line">delimiter ;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> insert_emp()</span><br><span class="line"> <span class="keyword">begin</span></span><br><span class="line">     <span class="keyword">declare</span> i <span class="type">int</span>;</span><br><span class="line">     <span class="keyword">set</span> i<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">     while(i<span class="operator">&lt;=</span><span class="number">10000</span>) do</span><br><span class="line">         <span class="keyword">insert</span> <span class="keyword">into</span> person(name,age,province,gender,card) <span class="keyword">values</span>(CONCAT(<span class="string">&#x27;吴九&#x27;</span>,i),i,<span class="string">&#x27;广东省&#x27;</span>,<span class="number">0</span>,UUID());</span><br><span class="line">         <span class="keyword">set</span> i<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span>;</span><br><span class="line">         <span class="keyword">end</span> while ;</span><br><span class="line"> <span class="keyword">end</span> ;</span><br><span class="line">delimiter ;</span><br><span class="line"><span class="keyword">call</span> insert_emp();</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="索引计算花销trace工具"><a href="#索引计算花销trace工具" class="headerlink" title="索引计算花销trace工具"></a>索引计算花销trace工具</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person <span class="keyword">where</span> name <span class="keyword">like</span> <span class="string">&#x27;李四%&#x27;</span> <span class="keyword">and</span> province <span class="operator">=</span> <span class="string">&#x27;河北省&#x27;</span> <span class="keyword">and</span> gender <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person <span class="keyword">where</span> name <span class="keyword">like</span> <span class="string">&#x27;张三%&#x27;</span> <span class="keyword">and</span> province <span class="operator">=</span> <span class="string">&#x27;广东省&#x27;</span> <span class="keyword">and</span> gender <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>同样的一张表，查询方式都是一样，只是查询的值不一样，选择的索引却是不一致的。对于这种情况，其实我们需要分析下索引选择</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查看mysql trace配置</span><br><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%optimizer_trace%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-10.jpg" alt="执行结果" loading="lazy"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 执行下面的<span class="keyword">sql</span>，开启trace</span><br><span class="line"><span class="keyword">SET</span> session OPTIMIZER_TRACE<span class="operator">=</span>&quot;enabled=on&quot;;</span><br><span class="line"><span class="keyword">SET</span> session optimizer_trace_limit<span class="operator">=</span><span class="number">5</span>;</span><br><span class="line"><span class="keyword">set</span> session optimizer_trace_offset<span class="operator">=</span><span class="number">5</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person <span class="keyword">where</span> name <span class="keyword">like</span> <span class="string">&#x27;李四%&#x27;</span> <span class="keyword">and</span> province <span class="operator">=</span> <span class="string">&#x27;河北省&#x27;</span> <span class="keyword">and</span> gender <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.OPTIMIZER_TRACE;</span><br><span class="line"># 恢复默认值</span><br><span class="line"><span class="keyword">SET</span> session OPTIMIZER_TRACE<span class="operator">=</span>&quot;enabled=off&quot;;</span><br><span class="line"><span class="keyword">SET</span> session optimizer_trace_limit<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">set</span> session optimizer_trace_offset<span class="operator">=</span><span class="number">-1</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-11.jpg" alt="执行结果" loading="lazy"><br>看到结果后，我们直接看TRACE字段</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;steps&quot;</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;join_preparation&quot;:&#123; # 第一阶段：sql准备阶段，格式化sql</span><br><span class="line">                &quot;select#&quot;:1,</span><br><span class="line">                &quot;steps&quot;:[</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;expanded_query&quot;</span>:<span class="string">&quot;/* select#1 */ select `person`.`id` AS `id`,`person`.`name` AS `name`,`person`.`age` AS `age`,`person`.`province` AS `province`,`person`.`gender` AS `gender`,`person`.`card` AS `card`,`person`.`create_time` AS `create_time`,`person`.`update_time` AS `update_time` from `person` where ((`person`.`name` like &#x27;李四%&#x27;) and (`person`.`province` = &#x27;河北省&#x27;) and (`person`.`gender` = 0))&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;join_optimization&quot;:&#123; # 第二阶段：sql优化阶段</span><br><span class="line">                &quot;select#&quot;:1,</span><br><span class="line">                &quot;steps&quot;:[</span><br><span class="line">                    &#123;</span><br><span class="line">                        &quot;condition_processing&quot;:&#123; # 条件处理</span><br><span class="line">                            &quot;condition&quot;:&quot;WHERE&quot;,</span><br><span class="line">                            &quot;original_condition&quot;:&quot;((`person`.`name` like &#x27;李四%&#x27;) and (`person`.`province` = &#x27;河北省&#x27;) and (`person`.`gender` = 0))&quot;,</span><br><span class="line">                            &quot;steps&quot;:[</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="attr">&quot;transformation&quot;</span>:<span class="string">&quot;equality_propagation&quot;</span>,</span><br><span class="line">                                    <span class="attr">&quot;resulting_condition&quot;</span>:<span class="string">&quot;((`person`.`name` like &#x27;李四%&#x27;) and (`person`.`province` = &#x27;河北省&#x27;) and multiple equal(0, `person`.`gender`))&quot;</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="attr">&quot;transformation&quot;</span>:<span class="string">&quot;constant_propagation&quot;</span>,</span><br><span class="line">                                    <span class="attr">&quot;resulting_condition&quot;</span>:<span class="string">&quot;((`person`.`name` like &#x27;李四%&#x27;) and (`person`.`province` = &#x27;河北省&#x27;) and multiple equal(0, `person`.`gender`))&quot;</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="attr">&quot;transformation&quot;</span>:<span class="string">&quot;trivial_condition_removal&quot;</span>,</span><br><span class="line">                                    <span class="attr">&quot;resulting_condition&quot;</span>:<span class="string">&quot;((`person`.`name` like &#x27;李四%&#x27;) and (`person`.`province` = &#x27;河北省&#x27;) and multiple equal(0, `person`.`gender`))&quot;</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            ]</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;substitute_generated_columns&quot;</span>:&#123;</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;table_dependencies&quot;</span>:[ # 表依赖结构</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">&quot;table&quot;</span>:<span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                                <span class="attr">&quot;row_may_be_null&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">                                <span class="attr">&quot;map_bit&quot;</span>:<span class="number">0</span>,</span><br><span class="line">                                <span class="attr">&quot;depends_on_map_bits&quot;</span>:[</span><br><span class="line"></span><br><span class="line">                                ]</span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;ref_optimizer_key_uses&quot;</span>:[</span><br><span class="line"></span><br><span class="line">                        ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;rows_estimation&quot;</span>:[ # 行估计</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">&quot;table&quot;</span>:<span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                                <span class="attr">&quot;range_analysis&quot;</span>:&#123;</span><br><span class="line">                                    &quot;table_scan&quot;:&#123; # 表扫描情况</span><br><span class="line">                                        &quot;rows&quot;:1043609, # 扫描行数</span><br><span class="line">                                        &quot;cost&quot;:214907 # 花费成本</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    &quot;potential_range_indexes&quot;:[ # 可能使用的索引</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            &quot;index&quot;:&quot;PRIMARY&quot;, # 主键索引</span><br><span class="line">                                            &quot;usable&quot;:false,</span><br><span class="line">                                            &quot;cause&quot;:&quot;not_applicable&quot;</span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            &quot;index&quot;:&quot;unique_index_card&quot;, # 唯一索引</span><br><span class="line">                                            &quot;usable&quot;:false,</span><br><span class="line">                                            &quot;cause&quot;:&quot;not_applicable&quot;</span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            <span class="attr">&quot;index&quot;</span>:<span class="string">&quot;index_name_province_gender&quot;</span>,</span><br><span class="line">                                            &quot;usable&quot;:true, # 使用</span><br><span class="line">                                            &quot;key_parts&quot;:[</span><br><span class="line">                                                &quot;name&quot;,</span><br><span class="line">                                                &quot;province&quot;,</span><br><span class="line">                                                &quot;gender&quot;,</span><br><span class="line">                                                <span class="string">&quot;id&quot;</span></span><br><span class="line">                                            ]</span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            <span class="attr">&quot;index&quot;</span>:<span class="string">&quot;index_age&quot;</span>,</span><br><span class="line">                                            <span class="attr">&quot;usable&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">                                            <span class="attr">&quot;cause&quot;</span>:<span class="string">&quot;not_applicable&quot;</span></span><br><span class="line">                                        &#125;</span><br><span class="line">                                    ],</span><br><span class="line">                                    &quot;setup_range_conditions&quot;:[</span><br><span class="line"></span><br><span class="line">                                    ],</span><br><span class="line">                                    &quot;group_index_range&quot;:&#123;</span><br><span class="line">                                        &quot;chosen&quot;:false,</span><br><span class="line">                                        &quot;cause&quot;:&quot;not_group_by_or_distinct&quot;</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    &quot;analyzing_range_alternatives&quot;:&#123; # 分析各个索引使用成本</span><br><span class="line">                                        &quot;range_scan_alternatives&quot;:[</span><br><span class="line">                                            &#123;</span><br><span class="line">                                                <span class="attr">&quot;index&quot;</span>:<span class="string">&quot;index_name_province_gender&quot;</span>,</span><br><span class="line">                                                <span class="attr">&quot;ranges&quot;</span>:[</span><br><span class="line">                                                    <span class="string">&quot;李四\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000 &lt;= name &lt;= 李四￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿&quot;</span></span><br><span class="line">                                                ],</span><br><span class="line">                                                <span class="attr">&quot;index_dives_for_eq_ranges&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">                                                &quot;rowid_ordered&quot;:false, # 使用该索引获取的记录是否按照主键排序</span><br><span class="line">                                                &quot;using_mrr&quot;:false,</span><br><span class="line">                                                &quot;index_only&quot;:false, # 是否使用覆盖索引</span><br><span class="line">                                                &quot;rows&quot;:94112, # 扫描行数</span><br><span class="line">                                                &quot;cost&quot;:112935, # 索引使用成本</span><br><span class="line">                                                &quot;chosen&quot;:true # 是否选择该索引</span><br><span class="line">                                            &#125;</span><br><span class="line">                                        ],</span><br><span class="line">                                        &quot;analyzing_roworder_intersect&quot;:&#123;</span><br><span class="line">                                            &quot;usable&quot;:false,</span><br><span class="line">                                            &quot;cause&quot;:&quot;too_few_roworder_scans&quot;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    &quot;chosen_range_access_summary&quot;:&#123; </span><br><span class="line">                                        &quot;range_access_plan&quot;:&#123;</span><br><span class="line">                                            &quot;type&quot;:&quot;range_scan&quot;,</span><br><span class="line">                                            &quot;index&quot;:&quot;index_name_province_gender&quot;,</span><br><span class="line">                                            &quot;rows&quot;:94112,</span><br><span class="line">                                            &quot;ranges&quot;:[</span><br><span class="line">                                                <span class="string">&quot;李四\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000 &lt;= name &lt;= 李四￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿&quot;</span></span><br><span class="line">                                            ]</span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        &quot;rows_for_plan&quot;:94112,</span><br><span class="line">                                        &quot;cost_for_plan&quot;:112935,</span><br><span class="line">                                        &quot;chosen&quot;:true</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;considered_execution_plans&quot;</span>:[ # 执行计划</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">&quot;plan_prefix&quot;</span>:[</span><br><span class="line"></span><br><span class="line">                                ],</span><br><span class="line">                                <span class="attr">&quot;table&quot;</span>:<span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                                &quot;best_access_path&quot;:&#123; # 最优访问路径</span><br><span class="line">                                    &quot;considered_access_paths&quot;:[ # 最终确定的访问路径</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            <span class="attr">&quot;rows_to_scan&quot;</span>:<span class="number">94112</span>,</span><br><span class="line">                                            &quot;access_type&quot;:&quot;range&quot;, # 访问类型，range，范围查询</span><br><span class="line">                                            &quot;range_details&quot;:&#123;</span><br><span class="line">                                                &quot;used_index&quot;:&quot;index_name_province_gender&quot; # 使用索引</span><br><span class="line">                                            &#125;,</span><br><span class="line">                                            &quot;resulting_rows&quot;:941.12,</span><br><span class="line">                                            &quot;cost&quot;:131758,</span><br><span class="line">                                            &quot;chosen&quot;:true # 确定选择</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    ]</span><br><span class="line">                                &#125;,</span><br><span class="line">                                &quot;condition_filtering_pct&quot;:100,</span><br><span class="line">                                &quot;rows_for_plan&quot;:941.12,</span><br><span class="line">                                &quot;cost_for_plan&quot;:131758,</span><br><span class="line">                                &quot;chosen&quot;:true</span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;attaching_conditions_to_tables&quot;</span>:&#123;</span><br><span class="line">                            <span class="attr">&quot;original_condition&quot;</span>:<span class="string">&quot;((`person`.`gender` = 0) and (`person`.`name` like &#x27;李四%&#x27;) and (`person`.`province` = &#x27;河北省&#x27;))&quot;</span>,</span><br><span class="line">                            <span class="attr">&quot;attached_conditions_computation&quot;</span>:[</span><br><span class="line"></span><br><span class="line">                            ],</span><br><span class="line">                            <span class="attr">&quot;attached_conditions_summary&quot;</span>:[</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="attr">&quot;table&quot;</span>:<span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                                    <span class="attr">&quot;attached&quot;</span>:<span class="string">&quot;((`person`.`gender` = 0) and (`person`.`name` like &#x27;李四%&#x27;) and (`person`.`province` = &#x27;河北省&#x27;))&quot;</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            ]</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;refine_plan&quot;</span>:[</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">&quot;table&quot;</span>:<span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                                <span class="attr">&quot;pushed_index_condition&quot;</span>:<span class="string">&quot;((`person`.`gender` = 0) and (`person`.`name` like &#x27;李四%&#x27;) and (`person`.`province` = &#x27;河北省&#x27;))&quot;</span>,</span><br><span class="line">                                <span class="attr">&quot;table_condition_attached&quot;</span>:<span class="literal">null</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;join_explain&quot;:&#123; # 执行阶段</span><br><span class="line">                &quot;select#&quot;:1,</span><br><span class="line">                &quot;steps&quot;:[</span><br><span class="line"></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 执行下面的<span class="keyword">sql</span>，开启trace</span><br><span class="line"><span class="keyword">SET</span> session OPTIMIZER_TRACE<span class="operator">=</span>&quot;enabled=on&quot;;</span><br><span class="line"><span class="keyword">SET</span> session optimizer_trace_limit<span class="operator">=</span><span class="number">5</span>;</span><br><span class="line"><span class="keyword">set</span> session optimizer_trace_offset<span class="operator">=</span><span class="number">5</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person <span class="keyword">where</span> name <span class="keyword">like</span> <span class="string">&#x27;张三%&#x27;</span> <span class="keyword">and</span> province <span class="operator">=</span> <span class="string">&#x27;广东省&#x27;</span> <span class="keyword">and</span> gender <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.OPTIMIZER_TRACE;</span><br><span class="line"># 恢复默认值</span><br><span class="line"><span class="keyword">SET</span> session OPTIMIZER_TRACE<span class="operator">=</span>&quot;enabled=off&quot;;</span><br><span class="line"><span class="keyword">SET</span> session optimizer_trace_limit<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">set</span> session optimizer_trace_offset<span class="operator">=</span><span class="number">-1</span>;</span><br></pre></td></tr></table></figure>
<p>看到结果后，我们直接看TRACE字段</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;steps&quot;</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;join_preparation&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;select#&quot;</span>:<span class="number">1</span>,</span><br><span class="line">                <span class="attr">&quot;steps&quot;</span>:[</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;expanded_query&quot;</span>:<span class="string">&quot;/* select#1 */ select `person`.`id` AS `id`,`person`.`name` AS `name`,`person`.`age` AS `age`,`person`.`province` AS `province`,`person`.`gender` AS `gender`,`person`.`card` AS `card`,`person`.`create_time` AS `create_time`,`person`.`update_time` AS `update_time` from `person` where ((`person`.`name` like &#x27;张三%&#x27;) and (`person`.`province` = &#x27;广东省&#x27;) and (`person`.`gender` = 1))&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;join_optimization&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;select#&quot;</span>:<span class="number">1</span>,</span><br><span class="line">                <span class="attr">&quot;steps&quot;</span>:[</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;condition_processing&quot;</span>:&#123;</span><br><span class="line">                            <span class="attr">&quot;condition&quot;</span>:<span class="string">&quot;WHERE&quot;</span>,</span><br><span class="line">                            <span class="attr">&quot;original_condition&quot;</span>:<span class="string">&quot;((`person`.`name` like &#x27;张三%&#x27;) and (`person`.`province` = &#x27;广东省&#x27;) and (`person`.`gender` = 1))&quot;</span>,</span><br><span class="line">                            <span class="attr">&quot;steps&quot;</span>:[</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="attr">&quot;transformation&quot;</span>:<span class="string">&quot;equality_propagation&quot;</span>,</span><br><span class="line">                                    <span class="attr">&quot;resulting_condition&quot;</span>:<span class="string">&quot;((`person`.`name` like &#x27;张三%&#x27;) and (`person`.`province` = &#x27;广东省&#x27;) and multiple equal(1, `person`.`gender`))&quot;</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="attr">&quot;transformation&quot;</span>:<span class="string">&quot;constant_propagation&quot;</span>,</span><br><span class="line">                                    <span class="attr">&quot;resulting_condition&quot;</span>:<span class="string">&quot;((`person`.`name` like &#x27;张三%&#x27;) and (`person`.`province` = &#x27;广东省&#x27;) and multiple equal(1, `person`.`gender`))&quot;</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="attr">&quot;transformation&quot;</span>:<span class="string">&quot;trivial_condition_removal&quot;</span>,</span><br><span class="line">                                    <span class="attr">&quot;resulting_condition&quot;</span>:<span class="string">&quot;((`person`.`name` like &#x27;张三%&#x27;) and (`person`.`province` = &#x27;广东省&#x27;) and multiple equal(1, `person`.`gender`))&quot;</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            ]</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;substitute_generated_columns&quot;</span>:&#123;</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;table_dependencies&quot;</span>:[</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">&quot;table&quot;</span>:<span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                                <span class="attr">&quot;row_may_be_null&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">                                <span class="attr">&quot;map_bit&quot;</span>:<span class="number">0</span>,</span><br><span class="line">                                <span class="attr">&quot;depends_on_map_bits&quot;</span>:[</span><br><span class="line"></span><br><span class="line">                                ]</span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;ref_optimizer_key_uses&quot;</span>:[</span><br><span class="line"></span><br><span class="line">                        ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;rows_estimation&quot;</span>:[</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">&quot;table&quot;</span>:<span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                                <span class="attr">&quot;range_analysis&quot;</span>:&#123;</span><br><span class="line">                                    <span class="attr">&quot;table_scan&quot;</span>:&#123;</span><br><span class="line">                                        <span class="attr">&quot;rows&quot;</span>:<span class="number">1043609</span>,</span><br><span class="line">                                        <span class="attr">&quot;cost&quot;</span>:<span class="number">214907</span></span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    <span class="attr">&quot;potential_range_indexes&quot;</span>:[</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            <span class="attr">&quot;index&quot;</span>:<span class="string">&quot;PRIMARY&quot;</span>,</span><br><span class="line">                                            <span class="attr">&quot;usable&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">                                            <span class="attr">&quot;cause&quot;</span>:<span class="string">&quot;not_applicable&quot;</span></span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            <span class="attr">&quot;index&quot;</span>:<span class="string">&quot;unique_index_card&quot;</span>,</span><br><span class="line">                                            <span class="attr">&quot;usable&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">                                            <span class="attr">&quot;cause&quot;</span>:<span class="string">&quot;not_applicable&quot;</span></span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            <span class="attr">&quot;index&quot;</span>:<span class="string">&quot;index_name_province_gender&quot;</span>,</span><br><span class="line">                                            <span class="attr">&quot;usable&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">                                            <span class="attr">&quot;key_parts&quot;</span>:[</span><br><span class="line">                                                <span class="string">&quot;name&quot;</span>,</span><br><span class="line">                                                <span class="string">&quot;province&quot;</span>,</span><br><span class="line">                                                <span class="string">&quot;gender&quot;</span>,</span><br><span class="line">                                                <span class="string">&quot;id&quot;</span></span><br><span class="line">                                            ]</span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            <span class="attr">&quot;index&quot;</span>:<span class="string">&quot;index_age&quot;</span>,</span><br><span class="line">                                            <span class="attr">&quot;usable&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">                                            <span class="attr">&quot;cause&quot;</span>:<span class="string">&quot;not_applicable&quot;</span></span><br><span class="line">                                        &#125;</span><br><span class="line">                                    ],</span><br><span class="line">                                    <span class="attr">&quot;setup_range_conditions&quot;</span>:[</span><br><span class="line"></span><br><span class="line">                                    ],</span><br><span class="line">                                    <span class="attr">&quot;group_index_range&quot;</span>:&#123;</span><br><span class="line">                                        <span class="attr">&quot;chosen&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">                                        <span class="attr">&quot;cause&quot;</span>:<span class="string">&quot;not_group_by_or_distinct&quot;</span></span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    <span class="attr">&quot;analyzing_range_alternatives&quot;</span>:&#123;</span><br><span class="line">                                        <span class="attr">&quot;range_scan_alternatives&quot;</span>:[</span><br><span class="line">                                            &#123;</span><br><span class="line">                                                <span class="attr">&quot;index&quot;</span>:<span class="string">&quot;index_name_province_gender&quot;</span>,</span><br><span class="line">                                                <span class="attr">&quot;ranges&quot;</span>:[</span><br><span class="line">                                                    <span class="string">&quot;张三\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000 &lt;= name &lt;= 张三￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿￿&quot;</span></span><br><span class="line">                                                ],</span><br><span class="line">                                                <span class="attr">&quot;index_dives_for_eq_ranges&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">                                                <span class="attr">&quot;rowid_ordered&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">                                                <span class="attr">&quot;using_mrr&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">                                                <span class="attr">&quot;index_only&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">                                                <span class="attr">&quot;rows&quot;</span>:<span class="number">521804</span>,</span><br><span class="line">                                                <span class="attr">&quot;cost&quot;</span>:<span class="number">626166</span>,</span><br><span class="line">                                                <span class="attr">&quot;chosen&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">                                                <span class="attr">&quot;cause&quot;</span>:<span class="string">&quot;cost&quot;</span></span><br><span class="line">                                            &#125;</span><br><span class="line">                                        ],</span><br><span class="line">                                        <span class="attr">&quot;analyzing_roworder_intersect&quot;</span>:&#123;</span><br><span class="line">                                            <span class="attr">&quot;usable&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">                                            <span class="attr">&quot;cause&quot;</span>:<span class="string">&quot;too_few_roworder_scans&quot;</span></span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;considered_execution_plans&quot;</span>:[ # 考虑执行计划</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">&quot;plan_prefix&quot;</span>:[</span><br><span class="line"></span><br><span class="line">                                ],</span><br><span class="line">                                <span class="attr">&quot;table&quot;</span>:<span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                                <span class="attr">&quot;best_access_path&quot;</span>:&#123;</span><br><span class="line">                                    <span class="attr">&quot;considered_access_paths&quot;</span>:[</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            <span class="attr">&quot;rows_to_scan&quot;</span>:<span class="number">1043609</span>,</span><br><span class="line">                                            &quot;access_type&quot;:&quot;scan&quot;, # 全表扫描</span><br><span class="line">                                            &quot;resulting_rows&quot;:5218,</span><br><span class="line">                                            &quot;cost&quot;:214905, # 这里的cont 214905花销比index_name_province_gender 626166少，直接使用全表扫描</span><br><span class="line">                                            &quot;chosen&quot;:true # 确定</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    ]</span><br><span class="line">                                &#125;,</span><br><span class="line">                                &quot;condition_filtering_pct&quot;:100,</span><br><span class="line">                                &quot;rows_for_plan&quot;:5218,</span><br><span class="line">                                &quot;cost_for_plan&quot;:214905,</span><br><span class="line">                                &quot;chosen&quot;:true</span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;attaching_conditions_to_tables&quot;</span>:&#123;</span><br><span class="line">                            <span class="attr">&quot;original_condition&quot;</span>:<span class="string">&quot;((`person`.`gender` = 1) and (`person`.`name` like &#x27;张三%&#x27;) and (`person`.`province` = &#x27;广东省&#x27;))&quot;</span>,</span><br><span class="line">                            <span class="attr">&quot;attached_conditions_computation&quot;</span>:[</span><br><span class="line"></span><br><span class="line">                            ],</span><br><span class="line">                            <span class="attr">&quot;attached_conditions_summary&quot;</span>:[</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="attr">&quot;table&quot;</span>:<span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                                    <span class="attr">&quot;attached&quot;</span>:<span class="string">&quot;((`person`.`gender` = 1) and (`person`.`name` like &#x27;张三%&#x27;) and (`person`.`province` = &#x27;广东省&#x27;))&quot;</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            ]</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;refine_plan&quot;</span>:[</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">&quot;table&quot;</span>:<span class="string">&quot;`person`&quot;</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;join_explain&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;select#&quot;</span>:<span class="number">1</span>,</span><br><span class="line">                <span class="attr">&quot;steps&quot;</span>:[</span><br><span class="line"></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>不同数据集导致的花销是不一样的，所选择的索引也是不同的。通过trace工具我们可以很好的分析使用索引的花销</p>
</blockquote>
<h2 id="索引选择"><a href="#索引选择" class="headerlink" title="索引选择"></a>索引选择</h2><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;张三1&#x27;</span> <span class="keyword">and</span> province <span class="operator">=</span> <span class="string">&#x27;广东省&#x27;</span> <span class="keyword">and</span> gender <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-1.jpg" alt="执行结果" loading="lazy"></p>
<p><font color='red'><b>很明显，这个sql使用了联合索引里面的三个字段，explain里面的ref也是const,const,const也能说明。那我们在优化sql的时候，索引长度也是能确定用到联合索引里面的哪些字段的。<br>name索引长度为122，使用name、province索引长度为184，使用name、province、gender索引长度为189</b></font></p>
<h3 id="gt-lt-范围查找"><a href="#gt-lt-范围查找" class="headerlink" title="&gt; &lt;范围查找"></a>&gt; &lt;范围查找</h3><p>范围查找使用联合索引第一个字段，是不会走索引的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person <span class="keyword">where</span> name <span class="operator">&gt;</span> <span class="string">&#x27;张&#x27;</span> <span class="keyword">and</span> province <span class="operator">=</span> <span class="string">&#x27;广东省&#x27;</span> <span class="keyword">and</span> gender <span class="operator">=</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-2.jpg" alt="执行结果" loading="lazy"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 采用覆盖索引的方式来使用索引</span><br><span class="line">explain <span class="keyword">select</span> name, province, gender <span class="keyword">from</span> person <span class="keyword">where</span> name <span class="operator">&gt;</span> <span class="string">&#x27;张&#x27;</span> <span class="keyword">and</span> province <span class="operator">=</span> <span class="string">&#x27;广东省&#x27;</span> <span class="keyword">and</span> gender <span class="operator">=</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-3.jpg" alt="执行结果" loading="lazy"></p>
<ol>
<li>我们使用的索引只有name字段，其他字段是没有使用到的，详细可以结合联合索引树来理解</li>
<li>对比上面两个结果，possible_keys是有值的。<font color='red'><b>但是第一个真正执行的时候是没有使用索引的，而第二个执行的时候是使用索引的。这是为什么？当联合索引的第一个字段采用范围查找的时候不会走索引，mysql内部会觉得第一个字段得到的结果集范围很大，回表效率不高，直接走聚簇索引。而第二个直接在二级索引就能得到结果，还是会走索引。其实第二个就是对第一个的优化，采用覆盖索引的方式</b></font></li>
</ol>
<h4 id="强制索引"><a href="#强制索引" class="headerlink" title="强制索引"></a>强制索引</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person force index(index_name_province_gender) <span class="keyword">where</span> name <span class="operator">&gt;</span> <span class="string">&#x27;张&#x27;</span> <span class="keyword">and</span> province <span class="operator">=</span> <span class="string">&#x27;广东省&#x27;</span> <span class="keyword">and</span> gender <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-4.jpg" alt="执行结果" loading="lazy"></p>
<blockquote>
<p>上面使用force index方式强制使用索引，但是注意使用强制索引不一定是优化，我们看下执行结果花费时间，见下图，基本上mysql选择索引内部已经非常精准了，基本上我们是不需要强制使用索引的</p>
</blockquote>
<p>为了对比结果更精准，需要关闭查询缓存query_cache</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 关闭query_cache</span><br><span class="line"><span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> query_cache_type  <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> query_cache_size  <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person <span class="keyword">where</span> name <span class="operator">&gt;</span> <span class="string">&#x27;张&#x27;</span> <span class="keyword">and</span> province <span class="operator">=</span> <span class="string">&#x27;广东省&#x27;</span> <span class="keyword">and</span> gender <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">[<span class="number">2022</span><span class="number">-03</span><span class="number">-13</span> <span class="number">12</span>:<span class="number">01</span>:<span class="number">48</span>] <span class="number">500</span> <span class="keyword">rows</span> retrieved starting <span class="keyword">from</span> <span class="number">1</span> <span class="keyword">in</span> <span class="number">83</span> ms (execution: <span class="number">14</span> ms, fetching: <span class="number">69</span> ms)</span><br><span class="line"></span><br><span class="line"># 关闭query_cache</span><br><span class="line"><span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> query_cache_type  <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> query_cache_size  <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person force index(index_name_province_gender) <span class="keyword">where</span> name <span class="operator">&gt;</span> <span class="string">&#x27;张&#x27;</span> <span class="keyword">and</span> province <span class="operator">=</span> <span class="string">&#x27;广东省&#x27;</span> <span class="keyword">and</span> gender <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">[<span class="number">2022</span><span class="number">-03</span><span class="number">-13</span> <span class="number">12</span>:<span class="number">01</span>:<span class="number">59</span>] <span class="number">500</span> <span class="keyword">rows</span> retrieved starting <span class="keyword">from</span> <span class="number">1</span> <span class="keyword">in</span> <span class="number">111</span> ms (execution: <span class="number">17</span> ms, fetching: <span class="number">94</span> ms)</span><br></pre></td></tr></table></figure>
<h3 id="in、or-查询"><a href="#in、or-查询" class="headerlink" title="in、or 查询"></a>in、or 查询</h3><p>in、or在表数据量大的情况下，使用索引，在数据量小的情况下，会走聚簇索引，不用回表，效率高。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 使用复合索引全量字段</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person <span class="keyword">where</span> name <span class="keyword">in</span> (<span class="string">&#x27;赵六&#x27;</span>,<span class="string">&#x27;张三265&#x27;</span>) <span class="keyword">and</span> province <span class="operator">=</span> <span class="string">&#x27;广东省&#x27;</span> <span class="keyword">and</span> gender <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-5.jpg" alt="执行结果" loading="lazy"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># person_small是和person一样的结构，但是数据只有三条</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person_small <span class="keyword">where</span> name <span class="keyword">in</span> (<span class="string">&#x27;赵六&#x27;</span>,<span class="string">&#x27;张三265&#x27;</span>) <span class="keyword">and</span> province <span class="operator">=</span> <span class="string">&#x27;广东省&#x27;</span> <span class="keyword">and</span> gender <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-6.jpg" alt="执行结果" loading="lazy"></p>
<h3 id="like-查询"><a href="#like-查询" class="headerlink" title="like 查询"></a>like 查询</h3><p>like查询，如果是后%的方式，一般都走索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person <span class="keyword">where</span> name <span class="keyword">like</span> <span class="string">&#x27;李四%&#x27;</span> <span class="keyword">and</span> province <span class="operator">=</span> <span class="string">&#x27;河北省&#x27;</span> <span class="keyword">and</span> gender <span class="operator">=</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-7.jpg" alt="执行结果" loading="lazy"><br>这里可以分析下，其中这个sql是会走索引的，<font color='red'><b>但是走的应该只有name索引，结合索引树，province和gender是没办法走索引的，但是我们发现结果是走了name、province、gender的。这是什么原因，其实这跟like里面索引下推有关系</b></font></p>
<h4 id="索引下推"><a href="#索引下推" class="headerlink" title="索引下推"></a>索引下推</h4><p>流程图<br><img src="/images/mysql-4-8.png" alt="索引下推" loading="lazy"><br><font color='red'><b>索引下推只在like查询的时候才会使用，其他都不会使用，准确来说，其实是对数据集小的来使用</b></font></p>
<ol>
<li>在mysql5.6之前，根据name直接查询二级索引树后得到主键id，然后拿到id后再去聚簇索引里面拿到对应结果，然后拿到province、gender字段结果比较，然后得到数据集。</li>
<li><font color='red'><b>在mysql5.6之后，根据name拿到结果后，正好二级索引树上面有其他字段，如果where条件里面有字段查询的，直接比较，然后拿到id，然后回表聚簇索引，这样回表的数据集肯定更加小的。效率更高。这个就是索引下推。</b></font></li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person <span class="keyword">where</span> name <span class="keyword">like</span> <span class="string">&#x27;张三%&#x27;</span> <span class="keyword">and</span> province <span class="operator">=</span> <span class="string">&#x27;广东省&#x27;</span> <span class="keyword">and</span> gender <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-9.jpg" alt="执行结果" loading="lazy"><br>这个直接就不走索引了，直接采用聚簇索引扫描，为什么？看下rows，量太大，更不会走索引下推。</p>
<blockquote>
<p>那这里会有疑问？范围查找&lt;、&gt;怎么不使用索引下推？这个就跟数据集有关系，我们一般认为范围查找是数据结果集大，like查询数据集小才会使用索引下推。like数据集大也不会走索引下推。</p>
</blockquote>
<h3 id="查询结合order-by排序使用"><a href="#查询结合order-by排序使用" class="headerlink" title="查询结合order by排序使用"></a>查询结合order by排序使用</h3><p>索引的选择先是查询，然后再根据order by选择索引</p>
<h4 id="sort-buffer"><a href="#sort-buffer" class="headerlink" title="sort buffer"></a>sort buffer</h4><p>提起order by，一定会有sort buffer，这个是把对应数据拿过来后在这里进行排序，这个大小只有1KB</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%innodb_sort_buffer_size%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-11-1.jpg" alt="执行结果" loading="lazy"></p>
<h4 id="例子1"><a href="#例子1" class="headerlink" title="例子1"></a>例子1</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span> <span class="keyword">and</span> gender <span class="operator">=</span> <span class="number">1</span> <span class="keyword">order</span> <span class="keyword">by</span> province;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-12.jpg" alt="执行结果" loading="lazy"><br>根据上面的结果，使用的name索引，由于最左匹配原则，gender是没有使用的。排序的时候由于Extra是Using index condition。这里最终使用索引是name、province</p>
<h4 id="例子2"><a href="#例子2" class="headerlink" title="例子2"></a>例子2</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> province,gender;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-13.jpg" alt="执行结果" loading="lazy"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> gender,province;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-14.jpg" alt="执行结果" loading="lazy"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> province <span class="keyword">asc</span>,gender <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-14.jpg" alt="执行结果" loading="lazy"></p>
<blockquote>
<p>都使用了name索引，但是下面的Extra是Using filesort，没有使用其他索引，在排序的时候也是有顺序的</p>
</blockquote>
<h4 id="例子3"><a href="#例子3" class="headerlink" title="例子3"></a>例子3</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person <span class="keyword">where</span> name <span class="operator">&gt;</span> <span class="string">&#x27;张三&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> name;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-15.jpg" alt="执行结果" loading="lazy"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> name,province,gender <span class="keyword">from</span> person <span class="keyword">where</span> name <span class="operator">&gt;</span> <span class="string">&#x27;张三&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> name;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-16.jpg" alt="执行结果" loading="lazy"></p>
<blockquote>
<p>数据量太大，没有使用name索引，采用覆盖索引的方式来优化</p>
</blockquote>
<h4 id="Using-filesort"><a href="#Using-filesort" class="headerlink" title="Using filesort"></a>Using filesort</h4><p><font color='red'><b>文件排序里面分为单路排序和多路排序，其中是通过系统变量<code>max_length_for_sort_data</code>(1024字节)来决定的。当需要查询的字段总长度小于<code>max_length_for_sort_data</code>就是用单路排序，否则使用多路排序</b></font></p>
<h5 id="单路排序"><a href="#单路排序" class="headerlink" title="单路排序"></a>单路排序</h5><p><font color='red'><b>一次性取出满足行的所有字段，然后再sort buffer里面排序。在trace里面表现的是filesort_summary下面有个sort_mode。<br>表现方式是：&lt;sort_key, additional_fields&gt; 或者 &lt;sort_key, packed_additional_fields&gt;</b></font></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># mysql 查看trace值</span><br><span class="line"><span class="keyword">SET</span> session OPTIMIZER_TRACE<span class="operator">=</span>&quot;enabled=on&quot;,end_markers_in_json<span class="operator">=</span><span class="keyword">on</span>;;</span><br><span class="line"><span class="keyword">SET</span> session optimizer_trace_limit<span class="operator">=</span><span class="number">5</span>;</span><br><span class="line"><span class="keyword">set</span> session optimizer_trace_offset<span class="operator">=</span><span class="number">5</span>;</span><br><span class="line"># 这里不能加explain</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> gender;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> INFORMATION_SCHEMA.OPTIMIZER_TRACE limit <span class="number">30</span> ;</span><br><span class="line"><span class="keyword">SET</span> session OPTIMIZER_TRACE<span class="operator">=</span>&quot;enabled=off&quot;,end_markers_in_json<span class="operator">=</span>off;</span><br><span class="line"><span class="keyword">SET</span> session optimizer_trace_limit<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">set</span> session optimizer_trace_offset<span class="operator">=</span><span class="number">-1</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;join_preparation&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;select#&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;expanded_query&quot;</span>: <span class="string">&quot;/* select#1 */ select `person`.`id` AS `id`,`person`.`name` AS `name`,`person`.`age` AS `age`,`person`.`province` AS `province`,`person`.`gender` AS `gender`,`person`.`card` AS `card`,`person`.`create_time` AS `create_time`,`person`.`update_time` AS `update_time` from `person` where (`person`.`name` = &#x27;张三&#x27;) order by `person`.`gender`&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        ] <span class="comment">/* steps */</span></span><br><span class="line">      &#125; <span class="comment">/* join_preparation */</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;join_optimization&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;select#&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;condition_processing&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;condition&quot;</span>: <span class="string">&quot;WHERE&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;original_condition&quot;</span>: <span class="string">&quot;(`person`.`name` = &#x27;张三&#x27;)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;transformation&quot;</span>: <span class="string">&quot;equality_propagation&quot;</span>,</span><br><span class="line">                  <span class="attr">&quot;resulting_condition&quot;</span>: <span class="string">&quot;(`person`.`name` = &#x27;张三&#x27;)&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;transformation&quot;</span>: <span class="string">&quot;constant_propagation&quot;</span>,</span><br><span class="line">                  <span class="attr">&quot;resulting_condition&quot;</span>: <span class="string">&quot;(`person`.`name` = &#x27;张三&#x27;)&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;transformation&quot;</span>: <span class="string">&quot;trivial_condition_removal&quot;</span>,</span><br><span class="line">                  <span class="attr">&quot;resulting_condition&quot;</span>: <span class="string">&quot;(`person`.`name` = &#x27;张三&#x27;)&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">              ] <span class="comment">/* steps */</span></span><br><span class="line">            &#125; <span class="comment">/* condition_processing */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;substitute_generated_columns&quot;</span>: &#123;</span><br><span class="line">            &#125; <span class="comment">/* substitute_generated_columns */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;table_dependencies&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;row_may_be_null&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">&quot;map_bit&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">&quot;depends_on_map_bits&quot;</span>: [</span><br><span class="line">                ] <span class="comment">/* depends_on_map_bits */</span></span><br><span class="line">              &#125;</span><br><span class="line">            ] <span class="comment">/* table_dependencies */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;ref_optimizer_key_uses&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;name&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;equals&quot;</span>: <span class="string">&quot;&#x27;张三&#x27;&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;null_rejecting&quot;</span>: <span class="literal">false</span></span><br><span class="line">              &#125;</span><br><span class="line">            ] <span class="comment">/* ref_optimizer_key_uses */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;rows_estimation&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;range_analysis&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;table_scan&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;rows&quot;</span>: <span class="number">1043609</span>,</span><br><span class="line">                    <span class="attr">&quot;cost&quot;</span>: <span class="number">214907</span></span><br><span class="line">                  &#125; <span class="comment">/* table_scan */</span>,</span><br><span class="line">                  <span class="attr">&quot;potential_range_indexes&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;PRIMARY&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;usable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                      <span class="attr">&quot;cause&quot;</span>: <span class="string">&quot;not_applicable&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;unique_index_card&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;usable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                      <span class="attr">&quot;cause&quot;</span>: <span class="string">&quot;not_applicable&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;index_name_province_gender&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;usable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                      <span class="attr">&quot;key_parts&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;name&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;province&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;gender&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;id&quot;</span></span><br><span class="line">                      ] <span class="comment">/* key_parts */</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;index_age&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;usable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                      <span class="attr">&quot;cause&quot;</span>: <span class="string">&quot;not_applicable&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  ] <span class="comment">/* potential_range_indexes */</span>,</span><br><span class="line">                  <span class="attr">&quot;setup_range_conditions&quot;</span>: [</span><br><span class="line">                  ] <span class="comment">/* setup_range_conditions */</span>,</span><br><span class="line">                  <span class="attr">&quot;group_index_range&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;chosen&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                    <span class="attr">&quot;cause&quot;</span>: <span class="string">&quot;not_group_by_or_distinct&quot;</span></span><br><span class="line">                  &#125; <span class="comment">/* group_index_range */</span>,</span><br><span class="line">                  <span class="attr">&quot;analyzing_range_alternatives&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;range_scan_alternatives&quot;</span>: [</span><br><span class="line">                      &#123;</span><br><span class="line">                        <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;index_name_province_gender&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;ranges&quot;</span>: [</span><br><span class="line">                          <span class="string">&quot;张三 &lt;= name &lt;= 张三&quot;</span></span><br><span class="line">                        ] <span class="comment">/* ranges */</span>,</span><br><span class="line">                        <span class="attr">&quot;index_dives_for_eq_ranges&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                        <span class="attr">&quot;rowid_ordered&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                        <span class="attr">&quot;using_mrr&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                        <span class="attr">&quot;index_only&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                        <span class="attr">&quot;rows&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                        <span class="attr">&quot;cost&quot;</span>: <span class="number">2.21</span>,</span><br><span class="line">                        <span class="attr">&quot;chosen&quot;</span>: <span class="literal">true</span></span><br><span class="line">                      &#125;</span><br><span class="line">                    ] <span class="comment">/* range_scan_alternatives */</span>,</span><br><span class="line">                    <span class="attr">&quot;analyzing_roworder_intersect&quot;</span>: &#123;</span><br><span class="line">                      <span class="attr">&quot;usable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                      <span class="attr">&quot;cause&quot;</span>: <span class="string">&quot;too_few_roworder_scans&quot;</span></span><br><span class="line">                    &#125; <span class="comment">/* analyzing_roworder_intersect */</span></span><br><span class="line">                  &#125; <span class="comment">/* analyzing_range_alternatives */</span>,</span><br><span class="line">                  <span class="attr">&quot;chosen_range_access_summary&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;range_access_plan&quot;</span>: &#123;</span><br><span class="line">                      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;range_scan&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;index_name_province_gender&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;rows&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                      <span class="attr">&quot;ranges&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;张三 &lt;= name &lt;= 张三&quot;</span></span><br><span class="line">                      ] <span class="comment">/* ranges */</span></span><br><span class="line">                    &#125; <span class="comment">/* range_access_plan */</span>,</span><br><span class="line">                    <span class="attr">&quot;rows_for_plan&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                    <span class="attr">&quot;cost_for_plan&quot;</span>: <span class="number">2.21</span>,</span><br><span class="line">                    <span class="attr">&quot;chosen&quot;</span>: <span class="literal">true</span></span><br><span class="line">                  &#125; <span class="comment">/* chosen_range_access_summary */</span></span><br><span class="line">                &#125; <span class="comment">/* range_analysis */</span></span><br><span class="line">              &#125;</span><br><span class="line">            ] <span class="comment">/* rows_estimation */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;considered_execution_plans&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;plan_prefix&quot;</span>: [</span><br><span class="line">                ] <span class="comment">/* plan_prefix */</span>,</span><br><span class="line">                <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;best_access_path&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;considered_access_paths&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="attr">&quot;access_type&quot;</span>: <span class="string">&quot;ref&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;index_name_province_gender&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;rows&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                      <span class="attr">&quot;cost&quot;</span>: <span class="number">1.2</span>,</span><br><span class="line">                      <span class="attr">&quot;chosen&quot;</span>: <span class="literal">true</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="attr">&quot;access_type&quot;</span>: <span class="string">&quot;range&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;range_details&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;used_index&quot;</span>: <span class="string">&quot;index_name_province_gender&quot;</span></span><br><span class="line">                      &#125; <span class="comment">/* range_details */</span>,</span><br><span class="line">                      <span class="attr">&quot;chosen&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                      <span class="attr">&quot;cause&quot;</span>: <span class="string">&quot;heuristic_index_cheaper&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  ] <span class="comment">/* considered_access_paths */</span></span><br><span class="line">                &#125; <span class="comment">/* best_access_path */</span>,</span><br><span class="line">                <span class="attr">&quot;condition_filtering_pct&quot;</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">&quot;rows_for_plan&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="attr">&quot;cost_for_plan&quot;</span>: <span class="number">1.2</span>,</span><br><span class="line">                <span class="attr">&quot;chosen&quot;</span>: <span class="literal">true</span></span><br><span class="line">              &#125;</span><br><span class="line">            ] <span class="comment">/* considered_execution_plans */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;attaching_conditions_to_tables&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;original_condition&quot;</span>: <span class="string">&quot;(`person`.`name` = &#x27;张三&#x27;)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;attached_conditions_computation&quot;</span>: [</span><br><span class="line">              ] <span class="comment">/* attached_conditions_computation */</span>,</span><br><span class="line">              <span class="attr">&quot;attached_conditions_summary&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                  <span class="attr">&quot;attached&quot;</span>: <span class="literal">null</span></span><br><span class="line">                &#125;</span><br><span class="line">              ] <span class="comment">/* attached_conditions_summary */</span></span><br><span class="line">            &#125; <span class="comment">/* attaching_conditions_to_tables */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;clause_processing&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;clause&quot;</span>: <span class="string">&quot;ORDER BY&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;original_clause&quot;</span>: <span class="string">&quot;`person`.`gender`&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;items&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;item&quot;</span>: <span class="string">&quot;`person`.`gender`&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">              ] <span class="comment">/* items */</span>,</span><br><span class="line">              <span class="attr">&quot;resulting_clause_is_simple&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">&quot;resulting_clause&quot;</span>: <span class="string">&quot;`person`.`gender`&quot;</span></span><br><span class="line">            &#125; <span class="comment">/* clause_processing */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;added_back_ref_condition&quot;</span>: <span class="string">&quot;((`person`.`name` &lt;=&gt; &#x27;张三&#x27;))&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;reconsidering_access_paths_for_index_ordering&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;clause&quot;</span>: <span class="string">&quot;ORDER BY&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">              ] <span class="comment">/* steps */</span>,</span><br><span class="line">              <span class="attr">&quot;index_order_summary&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;index_provides_order&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">&quot;order_direction&quot;</span>: <span class="string">&quot;undefined&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;index_name_province_gender&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;plan_changed&quot;</span>: <span class="literal">false</span></span><br><span class="line">              &#125; <span class="comment">/* index_order_summary */</span></span><br><span class="line">            &#125; <span class="comment">/* reconsidering_access_paths_for_index_ordering */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;refine_plan&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;pushed_index_condition&quot;</span>: <span class="string">&quot;(`person`.`name` &lt;=&gt; &#x27;张三&#x27;)&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;table_condition_attached&quot;</span>: <span class="literal">null</span></span><br><span class="line">              &#125;</span><br><span class="line">            ] <span class="comment">/* refine_plan */</span></span><br><span class="line">          &#125;</span><br><span class="line">        ] <span class="comment">/* steps */</span></span><br><span class="line">      &#125; <span class="comment">/* join_optimization */</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;join_execution&quot;: &#123; # sql执行阶段</span><br><span class="line">        &quot;select#&quot;: 1,</span><br><span class="line">        &quot;steps&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;filesort_information&quot;</span>: [ # 文件排序信息</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;direction&quot;</span>: <span class="string">&quot;asc&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;gender&quot;</span></span><br><span class="line">              &#125;</span><br><span class="line">            ] <span class="comment">/* filesort_information */</span>,</span><br><span class="line">            <span class="attr">&quot;filesort_priority_queue_optimization&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;limit&quot;</span>: <span class="number">501</span>,</span><br><span class="line">              <span class="attr">&quot;rows_estimate&quot;</span>: <span class="number">4573370</span>,</span><br><span class="line">              <span class="attr">&quot;row_size&quot;</span>: <span class="number">331</span>,</span><br><span class="line">              <span class="attr">&quot;memory_available&quot;</span>: <span class="number">262144</span>,</span><br><span class="line">              <span class="attr">&quot;chosen&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125; <span class="comment">/* filesort_priority_queue_optimization */</span>,</span><br><span class="line">            <span class="attr">&quot;filesort_execution&quot;</span>: [</span><br><span class="line">            ] <span class="comment">/* filesort_execution */</span>,</span><br><span class="line">            &quot;filesort_summary&quot;: &#123; # 文件排序信息</span><br><span class="line">              &quot;rows&quot;: 1,            # 预计扫描行数</span><br><span class="line">              &quot;examined_rows&quot;: 1,   # 参与排序行</span><br><span class="line">              &quot;number_of_tmp_files&quot;: 0, # 使用临时文件个数，这个值为0代表全部使用sort_buffer排序，否则使用的是磁盘文件排序</span><br><span class="line">              &quot;sort_buffer_size&quot;: 170184, # 排序缓存大小，单位Byte</span><br><span class="line">              &quot;sort_mode&quot;: &quot;&lt;sort_key, additional_fields&gt;&quot; # 排序方式，单路排序</span><br><span class="line">            &#125; /* filesort_summary */</span><br><span class="line">          &#125;</span><br><span class="line">        ] /* steps */</span><br><span class="line">      &#125; /* join_execution */</span><br><span class="line">    &#125;</span><br><span class="line">  ] /* steps */</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="多路排序"><a href="#多路排序" class="headerlink" title="多路排序"></a>多路排序</h5><p><font color='red'><b>也叫做回表排序，首先根据查询条件取出排序字段和可以直接定位的行的主键id，然后再sort buffer里面排序，排序完后再次回表取出其他需要的字段<br>在trace里面表现的是filesort_summary下面有个sort_mode。<br>表现方式是： &lt;sort_key, rowid&gt;</b></font></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 调整sort buffer大小，可以直接使用双路排序</span><br><span class="line"><span class="keyword">set</span> max_length_for_sort_data <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"><span class="keyword">SET</span> session OPTIMIZER_TRACE<span class="operator">=</span>&quot;enabled=on&quot;,end_markers_in_json<span class="operator">=</span><span class="keyword">on</span>;;</span><br><span class="line"><span class="keyword">SET</span> session optimizer_trace_limit<span class="operator">=</span><span class="number">5</span>;</span><br><span class="line"><span class="keyword">set</span> session optimizer_trace_offset<span class="operator">=</span><span class="number">5</span>;</span><br><span class="line"># 这里不能加explain</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> gender;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> INFORMATION_SCHEMA.OPTIMIZER_TRACE limit <span class="number">30</span> ;</span><br><span class="line"><span class="keyword">SET</span> session OPTIMIZER_TRACE<span class="operator">=</span>&quot;enabled=off&quot;,end_markers_in_json<span class="operator">=</span>off;</span><br><span class="line"><span class="keyword">SET</span> session optimizer_trace_limit<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">set</span> session optimizer_trace_offset<span class="operator">=</span><span class="number">-1</span>;</span><br><span class="line"><span class="keyword">set</span> max_length_for_sort_data <span class="operator">=</span> <span class="number">1024</span></span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;join_preparation&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;select#&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;expanded_query&quot;</span>: <span class="string">&quot;/* select#1 */ select `person`.`id` AS `id`,`person`.`name` AS `name`,`person`.`age` AS `age`,`person`.`province` AS `province`,`person`.`gender` AS `gender`,`person`.`card` AS `card`,`person`.`create_time` AS `create_time`,`person`.`update_time` AS `update_time` from `person` where (`person`.`name` = &#x27;张三&#x27;) order by `person`.`gender`&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        ] <span class="comment">/* steps */</span></span><br><span class="line">      &#125; <span class="comment">/* join_preparation */</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;join_optimization&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;select#&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;condition_processing&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;condition&quot;</span>: <span class="string">&quot;WHERE&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;original_condition&quot;</span>: <span class="string">&quot;(`person`.`name` = &#x27;张三&#x27;)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;transformation&quot;</span>: <span class="string">&quot;equality_propagation&quot;</span>,</span><br><span class="line">                  <span class="attr">&quot;resulting_condition&quot;</span>: <span class="string">&quot;(`person`.`name` = &#x27;张三&#x27;)&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;transformation&quot;</span>: <span class="string">&quot;constant_propagation&quot;</span>,</span><br><span class="line">                  <span class="attr">&quot;resulting_condition&quot;</span>: <span class="string">&quot;(`person`.`name` = &#x27;张三&#x27;)&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;transformation&quot;</span>: <span class="string">&quot;trivial_condition_removal&quot;</span>,</span><br><span class="line">                  <span class="attr">&quot;resulting_condition&quot;</span>: <span class="string">&quot;(`person`.`name` = &#x27;张三&#x27;)&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">              ] <span class="comment">/* steps */</span></span><br><span class="line">            &#125; <span class="comment">/* condition_processing */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;substitute_generated_columns&quot;</span>: &#123;</span><br><span class="line">            &#125; <span class="comment">/* substitute_generated_columns */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;table_dependencies&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;row_may_be_null&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">&quot;map_bit&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">&quot;depends_on_map_bits&quot;</span>: [</span><br><span class="line">                ] <span class="comment">/* depends_on_map_bits */</span></span><br><span class="line">              &#125;</span><br><span class="line">            ] <span class="comment">/* table_dependencies */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;ref_optimizer_key_uses&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;name&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;equals&quot;</span>: <span class="string">&quot;&#x27;张三&#x27;&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;null_rejecting&quot;</span>: <span class="literal">false</span></span><br><span class="line">              &#125;</span><br><span class="line">            ] <span class="comment">/* ref_optimizer_key_uses */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;rows_estimation&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;range_analysis&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;table_scan&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;rows&quot;</span>: <span class="number">1043609</span>,</span><br><span class="line">                    <span class="attr">&quot;cost&quot;</span>: <span class="number">214907</span></span><br><span class="line">                  &#125; <span class="comment">/* table_scan */</span>,</span><br><span class="line">                  <span class="attr">&quot;potential_range_indexes&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;PRIMARY&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;usable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                      <span class="attr">&quot;cause&quot;</span>: <span class="string">&quot;not_applicable&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;unique_index_card&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;usable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                      <span class="attr">&quot;cause&quot;</span>: <span class="string">&quot;not_applicable&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;index_name_province_gender&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;usable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                      <span class="attr">&quot;key_parts&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;name&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;province&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;gender&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;id&quot;</span></span><br><span class="line">                      ] <span class="comment">/* key_parts */</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;index_age&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;usable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                      <span class="attr">&quot;cause&quot;</span>: <span class="string">&quot;not_applicable&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  ] <span class="comment">/* potential_range_indexes */</span>,</span><br><span class="line">                  <span class="attr">&quot;setup_range_conditions&quot;</span>: [</span><br><span class="line">                  ] <span class="comment">/* setup_range_conditions */</span>,</span><br><span class="line">                  <span class="attr">&quot;group_index_range&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;chosen&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                    <span class="attr">&quot;cause&quot;</span>: <span class="string">&quot;not_group_by_or_distinct&quot;</span></span><br><span class="line">                  &#125; <span class="comment">/* group_index_range */</span>,</span><br><span class="line">                  <span class="attr">&quot;analyzing_range_alternatives&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;range_scan_alternatives&quot;</span>: [</span><br><span class="line">                      &#123;</span><br><span class="line">                        <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;index_name_province_gender&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;ranges&quot;</span>: [</span><br><span class="line">                          <span class="string">&quot;张三 &lt;= name &lt;= 张三&quot;</span></span><br><span class="line">                        ] <span class="comment">/* ranges */</span>,</span><br><span class="line">                        <span class="attr">&quot;index_dives_for_eq_ranges&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                        <span class="attr">&quot;rowid_ordered&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                        <span class="attr">&quot;using_mrr&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                        <span class="attr">&quot;index_only&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                        <span class="attr">&quot;rows&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                        <span class="attr">&quot;cost&quot;</span>: <span class="number">2.21</span>,</span><br><span class="line">                        <span class="attr">&quot;chosen&quot;</span>: <span class="literal">true</span></span><br><span class="line">                      &#125;</span><br><span class="line">                    ] <span class="comment">/* range_scan_alternatives */</span>,</span><br><span class="line">                    <span class="attr">&quot;analyzing_roworder_intersect&quot;</span>: &#123;</span><br><span class="line">                      <span class="attr">&quot;usable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                      <span class="attr">&quot;cause&quot;</span>: <span class="string">&quot;too_few_roworder_scans&quot;</span></span><br><span class="line">                    &#125; <span class="comment">/* analyzing_roworder_intersect */</span></span><br><span class="line">                  &#125; <span class="comment">/* analyzing_range_alternatives */</span>,</span><br><span class="line">                  <span class="attr">&quot;chosen_range_access_summary&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;range_access_plan&quot;</span>: &#123;</span><br><span class="line">                      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;range_scan&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;index_name_province_gender&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;rows&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                      <span class="attr">&quot;ranges&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;张三 &lt;= name &lt;= 张三&quot;</span></span><br><span class="line">                      ] <span class="comment">/* ranges */</span></span><br><span class="line">                    &#125; <span class="comment">/* range_access_plan */</span>,</span><br><span class="line">                    <span class="attr">&quot;rows_for_plan&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                    <span class="attr">&quot;cost_for_plan&quot;</span>: <span class="number">2.21</span>,</span><br><span class="line">                    <span class="attr">&quot;chosen&quot;</span>: <span class="literal">true</span></span><br><span class="line">                  &#125; <span class="comment">/* chosen_range_access_summary */</span></span><br><span class="line">                &#125; <span class="comment">/* range_analysis */</span></span><br><span class="line">              &#125;</span><br><span class="line">            ] <span class="comment">/* rows_estimation */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;considered_execution_plans&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;plan_prefix&quot;</span>: [</span><br><span class="line">                ] <span class="comment">/* plan_prefix */</span>,</span><br><span class="line">                <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;best_access_path&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;considered_access_paths&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="attr">&quot;access_type&quot;</span>: <span class="string">&quot;ref&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;index_name_province_gender&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;rows&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                      <span class="attr">&quot;cost&quot;</span>: <span class="number">1.2</span>,</span><br><span class="line">                      <span class="attr">&quot;chosen&quot;</span>: <span class="literal">true</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="attr">&quot;access_type&quot;</span>: <span class="string">&quot;range&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;range_details&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;used_index&quot;</span>: <span class="string">&quot;index_name_province_gender&quot;</span></span><br><span class="line">                      &#125; <span class="comment">/* range_details */</span>,</span><br><span class="line">                      <span class="attr">&quot;chosen&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                      <span class="attr">&quot;cause&quot;</span>: <span class="string">&quot;heuristic_index_cheaper&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  ] <span class="comment">/* considered_access_paths */</span></span><br><span class="line">                &#125; <span class="comment">/* best_access_path */</span>,</span><br><span class="line">                <span class="attr">&quot;condition_filtering_pct&quot;</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">&quot;rows_for_plan&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="attr">&quot;cost_for_plan&quot;</span>: <span class="number">1.2</span>,</span><br><span class="line">                <span class="attr">&quot;chosen&quot;</span>: <span class="literal">true</span></span><br><span class="line">              &#125;</span><br><span class="line">            ] <span class="comment">/* considered_execution_plans */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;attaching_conditions_to_tables&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;original_condition&quot;</span>: <span class="string">&quot;(`person`.`name` = &#x27;张三&#x27;)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;attached_conditions_computation&quot;</span>: [</span><br><span class="line">              ] <span class="comment">/* attached_conditions_computation */</span>,</span><br><span class="line">              <span class="attr">&quot;attached_conditions_summary&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                  <span class="attr">&quot;attached&quot;</span>: <span class="literal">null</span></span><br><span class="line">                &#125;</span><br><span class="line">              ] <span class="comment">/* attached_conditions_summary */</span></span><br><span class="line">            &#125; <span class="comment">/* attaching_conditions_to_tables */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;clause_processing&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;clause&quot;</span>: <span class="string">&quot;ORDER BY&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;original_clause&quot;</span>: <span class="string">&quot;`person`.`gender`&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;items&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;item&quot;</span>: <span class="string">&quot;`person`.`gender`&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">              ] <span class="comment">/* items */</span>,</span><br><span class="line">              <span class="attr">&quot;resulting_clause_is_simple&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">&quot;resulting_clause&quot;</span>: <span class="string">&quot;`person`.`gender`&quot;</span></span><br><span class="line">            &#125; <span class="comment">/* clause_processing */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;added_back_ref_condition&quot;</span>: <span class="string">&quot;((`person`.`name` &lt;=&gt; &#x27;张三&#x27;))&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;reconsidering_access_paths_for_index_ordering&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;clause&quot;</span>: <span class="string">&quot;ORDER BY&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">              ] <span class="comment">/* steps */</span>,</span><br><span class="line">              <span class="attr">&quot;index_order_summary&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;index_provides_order&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">&quot;order_direction&quot;</span>: <span class="string">&quot;undefined&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;index_name_province_gender&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;plan_changed&quot;</span>: <span class="literal">false</span></span><br><span class="line">              &#125; <span class="comment">/* index_order_summary */</span></span><br><span class="line">            &#125; <span class="comment">/* reconsidering_access_paths_for_index_ordering */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;refine_plan&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;pushed_index_condition&quot;</span>: <span class="string">&quot;(`person`.`name` &lt;=&gt; &#x27;张三&#x27;)&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;table_condition_attached&quot;</span>: <span class="literal">null</span></span><br><span class="line">              &#125;</span><br><span class="line">            ] <span class="comment">/* refine_plan */</span></span><br><span class="line">          &#125;</span><br><span class="line">        ] <span class="comment">/* steps */</span></span><br><span class="line">      &#125; <span class="comment">/* join_optimization */</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;join_execution&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;select#&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;steps&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;filesort_information&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;direction&quot;</span>: <span class="string">&quot;asc&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;`person`&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;gender&quot;</span></span><br><span class="line">              &#125;</span><br><span class="line">            ] <span class="comment">/* filesort_information */</span>,</span><br><span class="line">            <span class="attr">&quot;filesort_priority_queue_optimization&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;limit&quot;</span>: <span class="number">501</span>,</span><br><span class="line">              <span class="attr">&quot;rows_estimate&quot;</span>: <span class="number">4573370</span>,</span><br><span class="line">              <span class="attr">&quot;row_size&quot;</span>: <span class="number">9</span>,</span><br><span class="line">              <span class="attr">&quot;memory_available&quot;</span>: <span class="number">262144</span>,</span><br><span class="line">              <span class="attr">&quot;chosen&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125; <span class="comment">/* filesort_priority_queue_optimization */</span>,</span><br><span class="line">            <span class="attr">&quot;filesort_execution&quot;</span>: [</span><br><span class="line">            ] <span class="comment">/* filesort_execution */</span>,</span><br><span class="line">            <span class="attr">&quot;filesort_summary&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;rows&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;examined_rows&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;number_of_tmp_files&quot;</span>: <span class="number">0</span>,</span><br><span class="line">              <span class="attr">&quot;sort_buffer_size&quot;</span>: <span class="number">8536</span>,</span><br><span class="line">              <span class="attr">&quot;sort_mode&quot;</span>: <span class="string">&quot;&lt;sort_key, rowid&gt;&quot;</span> # 双路排序</span><br><span class="line">            &#125; <span class="comment">/* filesort_summary */</span></span><br><span class="line">          &#125;</span><br><span class="line">        ] <span class="comment">/* steps */</span></span><br><span class="line">      &#125; <span class="comment">/* join_execution */</span></span><br><span class="line">    &#125;</span><br><span class="line">  ] <span class="comment">/* steps */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="单路排序和多路排序对比"><a href="#单路排序和多路排序对比" class="headerlink" title="单路排序和多路排序对比"></a>单路排序和多路排序对比</h5><table>
<thead>
<tr>
<th align="left">sql</th>
<th align="left">单路排序执行流程</th>
<th align="left">多路排序执行流程</th>
</tr>
</thead>
<tbody><tr>
<td align="left">select * from person where name = &#39;张三&#39; order by gender;</td>
<td align="left">1. 从索引name找到第一个name=&#39;张三&#39;条件的主键<br><font color='red'><b>2. 然后根据聚簇索引查找所有字段放入sort_buffer里面<b></font><br>3. 重复1.2操作，直到找不到name=&#39;张三&#39;<br>4. 对sort_buffer里面数据按照gender排序<br>5. 结果集返回客户端</td>
<td align="left">1. 从索引name找到第一个name=&#39;张三&#39;条件的主键<br><font color='red'><b>2. 然后根据聚簇索引后，拿出gender和主键id放入sort_buffer里面<b></font><br>3. 重复1.2操作，直到找不到name=&#39;张三&#39;<br>4. 对sort_buffer里面数据按照gender排序<br><font color='red'><b>5. 拿出排序好的id，然后回表聚簇索引，拿出所有的数据集返回客户端<b></font></td>
</tr>
</tbody></table>
<blockquote>
<p>如果sort buffer配置的比较小，那我们其实可以适当把<code>max_length_for_sort_data</code>大小调整小一点，尽量使用双路排序算法，sort buffer可以排序更多的行，只是在回表再查一下需要的字段，这样的效率会更高。反之也是这样。</p>
</blockquote>
<h3 id="limit分页"><a href="#limit分页" class="headerlink" title="limit分页"></a>limit分页</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person limit <span class="number">100000</span>,<span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p><font color='red'><b>查出的逻辑是：先从person取出100010行数据。然后抛去100000行数据，然后取出后面10行。如果表足够大，执行效率非常低。</b></font><br><img src="/images/mysql-4-17.jpg" alt="执行结果" loading="lazy"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id <span class="keyword">from</span> person limit <span class="number">100000</span>,<span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-18.jpg" alt="执行结果" loading="lazy"><br>看下结果，只是查询字段id，得到的结果却和上面不一致？为什么？<font color='red'><b>看下下面的执行计划，使用的索引，使用的索引是不一致的。上面是使用全表扫描，下面是使用age索引，最简单二级索引，二级索引里面是存在主键id字段。所以拿到的结果是不一致的。</b></font></p>
<table>
<thead>
<tr>
<th align="left">sql</th>
<th align="left">结果</th>
</tr>
</thead>
<tbody><tr>
<td align="left">explain select * from person limit 100000,10;</td>
<td align="left"><img src="/images/mysql-4-19.jpg" alt="执行结果" loading="lazy"></td>
</tr>
<tr>
<td align="left">explain select id from person limit 100000,10;</td>
<td align="left"><img src="/images/mysql-4-20.jpg" alt="执行结果" loading="lazy"></td>
</tr>
</tbody></table>
<h4 id="主键分页"><a href="#主键分页" class="headerlink" title="主键分页"></a>主键分页</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person limit <span class="number">100000</span>,<span class="number">10</span>;</span><br><span class="line"># <span class="operator">=</span><span class="operator">&gt;</span> 可以转换成下面这样</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">100000</span> limit <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p><font color='red'><b>主键排序虽然可以优化成这样，但是这种场景只使用主键自增场景，如果删除一条数据，就会导致结果不一致</b></font></p>
<h4 id="非主键分页"><a href="#非主键分页" class="headerlink" title="非主键分页"></a>非主键分页</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person <span class="keyword">order</span> <span class="keyword">by</span> name limit <span class="number">100000</span>,<span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-21.jpg" alt="执行结果" loading="lazy"><br>查询大概花费1s，使用filesort，没有使用索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person p <span class="keyword">inner</span> <span class="keyword">join</span> (<span class="keyword">select</span> id <span class="keyword">from</span> person <span class="keyword">order</span> <span class="keyword">by</span> name limit <span class="number">100000</span>,<span class="number">10</span>) b <span class="keyword">on</span> b.id <span class="operator">=</span> p.id;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-22.jpg" alt="执行结果" loading="lazy"><br>转换成使用覆盖索引，使用Using Index，然后primary，然后查询<derived2>全部，这里其实只有10条，是非常快的。看到的rows是其实是估算的，没有执行过估算数据。</p>
<h3 id="join关联"><a href="#join关联" class="headerlink" title="join关联"></a>join关联</h3><p>表关联常见有两种算法：Nested-Loop Join算法、Block Nested-Loop Join算法。那关联中一定会有join buffer的影响、驱动表的区分。</p>
<h4 id="join-buffer"><a href="#join-buffer" class="headerlink" title="join buffer"></a>join buffer</h4><p>提起join，一定会有join buffer，这个是把对应数据拿过来互相关联得到结果，这个大小只有256k</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%join_buffer_size%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-23.jpg" alt="执行结果" loading="lazy"></p>
<h4 id="驱动表和被驱动表"><a href="#驱动表和被驱动表" class="headerlink" title="驱动表和被驱动表"></a>驱动表和被驱动表</h4><p>这个会影响关联的效率和算法</p>
<ol>
<li>在两表关联的时候，优化器会将小表做驱动表，大表为被驱动表。</li>
<li>当使用left join时，左表是驱动表，右表是被驱动表</li>
<li>当使用right join时，右表是驱动表，左表是被驱动表</li>
<li>inner join时，排在前面的表不一定是驱动表，优化器会计算数量级小为驱动表</li>
<li>select * from a straight_join b on b.id  = a.id。<code>straight_join</code>强制让a做驱动表，<code>straight_join</code>只适应于inner join</li>
<li><font color='red'><b>优化器判断数量级的时候是增加where条件的，最终扫描的行数。</b></font></li>
<li>尽可能让优化器自己选择驱动表，大部分mysql自己优化是最优的</li>
</ol>
<h4 id="Nested-Loop-Join算法（嵌套循环算法NLJ）"><a href="#Nested-Loop-Join算法（嵌套循环算法NLJ）" class="headerlink" title="Nested-Loop Join算法（嵌套循环算法NLJ）"></a>Nested-Loop Join算法（嵌套循环算法NLJ）</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person_small <span class="keyword">inner</span> <span class="keyword">join</span> person p <span class="keyword">on</span> person_small.age <span class="operator">=</span> p.age;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-26.jpg" alt="执行结果" loading="lazy"></p>
<ol>
<li>通过age来关联，person_small全表扫描，因为只有3条数据，而person会走索引。驱动表是先执行的person_small，而被驱动表是person。</li>
<li>关联中Extra没有出现Using join buffer (Block Nested Loop)，则就是使用NLJ</li>
</ol>
<p><img src="/images/mysql-4-24.png" alt="NLJ流程图" loading="lazy"></p>
<h4 id="Block-Nested-Loop-Join算法（基于块的嵌套循环算法BNL）"><a href="#Block-Nested-Loop-Join算法（基于块的嵌套循环算法BNL）" class="headerlink" title="Block Nested-Loop Join算法（基于块的嵌套循环算法BNL）"></a>Block Nested-Loop Join算法（基于块的嵌套循环算法BNL）</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person_small <span class="keyword">inner</span> <span class="keyword">join</span> person p <span class="keyword">on</span> person_small.province <span class="operator">=</span> p.province;</span><br></pre></td></tr></table></figure>
<p><img src="/images/mysql-4-27.jpg" alt="执行结果" loading="lazy"></p>
<p><img src="/images/mysql-4-25.png" alt="BNL流程图" loading="lazy"></p>
<h4 id="NLJ-和-BNL-对比"><a href="#NLJ-和-BNL-对比" class="headerlink" title="NLJ 和 BNL 对比"></a>NLJ 和 BNL 对比</h4><p>person_small 是100行数据，person是10000行数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># NLJ</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person_small <span class="keyword">inner</span> <span class="keyword">join</span> person p <span class="keyword">on</span> person_small.age <span class="operator">=</span> p.age;</span><br><span class="line"># BNL</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person_small <span class="keyword">inner</span> <span class="keyword">join</span> person p <span class="keyword">on</span> person_small.province <span class="operator">=</span> p.province;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th align="left">指标</th>
<th align="left">NLJ</th>
<th align="left">BNL</th>
</tr>
</thead>
<tbody><tr>
<td align="left">执行过程</td>
<td align="left">1. 首先区分person_small为驱动表<br> 2. <font color='red'><b>然后从person_small（如果有where条件，是先会筛选的）里面读取一行数据到join buffer里面</b></font><br> 3. 取出age字段，然后到person里面查找<br> 4. 拿到匹配的行合并到数据集<br> 5. 重复2、3、4操作最终得到数据集返回客户端</td>
<td align="left">1.首先区分person_small为驱动表<br> 2. <font color='red'><b>然后从person_small所有的数据到join buffer里面（如果join buffer不够，则会分段放）</b></font><br> 3. 把person的每一行拿出来和join buffer里面的数据比较<br> 4. 拿出结果集返回给客户端</td>
</tr>
<tr>
<td align="left">扫描行数</td>
<td align="left"><font color='red'><b>person_small扫描了全表100行，person走的索引也是100行，总共200行</b></font></td>
<td align="left">1. <font color='red'><b>person_small扫描了全表100行，person没有走索引也是全表扫描10000行，总共10100行</b></font><br> 2. <font color='red'><b>如果join buffer不够的话，只能存50行person_small，比较完50行的person_small后就会清空join buffer，然后扫描接下来的50条，重新扫描person</b></font>，对应的会扫描100行的person_small+两次的person10000行，就是20100行</td>
</tr>
<tr>
<td align="left">判断次数</td>
<td align="left">一行一行比较就是100次</td>
<td align="left">100 * 10000次</td>
</tr>
</tbody></table>
<h4 id="如果BNL算法采用NLJ算法关联效率"><a href="#如果BNL算法采用NLJ算法关联效率" class="headerlink" title="如果BNL算法采用NLJ算法关联效率"></a>如果BNL算法采用NLJ算法关联效率</h4><p>拿person_small 是100行数据，person是10000行数据距离，扫描的行数会变成100 * 10000。这个扫描其实是磁盘的操作，肯定没有内存计算的100 * 10000快。</p>
<h4 id="优化方式"><a href="#优化方式" class="headerlink" title="优化方式"></a>优化方式</h4><ol>
<li>关联字段加索引，尽量使用NLJ算法</li>
<li>小表驱动大表</li>
</ol>
<h3 id="in、exist"><a href="#in、exist" class="headerlink" title="in、exist"></a>in、exist</h3><p>也是小表驱动大表</p>
<p>在person里面找出和person_small相同age的记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">in</span> 方式</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person <span class="keyword">where</span> age <span class="keyword">in</span> (<span class="keyword">select</span> age <span class="keyword">from</span> person_small);</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">exists</span> 方式</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person_small <span class="keyword">where</span> <span class="keyword">exists</span> (<span class="keyword">select</span> age <span class="keyword">from</span> person);</span><br></pre></td></tr></table></figure>
<h3 id="count"><a href="#count" class="headerlink" title="count(*)"></a>count(*)</h3><table>
<thead>
<tr>
<th align="left">sql</th>
<th align="left">直接结果</th>
</tr>
</thead>
<tbody><tr>
<td align="left">explain select count(*) from person;</td>
<td align="left"><img src="/images/mysql-4-28.jpg" alt="执行结果" loading="lazy"></td>
</tr>
<tr>
<td align="left">explain select count(1) from person;</td>
<td align="left"><img src="/images/mysql-4-28.jpg" alt="执行结果" loading="lazy"></td>
</tr>
<tr>
<td align="left">explain select count(age) from person;</td>
<td align="left"><img src="/images/mysql-4-28.jpg" alt="执行结果" loading="lazy"></td>
</tr>
<tr>
<td align="left">explain select count(id) from person;</td>
<td align="left"><img src="/images/mysql-4-28.jpg" alt="执行结果" loading="lazy"></td>
</tr>
<tr>
<td align="left">explain select count(create_time) from person;</td>
<td align="left"><img src="/images/mysql-4-29.jpg" alt="执行结果" loading="lazy"></td>
</tr>
</tbody></table>
<ol>
<li><font color='red'><b>除了最后一个没有走索引，其他都是走相同的索引，前面都是效率差不多的</b></font></li>
<li><font color='red'><b>只有根据某个字段count时，不会算null值的行，其他都算</b></font></li>
</ol>
<p>我们理解上面四个都是走一样的索引，效率其实是差不多的，但是如果非要比较的话，还是有点差别。比较后的性能其实是<br><font color='red'><b>count(*) ≈ count(1) &gt; count(二级索引字段) &gt; count(主键id) &gt; count(非二级索引字段)</b></font></p>
<ol>
<li>count(1)是不需要取出字段，直接用1来统计，扫描一行就直接内存+1</li>
<li><font color='red'><b>count(*)是比较例外的，mysql并不会把所有字段取出来，专门做了优化，不取字段值，直接累加</b></font></li>
<li>count(二级索引字段)是二级索引树，肯定比主键树轻量级，肯定count(二级索引字段) 比 count(主键id) 快，<font color='red'><b>这里虽然count(主键id)也是走的二级索引，但是主键id是叶子节点，而二级索引字段都不需要取节点值，直接节点字段。肯定也是快的。</b></font></li>
</ol>
<h2 id="设计规则"><a href="#设计规则" class="headerlink" title="设计规则"></a>设计规则</h2><ol>
<li>代码先行，索引后上</li>
<li>联合索引尽量覆盖索引<ol>
<li>create index(name,provice,gender,age)</li>
<li>select * from persion where name = &#39;张三&#39; and provice = &#39;湖北省&#39; and age &gt; 20 转换成下面 select * from persion where name = &#39;张三&#39; and provice = &#39;湖北省&#39; and age in (0,1) and age &gt; 20，即可都使用索引</li>
</ol>
</li>
<li>不要在小基数建立索引</li>
<li>长字符串可以采用前缀索引（index(name(20),province,gender)）</li>
<li>范围索引字段，尽量放在最后面 </li>
<li>where与order by冲突时，优先where</li>
<li>join使用索引关联，小表驱动大表</li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/mysql/" rel="tag"># mysql</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/03/04/mysql%E4%B9%8B%E4%B8%80%E4%B8%AAsql%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E7%9A%84/" rel="prev" title="mysql之一个sql是如何执行的">
                  <i class="fa fa-chevron-left"></i> mysql之一个sql是如何执行的
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/03/18/mysql%E4%B9%8B%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E5%92%8C%E9%94%81%E6%9C%BA%E5%88%B6/" rel="next" title="mysql之事务隔离级别和锁机制">
                  mysql之事务隔离级别和锁机制 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李俊龙</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
